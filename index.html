<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الجداول الرائع جداً (نسخة مطورة)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; scroll-behavior: smooth; }
        .schedule-item { padding: 4px; border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: all 0.2s; color: #1f2937; box-shadow: 0 2px 4px rgba(0,0,0,0.05); line-height: 1.3; position: relative; }
        .schedule-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .schedule-item[draggable="true"]:active { cursor: grabbing; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: scale(1.05); }
        .drop-target { display: flex; flex-direction: column; gap: 2px; min-height: 50px; border-radius: 6px; transition: background-color 0.2s; }
        .drag-over { background-color: #dcfce7; border: 2px dashed #4ade80; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 24px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
        .close-button { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
        .empty-slot { cursor: pointer; }
        .empty-slot:hover { background-color: #f0f9ff; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: transparent; width: 100%; height: 40px; border: 1px solid #ccc; border-radius: 0.375rem; cursor: pointer; padding: 2px; }
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: none; }
        input[type="color"]::-moz-color-swatch { border-radius: 4px; border: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .list-item { transition: all 0.4s ease-in-out; }
        .list-item.fade-out { opacity: 0; transform: scale(0.9); }
        .list-item.fade-in { animation: fadeIn 0.5s; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 2000; }
        .toast { padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: white; font-weight: 600; margin-bottom: 10px; animation: slideIn 0.5s, fadeOut 0.5s 2.5s; opacity: 0; animation-fill-mode: forwards; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }

        /* Button loading spinner */
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 16px; height: 16px; animation: spin 1s ease-in-out infinite; margin-left: 8px;}
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Cleaner lists */
        .list-item .control-buttons { opacity: 0; transition: opacity 0.2s; }
        .list-item:hover .control-buttons { opacity: 1; }

        @media print {
            body * { visibility: hidden; }
            #schedule-output-container, #schedule-output-container *, #custom-views-container, #custom-views-container * { visibility: visible; }
            #schedule-output-container, #custom-views-container { position: absolute; left: 0; top: 0; width: 100%; }
            .schedule-item { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            h2, h3 { text-align: center; margin-bottom: 20px; }
            #members-view-sidebar { display: none; }
            .conflict-badge, .control-buttons, .print-hidden, footer, #top-controls { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="toast-container"></div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">الجداول الرائع جداً</h1>
            <p class="text-gray-500 mt-2">مع الحفظ السحابي، الفرق الدراسية، التعديل اليداوي و الي مش يداوي، كشف التضارب و الخناقات، الخ...</p>
        </header>

        <div id="loading-indicator" class="text-center p-8"> <i class="fas fa-spinner fa-spin fa-3x text-sky-500"></i> <p class="mt-4 text-gray-600">جاري تحميل البيانات...</p> </div>

        <div id="main-content" class="hidden">
            <!-- New Top Controls Panel -->
            <div id="top-controls" class="bg-white p-4 rounded-xl shadow-md mb-8 print-hidden">
                <details class="group">
                    <summary class="flex justify-between items-center font-medium cursor-pointer">
                        <h2 class="text-xl font-bold text-gray-600">إدارة البيانات الأساسية والإعدادات</h2>
                        <span class="transition-transform duration-300 group-open:rotate-180">
                            <i class="fas fa-chevron-down"></i>
                        </span>
                    </summary>
                    <div class="text-neutral-600 mt-4 pt-4 border-t">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            
                            <div class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-600 flex justify-between items-center">
                                        <span>1. الفرق الدراسية</span>
                                        <a href="#" onclick="window.showAdvancedLevelsView()" class="text-gray-400 hover:text-sky-500"><i class="fas fa-cog"></i></a>
                                    </h3>
                                    <form id="level-form" class="flex gap-2 mt-2">
                                        <input type="text" id="level-name" placeholder="اسم الفرقة" class="w-full p-2 border rounded-md" required>
                                        <button type="submit" class="bg-green-500 text-white font-bold p-2 px-4 rounded-md hover:bg-green-600 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                                    </form>
                                    <div id="levels-list" class="mt-2 space-y-2 max-h-24 overflow-y-auto"></div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-600">2. المجموعات</h3>
                                    <form id="group-form" class="flex gap-2 mt-2">
                                        <input type="text" id="group-name" placeholder="اسم المجموعة" class="w-full p-2 border rounded-md" required>
                                        <button type="submit" class="bg-teal-500 text-white font-bold p-2 px-4 rounded-md hover:bg-teal-600 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                                    </form>
                                    <div id="groups-list" class="mt-2 space-y-2 max-h-24 overflow-y-auto"></div>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h3 class="text-lg font-bold text-gray-600">3. المواد الدراسية</h3>
                                <form id="subject-form" class="space-y-2 mt-2">
                                    <select id="subject-level-select" class="w-full p-2 border rounded-md" required><option value="">اختر الفرقة أولاً...</option></select>
                                    <div class="flex gap-2">
                                        <input type="text" id="subject-name" placeholder="اسم المادة" class="w-full p-2 border rounded-md" required>
                                        <button type="submit" class="bg-purple-500 text-white font-bold p-2 px-4 rounded-md hover:bg-purple-600 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                                    </div>
                                </form>
                                <div id="subjects-list" class="mt-2 space-y-2 max-h-48 overflow-y-auto"></div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg border">
                                 <h3 class="text-lg font-bold text-gray-600 flex justify-between items-center">
                                    <span>4. الأعضاء</span>
                                    <a href="#" onclick="window.showAdvancedInstructorsView()" class="text-gray-400 hover:text-sky-500"><i class="fas fa-cog"></i></a>
                                </h3>
                                <form id="instructor-form" class="space-y-2 mt-2">
                                    <input type="text" id="instructor-name-input" placeholder="اسم العضو" class="w-full p-2 border rounded-md" required>
                                    <select id="instructor-category-select" class="w-full p-2 border rounded-md">
                                        <option value="عضو هيئة تدريس">عضو هيئة تدريس</option> <option value="معاونون">معاونون</option> <option value="منتدبون">منتدبون</option> <option value="اعضاء من الخارج">اعضاء من الخارج</option>
                                    </select>
                                    <button type="submit" class="w-full bg-sky-500 text-white font-bold py-2 rounded-md hover:bg-sky-600 flex items-center justify-center">إضافة عضو</button>
                                </form>
                                <div id="instructors-list" class="mt-2 space-y-2 max-h-48 overflow-y-auto"></div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h3 class="text-lg font-bold text-gray-600">5. الأماكن</h3>
                                <form id="location-form" class="space-y-2 mt-2">
                                    <input type="text" id="location-name" placeholder="اسم المكان" class="w-full p-2 border rounded-md" required>
                                    <select id="location-type" class="w-full p-2 border rounded-md">
                                        <option value="قاعة">قاعة</option> <option value="معمل">معمل</option> <option value="مدرج">مدرج</option>
                                    </select>
                                    <button type="submit" class="w-full bg-cyan-500 text-white font-bold py-2 rounded-md hover:bg-cyan-600 flex items-center justify-center">إضافة المكان</button>
                                </form>
                                <div id="locations-list" class="mt-2 space-y-2 max-h-24 overflow-y-auto"></div>
                            </div>

                        </div>
                    </div>
                </details>
            </div>
            
            <div class="text-center my-8 flex flex-wrap justify-center items-center gap-4 print-hidden">
                <button id="generate-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-sync-alt mr-2"></i>تحديث الجدول</button>
                <button id="locations-view-btn" class="bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-800 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-university mr-2"></i>جداول الأماكن</button>
                <button id="filter-members-btn" class="bg-blue-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-users mr-2"></i>جداول الأعضاء</button>
                <button id="export-btn" class="bg-purple-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-file-export mr-2"></i>تصدير</button>
                <button id="load-btn" class="bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-file-import mr-2"></i>استيراد</button>
                <button id="print-btn" class="bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-print mr-2"></i>طباعة</button>
                <button id="reset-btn" class="bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-trash-alt mr-2"></i>جديد</button>
                <input type="file" id="file-loader" class="hidden" accept=".json">
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-md mb-8 flex items-center gap-4">
                <label for="level-filter-select" class="font-bold text-gray-600">عرض جدول:</label>
                <select id="level-filter-select" class="w-full p-2 border rounded-md text-xl font-bold"></select>
            </div>
            
            <div id="summary-table-container" class="my-6"></div>
            <div id="unscheduled-output" class="my-6"></div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-600">إضافة محاضرة / سكشن</h2>
                        <form id="course-form" class="space-y-4">
                            <select id="course-name-select" class="w-full p-2 border rounded-md" required><option value="">اختر الفرقة الرئيسية أولاً...</option></select>
                            <select id="instructor-select" class="w-full p-2 border rounded-md" required><option value="">اختر العضو...</option></select>
                            <select id="location-type-select" class="w-full p-2 border rounded-md" required><option value="">نوع المكان...</option><option value="قاعة">قاعة</option><option value="معمل">معمل</option><option value="مدرج">مدرج</option></select>
                            <select id="session-type" class="w-full p-2 border rounded-md"> <option value="lecture">محاضرة</option> <option value="lab">سكشن</option> </select>
                            <div id="group-select-container" class="hidden">
                                <select id="course-group-select" class="w-full p-2 border rounded-md"><option value="">اختر المجموعة...</option></select>
                            </div>
                            <input type="number" id="sections-count" placeholder="العدد" class="w-full p-2 border rounded-md" min="1" value="1" required>
                            <div>
                                <label for="duration" class="font-bold text-sm text-gray-600">المدة بالساعات</label>
                                <input type="number" id="duration" class="w-full p-2 border rounded-md" min="1" value="2" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center justify-center">إضافة للجدول</button>
                        </form>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 text-gray-600">قائمة المحاضرات والسكاشن</h2>
                        <div id="courses-list" class="space-y-2 max-h-[calc(100vh-400px)] overflow-y-auto"></div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div id="schedule-output-container" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg min-w-full overflow-x-auto h-full">
                        <div id="schedule-output"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Views -->
        <div id="advanced-levels-view" class="hidden"></div>
        <div id="advanced-instructors-view" class="hidden"></div>
    </div>
    
    <div id="custom-views-container" class="container mx-auto p-4 md:p-8">
        <button id="hide-custom-view-btn" class="hidden bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 mb-6 print-hidden">
            <i class="fas fa-eye-slash mr-2"></i>إخفاء الجداول الإضافية
        </button>
        <div id="custom-schedule-output" class="mt-8 space-y-12"></div>
    </div>

    <!-- Modals -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-modal-title" class="text-lg font-bold mb-4">تأكيد الإجراء</h3>
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">إلغاء</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">تأكيد</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="modal"> <div class="modal-content"> <span id="close-edit-modal-btn" class="close-button">&times;</span> <h3 id="edit-modal-title" class="text-lg font-bold mb-4"></h3> <div class="space-y-4"> <input type="text" id="edit-modal-input" class="w-full p-2 border rounded-md"> <button id="edit-modal-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ</button> </div> </div> </div>
    <div id="availability-modal" class="modal"> <div class="modal-content"> <span id="close-availability-modal-btn" class="close-button">&times;</span> <h3 id="availability-modal-title" class="text-lg font-bold mb-4"></h3> <p class="text-sm text-gray-500 mb-4">حدد الساعات المتاحة.</p> <div id="availability-grid" class="space-y-2"></div> <button id="availability-modal-save-btn" class="w-full mt-4 bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ</button> </div> </div>
    
    <div id="course-edit-modal" class="modal">
        <div class="modal-content">
            <span id="close-course-edit-modal-btn" class="close-button">&times;</span>
            <h3 id="course-edit-modal-title" class="text-lg font-bold mb-4">تعديل بيانات المقرر</h3>
            <div class="space-y-4">
                <div>
                    <label class="font-bold text-sm text-gray-600">اسم المقرر (المادة الأساسية)</label>
                    <input type="text" id="course-edit-subject-name-input" class="w-full p-2 border rounded-md">
                </div>
                <div id="course-edit-section-name-container" class="hidden">
                     <label class="font-bold text-sm text-gray-600">اسم السكشن المحدد</label>
                     <input type="text" id="course-edit-section-name-input" class="w-full p-2 border rounded-md">
                </div>
                <div>
                    <label class="font-bold text-sm text-gray-600">العضو</label>
                    <select id="course-edit-instructor-select" class="w-full p-2 border rounded-md"></select>
                </div>
                <div>
                    <label class="font-bold text-sm text-gray-600">المكان</label>
                    <select id="course-edit-location-select" class="w-full p-2 border rounded-md"></select>
                </div>
                 <div>
                    <label class="font-bold text-sm text-gray-600">اللون</label>
                    <input type="color" id="course-edit-color-input" class="w-full p-1 h-10 border rounded-md">
                </div>
                <button id="course-edit-modal-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ التعديلات</button>
                <button id="course-edit-modal-delete-btn" class="w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600 mt-2">حذف من الجدول</button>
            </div>
        </div>
    </div>

    <div id="custom-activity-modal" class="modal">
        <div class="modal-content">
            <span id="close-custom-activity-modal-btn" class="close-button">&times;</span>
            <h3 id="custom-activity-modal-title" class="text-lg font-bold mb-4">إضافة نشاط مخصص</h3>
            <div class="space-y-4">
                <div>
                    <label class="font-bold">النشاط:</label>
                    <input type="text" id="custom-activity-text" class="w-full p-2 border rounded-md" placeholder="مثال: إشراف ماجستير">
                </div>
                <div>
                    <label class="font-bold">المدة بالساعات:</label>
                    <input type="number" id="custom-activity-duration" class="w-full p-2 border rounded-md" min="1" value="1">
                </div>
                <button id="custom-activity-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ النشاط</button>
                <button id="custom-activity-delete-btn" class="w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600 mt-2 hidden">حذف النشاط</button>
            </div>
        </div>
    </div>
    
    <footer class="text-center p-4 mt-8 text-sm text-gray-500 border-t">
        <p>جميع الحقوق محفوظة لدى قسم تكنولوجيا التعليم</p>
        <p>أ.م.د/ نهى علي سيد عبد المحسن & أ/ طارق محمد مختار</p>
        <p>2025-2026</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, writeBatch, query, getDocs, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let subjects = [], instructors = [], locations = [], courses = [], levels = [], groups = [];
        let courseColors = {}, scheduleGrid = {};
        let savedSchedules = {};
        let activeCustomView = null;
        
        const DAYS = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
        const TIME_SLOTS_HOURLY = Array.from({ length: 10 }, (_, i) => i + 8); 
        const INSTRUCTOR_CATEGORIES = ['عضو هيئة تدريس', 'معاونون', 'منتدبون', 'اعضاء من الخارج'];
        const LOCATION_TYPES = { 'معمل': 'المعامل', 'قاعة': 'القاعات', 'مدرج': 'المدرجات' };
        
        const dom = {
            mainContent: document.getElementById('main-content'),
            advancedLevelsView: document.getElementById('advanced-levels-view'),
            advancedInstructorsView: document.getElementById('advanced-instructors-view'),
            customViewsContainer: document.getElementById('custom-views-container'),
            levelForm: document.getElementById('level-form'), levelsList: document.getElementById('levels-list'),
            groupForm: document.getElementById('group-form'), groupsList: document.getElementById('groups-list'),
            subjectLevelSelect: document.getElementById('subject-level-select'),
            levelFilterSelect: document.getElementById('level-filter-select'),
            subjectForm: document.getElementById('subject-form'), subjectsList: document.getElementById('subjects-list'),
            instructorForm: document.getElementById('instructor-form'), instructorsList: document.getElementById('instructors-list'),
            locationForm: document.getElementById('location-form'), locationsList: document.getElementById('locations-list'),
            courseForm: document.getElementById('course-form'), courseNameSelect: document.getElementById('course-name-select'),
            instructorSelect: document.getElementById('instructor-select'), coursesList: document.getElementById('courses-list'),
            sessionType: document.getElementById('session-type'), groupSelectContainer: document.getElementById('group-select-container'),
            courseGroupSelect: document.getElementById('course-group-select'),
            generateBtn: document.getElementById('generate-btn'), locationsViewBtn: document.getElementById('locations-view-btn'),
            filterMembersBtn: document.getElementById('filter-members-btn'), exportBtn: document.getElementById('export-btn'),
            loadBtn: document.getElementById('load-btn'), fileLoader: document.getElementById('file-loader'),
            resetBtn: document.getElementById('reset-btn'), printBtn: document.getElementById('print-btn'),
            scheduleOutput: document.getElementById('schedule-output'), customScheduleOutput: document.getElementById('custom-schedule-output'),
            hideCustomViewBtn: document.getElementById('hide-custom-view-btn'),
            unscheduledOutput: document.getElementById('unscheduled-output'), 
            summaryTableContainer: document.getElementById('summary-table-container'),
            editModal: document.getElementById('edit-modal'), closeEditModalBtn: document.getElementById('close-edit-modal-btn'),
            editModalTitle: document.getElementById('edit-modal-title'), editModalInput: document.getElementById('edit-modal-input'),
            editModalSaveBtn: document.getElementById('edit-modal-save-btn'), 
            availabilityModal: document.getElementById('availability-modal'), closeAvailabilityModalBtn: document.getElementById('close-availability-modal-btn'),
            availabilityModalTitle: document.getElementById('availability-modal-title'), availabilityGrid: document.getElementById('availability-grid'),
            availabilityModalSaveBtn: document.getElementById('availability-modal-save-btn'),
            courseEditModal: document.getElementById('course-edit-modal'),
            closeCourseEditModalBtn: document.getElementById('close-course-edit-modal-btn'),
            courseEditModalTitle: document.getElementById('course-edit-modal-title'),
            courseEditInstructorSelect: document.getElementById('course-edit-instructor-select'),
            courseEditModalSaveBtn: document.getElementById('course-edit-modal-save-btn'),
            courseEditModalDeleteBtn: document.getElementById('course-edit-modal-delete-btn'),
            customActivityModal: document.getElementById('custom-activity-modal'),
            closeCustomActivityModalBtn: document.getElementById('close-custom-activity-modal-btn'),
            customActivityModalTitle: document.getElementById('custom-activity-modal-title'),
            customActivityText: document.getElementById('custom-activity-text'),
            customActivityDuration: document.getElementById('custom-activity-duration'),
            customActivitySaveBtn: document.getElementById('custom-activity-save-btn'),
            customActivityDeleteBtn: document.getElementById('custom-activity-delete-btn'),
            loadingIndicator: document.getElementById('loading-indicator'),
            confirmModal: {
                modal: document.getElementById('confirm-modal'),
                title: document.getElementById('confirm-modal-title'),
                text: document.getElementById('confirm-modal-text'),
                confirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
            }
        };
        
        let db, auth, userId;
        let subjectsCol, instructorsCol, locationsCol, coursesCol, levelsCol, schedulesCol, groupsCol;
        let draggedItem = null;

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyANHjKyZJgEOAddxMSQR1JPjzXLWGqaNdM",
                  authDomain: "tabletech-ecaeb.firebaseapp.com",
                  projectId: "tabletech-ecaeb",
                  storageBucket: "tabletech-ecaeb.appspot.com",
                  messagingSenderId: "1025016928304",
                  appId: "1:1025016928304:web:fbc55b5060eb043cf435f5",
                  measurementId: "G-BG0TQQF429"
                };

                const appId = 'tabletech-app';
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        const basePath = `artifacts/${appId}/public/data`;
                        levelsCol = collection(db, basePath, 'levels');
                        groupsCol = collection(db, basePath, 'groups');
                        subjectsCol = collection(db, basePath, 'subjects');
                        instructorsCol = collection(db, basePath, 'instructors');
                        locationsCol = collection(db, basePath, 'locations');
                        coursesCol = collection(db, basePath, 'courses');
                        schedulesCol = collection(db, basePath, 'schedules');
                        setupRealtimeListeners();
                    } else {
                        signInAnonymously(auth).catch(error => {
                            console.error("Anonymous Sign-In Error:", error);
                            dom.loadingIndicator.innerHTML = '<p class="text-red-500">حدث خطأ أثناء الاتصال. يرجى تحديث الصفحة.</p>';
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                dom.loadingIndicator.innerHTML = '<p class="text-red-500">حدث خطأ فني أثناء تهيئة التطبيق.</p>';
            }
        }
        
        // --- UI & Interaction Helpers ---
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        function toggleButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalContent = button.innerHTML;
                button.innerHTML = `<span class="spinner"></span> <span>جاري...</span>`;
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalContent;
            }
        }

        function showConfirmModal(text, onConfirm) {
            dom.confirmModal.text.textContent = text;
            dom.confirmModal.modal.style.display = 'block';

            return new Promise((resolve) => {
                dom.confirmModal.confirmBtn.onclick = () => {
                    dom.confirmModal.modal.style.display = 'none';
                    onConfirm();
                    resolve(true);
                };
                dom.confirmModal.cancelBtn.onclick = () => {
                    dom.confirmModal.modal.style.display = 'none';
                    resolve(false);
                };
            });
        }
        
        async function handleAddWithLoading(e, collectionRef, data, successMessage) {
            e.preventDefault();
            const form = e.target.closest('form');
            const button = form.querySelector('button[type="submit"]');
            const input = form.querySelector('input');
            toggleButtonLoading(button, true);
            try {
                await addDoc(collectionRef, data);
                showToast(successMessage);
                if(input) input.value = '';
            } catch (error) {
                console.error("Error adding document:", error);
                showToast("حدث خطأ أثناء الحفظ", "error");
            } finally {
                toggleButtonLoading(button, false);
            }
        }

        async function handleAddLevel(e) { const name = e.target.closest('form').querySelector('input').value.trim(); if (name && !levels.some(l => l.name === name)) { handleAddWithLoading(e, levelsCol, { name }, "تمت إضافة الفرقة بنجاح!"); } }
        async function handleAddGroup(e) { const name = e.target.closest('form').querySelector('input').value.trim(); if (name && !groups.some(g => g.name === name)) { handleAddWithLoading(e, groupsCol, { name }, "تمت إضافة المجموعة بنجاح!"); } }
        
        // --- Render Functions (with animation classes) ---
        function renderLevels() { dom.levelsList.innerHTML = levels.map(l => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md" data-id="${l.id}"><p class="font-semibold text-sm">${l.name}</p>${createControlButtons('level', l.id)}</div>`).join(''); }
        function renderGroups() { dom.groupsList.innerHTML = groups.map(g => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md" data-id="${g.id}"><p class="font-semibold text-sm">${g.name}</p>${createControlButtons('group', g.id)}</div>`).join(''); }
        
        // --- Updated Delete Function ---
        window.deleteItem = async (type, id) => {
            const itemMap = { level: levels, group: groups, subject: subjects, instructor: instructors, location: locations, course: courses };
            const itemToDelete = itemMap[type].find(i => i.id === id);
            
            if (type === 'level' && subjects.some(s => s.academicLevel === itemToDelete.name)) { return showToast('لا يمكن حذف هذه الفرقة لأنها مرتبطة بمواد دراسية.', 'error'); }
            if (type === 'group' && courses.some(c => c.groupName === itemToDelete.name)) { return showToast('لا يمكن حذف هذه المجموعة لأنها مستخدمة في بعض السكاشن.', 'error'); }

            const confirmed = await showConfirmModal(`هل أنت متأكد من حذف "${itemToDelete.name}"؟`, async () => {
                const element = document.querySelector(`.list-item[data-id='${id}']`);
                if(element) {
                    element.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 400));
                }
                const colMap = { level: levelsCol, group: groupsCol, subject: subjectsCol, instructor: instructorsCol, location: locationsCol, course: coursesCol };
                await deleteDoc(doc(db, colMap[type].path, id));
                showToast("تم الحذف بنجاح!");
            });
        };

        function setupRealtimeListeners() {
            let loadedCollections = 0;
            const totalCollections = 7;
            const onCollectionLoaded = () => {
                loadedCollections++;
                if (loadedCollections === totalCollections) {
                    dom.loadingIndicator.style.display = 'none';
                    dom.mainContent.classList.remove('hidden');
                }
            };

            onSnapshot(query(levelsCol), s => { levels = s.docs.map(d => ({ id: d.id, ...d.data() })); renderLevels(); updateLevelSelectors(); onCollectionLoaded(); });
            onSnapshot(query(groupsCol), s => { groups = s.docs.map(d => ({ id: d.id, ...d.data() })); renderGroups(); updateGroupSelector(); onCollectionLoaded(); });
            onSnapshot(query(subjectsCol), s => { subjects = s.docs.map(d => ({ id: d.id, ...d.data() })); subjects.forEach(sub => courseColors[sub.name] = sub.color || generateHslColor(sub.name)); renderSubjects(); updateCourseSelector(); renderSummaryTable(); onCollectionLoaded(); });
            onSnapshot(query(instructorsCol), s => { instructors = s.docs.map(d => ({ id: d.id, ...d.data() })); renderInstructors(); updateInstructorSelector(); onCollectionLoaded(); });
            onSnapshot(query(locationsCol), s => { locations = s.docs.map(d => ({ id: d.id, ...d.data() })); renderLocations(); onCollectionLoaded(); });
            onSnapshot(query(coursesCol), s => { courses = s.docs.map(d => ({ id: d.id, ...d.data() })); renderCourses(); renderSummaryTable(); onCollectionLoaded(); });
            onSnapshot(query(schedulesCol), s => {
                savedSchedules = {};
                s.docs.forEach(d => { try { savedSchedules[d.id] = JSON.parse(d.data().grid); } catch (e) { console.error("Error parsing saved schedule:", e); } });
                handleLevelFilterChange();
                if (activeCustomView === 'members') {
                    displayMemberSchedules();
                } else if (activeCustomView === 'locations') {
                    displayLocationSchedules();
                }
                onCollectionLoaded();
            });
        }
        
        const showMainView = () => {
            dom.mainContent.classList.remove('hidden');
            dom.advancedLevelsView.classList.add('hidden');
            dom.advancedInstructorsView.classList.add('hidden');
            dom.customViewsContainer.classList.add('hidden');
        }
        window.showMainView = showMainView;

        window.showAdvancedLevelsView = () => {
            dom.mainContent.classList.add('hidden');
            dom.advancedInstructorsView.classList.add('hidden');
            dom.advancedLevelsView.classList.remove('hidden');
            dom.advancedLevelsView.innerHTML = generateAdvancedLevelsHTML();

            document.getElementById('adv-level-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('#adv-levels-list > div').forEach(div => {
                    const name = div.querySelector('p').textContent.toLowerCase();
                    div.style.display = name.includes(query) ? 'flex' : 'none';
                });
            });
        }
        
        window.showAdvancedInstructorsView = () => {
            dom.mainContent.classList.add('hidden');
            dom.advancedLevelsView.classList.add('hidden');
            dom.advancedInstructorsView.classList.remove('hidden');
            renderAdvancedInstructorsView();
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
        dom.levelForm.addEventListener('submit', handleAddLevel);
        dom.groupForm.addEventListener('submit', handleAddGroup);
        dom.subjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = dom.subjectForm.querySelector('#subject-name').value.trim();
            const academicLevel = dom.subjectLevelSelect.value;
            if (name && academicLevel && !subjects.some(s => s.name === name)) {
                await handleAddWithLoading(e, subjectsCol, { name, academicLevel, sectionCounter: 0 }, "تمت إضافة المادة بنجاح!");
                dom.subjectForm.querySelector('#subject-name').value = '';
            } else {
                showToast('يرجى اختيار فرقة وإدخال اسم مادة غير مكرر.', 'error');
            }
        });
        dom.instructorForm.addEventListener('submit', (e) => {
            const nameInput = document.getElementById('instructor-name-input');
            const name = nameInput.value.trim();
            if (name && !instructors.some(i => i.name === name)) {
                const data = { name, category: document.getElementById('instructor-category-select').value, availableTimes: {}, customActivities: {} };
                handleAddWithLoading(e, instructorsCol, data, "تمت إضافة العضو بنجاح!");
            }
        });
        dom.locationForm.addEventListener('submit', (e) => {
            const nameInput = document.getElementById('location-name');
            const data = { name: nameInput.value, type: document.getElementById('location-type').value };
            handleAddWithLoading(e, locationsCol, data, "تمت إضافة المكان بنجاح!");
        });
        dom.courseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);

            const subjectName = dom.courseNameSelect.value;
            const instructorName = dom.instructorSelect.value;
            const sessionType = dom.sessionType.value;
            const groupName = dom.courseGroupSelect.value;

            if (!subjectName || !instructorName) { 
                showToast("الرجاء اختيار المادة والعضو.", "error");
                toggleButtonLoading(button, false);
                return; 
            }
            if (sessionType === 'lab' && !groupName) { 
                showToast("الرجاء اختيار المجموعة للسكشن.", "error");
                toggleButtonLoading(button, false);
                return; 
            }
            
            try {
                const subject = subjects.find(s => s.name === subjectName);
                const sectionsCount = parseInt(document.getElementById('sections-count').value);
                
                for (let i = 0; i < sectionsCount; i++) {
                    const courseData = {
                        baseName: subject.name,
                        name: (sessionType === 'lab') ? `${subject.name} - سكشن ${subject.sectionCounter + i + 1}` : subject.name,
                        instructor: instructorName,
                        type: sessionType,
                        requiredLocationType: document.getElementById('location-type-select').value,
                        duration: parseInt(document.getElementById('duration').value)
                    };
                    if (sessionType === 'lab') { courseData.groupName = groupName; }
                    await addDoc(coursesCol, courseData);
                }
                if (sessionType === 'lab') {
                    const subjectDocRef = doc(db, subjectsCol.path, subject.id);
                    await updateDoc(subjectDocRef, { sectionCounter: subject.sectionCounter + sectionsCount });
                }
                showToast("تمت إضافة المقرر بنجاح!");
            } catch (error) {
                console.error("Error adding course: ", error);
                showToast("حدث خطأ أثناء إضافة المقرر.", "error");
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        dom.generateBtn.addEventListener('click', generateSchedule);
        dom.locationsViewBtn.addEventListener('click', displayLocationSchedules);
        dom.filterMembersBtn.addEventListener('click', () => displayMemberSchedules());
        dom.hideCustomViewBtn.addEventListener('click', () => {
            dom.customViewsContainer.style.display = 'none';
            dom.hideCustomViewBtn.classList.add('hidden');
            activeCustomView = null;
        });
        dom.exportBtn.addEventListener('click', handleExportToFile);
        dom.loadBtn.addEventListener('click', () => dom.fileLoader.click());
        dom.fileLoader.addEventListener('change', handleLoadScheduleFromFile);
        dom.resetBtn.addEventListener('click', () => showConfirmModal("هل أنت متأكد من حذف كل البيانات؟ هذا الإجراء لا يمكن التراجع عنه.", () => handleReset(true)));
        dom.printBtn.addEventListener('click', () => window.print());
        dom.levelFilterSelect.addEventListener('change', handleLevelFilterChange);
        dom.sessionType.addEventListener('change', () => {
            dom.groupSelectContainer.style.display = dom.sessionType.value === 'lab' ? 'block' : 'none';
        });

        [dom.closeEditModalBtn, dom.closeAvailabilityModalBtn, dom.closeCourseEditModalBtn, dom.closeCustomActivityModalBtn, dom.confirmModal.cancelBtn].forEach(btn => {
            if(btn) btn.onclick = () => btn.closest('.modal').style.display = "none";
        });
        window.onclick = (event) => { 
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        };
        
        function createControlButtons(type, id) { return `<div class="control-buttons flex items-center gap-2"> <button onclick="window.openEditModal('${type}', '${id}')" class="text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-pencil-alt"></i></button> ${type === 'instructor' ? `<button onclick="window.openAvailabilityModal('${id}')" class="text-green-500 hover:text-green-700 p-1"><i class="fas fa-clock"></i></button>` : ''} <button onclick="window.deleteItem('${type}', '${id}')" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button> </div>`; }
        function renderSubjects() {
            dom.subjectsList.innerHTML = subjects.map(s => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md border-r-4" data-id="${s.id}" style="border-color: ${s.color || '#cccccc'}"><div class="flex items-center gap-3"><input type="color" value="${s.color || generateHslColor(s.name, true)}" onchange="window.handleSubjectColorChange('${s.id}', this.value)" style="width: 32px; height: 32px;"><div><p class="font-semibold text-sm">${s.name}</p><p class="text-xs text-gray-500">${s.academicLevel}</p></div></div>${createControlButtons('subject', s.id)}</div>`).join('');
        }
        function renderInstructors() { let html = ''; INSTRUCTOR_CATEGORIES.forEach(category => { const members = instructors.filter(i => i.category === category); if (members.length > 0) { html += `<h4 class="text-sm font-bold text-gray-500 mt-3">${category}</h4>`; html += members.map(i => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md" data-id="${i.id}"><p class="font-semibold text-sm">${i.name}</p>${createControlButtons('instructor', i.id)}</div>`).join(''); } }); dom.instructorsList.innerHTML = html; }
        function renderLocations() { dom.locationsList.innerHTML = locations.map(l => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md" data-id="${l.id}"><p class="font-semibold text-sm">${l.name} (${l.type})</p>${createControlButtons('location', l.id)}</div>`).join(''); }
        function renderCourses() {
            const selectedLevel = dom.levelFilterSelect.value;
            const coursesToDisplay = selectedLevel === 'all' ? courses : courses.filter(c => subjects.some(s => s.name === c.baseName && s.academicLevel === selectedLevel));
            dom.coursesList.innerHTML = coursesToDisplay.length ? coursesToDisplay.map(c => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md border-r-4" data-id="${c.id}" style="border-color: ${courseColors[c.baseName] || '#cccccc'}"><div><p class="font-semibold text-sm">${c.name} ${c.groupName ? `(${c.groupName})` : ''}</p><p class="text-xs text-gray-500">${c.instructor} | ${c.duration} س | ${c.requiredLocationType}</p></div><button onclick="window.deleteItem('course', '${c.id}')" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button></div>`).join('') : '<p class="text-gray-400">لم تتم إضافة أي محاضرات لهذه الفرقة.</p>';
        }
        function renderSummaryTable() {
            const selectedLevel = dom.levelFilterSelect.value;
            const container = dom.summaryTableContainer;
            if (!selectedLevel || selectedLevel === 'all') { container.innerHTML = ''; return; }
            const subjectsForLevel = subjects.filter(s => s.academicLevel === selectedLevel);
            if (subjectsForLevel.length === 0) { container.innerHTML = ''; return; }
            let totalLectureHours = 0; let totalLabHours = 0;
            const tableRows = subjectsForLevel.map(subject => { const associatedCourses = courses.filter(c => c.baseName === subject.name); const lectureHours = associatedCourses.filter(c => c.type === 'lecture').reduce((sum, c) => sum + c.duration, 0); const labHours = associatedCourses.filter(c => c.type === 'lab').reduce((sum, c) => sum + c.duration, 0); totalLectureHours += lectureHours; totalLabHours += labHours; return ` <tr class="border-b"> <td class="p-2 font-semibold text-black"> <div class="flex items-center justify-start gap-2"> <div class="w-4 h-4 rounded-sm" style="background-color: ${subject.color || '#cccccc'};"></div> <span>${subject.name}</span> </div> </td> <td class="p-2 text-center">${lectureHours}</td> <td class="p-2 text-center">${labHours}</td> <td class="p-2 text-center font-bold">${lectureHours + labHours}</td> </tr> `; }).join('');
            container.innerHTML = ` <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg"> <h3 class="text-lg font-bold text-center mb-4 text-gray-600">مراية الجدول: ملخص الساعات (${selectedLevel})</h3> <table class="w-full text-sm"> <thead> <tr class="bg-gray-100 text-gray-600 uppercase text-xs"> <th class="p-2 text-right">المادة</th> <th class="p-2 text-center">ساعات نظري</th> <th class="p-2 text-center">ساعات عملي</th> <th class="p-2 text-center">الإجمالي</th> </tr> </thead> <tbody> ${tableRows} </tbody> <tfoot> <tr class="bg-gray-200 font-bold"> <td class="p-2 text-right">الإجمالي الكلي</td> <td class="p-2 text-center">${totalLectureHours}</td> <td class="p-2 text-center">${totalLabHours}</td> <td class="p-2 text-center">${totalLectureHours + totalLabHours}</td> </tr> </tfoot> </table> </div> `;
        }
        function updateLevelSelectors() { const options = levels.map(l => `<option value="${l.name}">${l.name}</option>`).join(''); dom.subjectLevelSelect.innerHTML = `<option value="">اختر الفرقة...</option>` + options; dom.levelFilterSelect.innerHTML = `<option value="all">عرض الكل</option>` + options; handleLevelFilterChange(); }
        function updateGroupSelector() { dom.courseGroupSelect.innerHTML = '<option value="">اختر المجموعة...</option>' + groups.map(g => `<option value="${g.name}">${g.name}</option>`).join(''); }
        function updateCourseSelector() {
            const selectedLevel = dom.levelFilterSelect.value;
            if (!selectedLevel || selectedLevel === 'all') { dom.courseNameSelect.innerHTML = '<option value="">اختر الفرقة الرئيسية أولاً...</option>'; return; }
            const filteredSubjects = subjects.filter(s => s.academicLevel === selectedLevel);
            dom.courseNameSelect.innerHTML = '<option value="">اختر المادة...</option>' + filteredSubjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }
        function updateInstructorSelector() {
            const selectedLevel = dom.levelFilterSelect.value;
            let instructorsToShow = instructors;
            if (selectedLevel && selectedLevel !== 'all') { const subjectsForLevel = subjects.filter(s => s.academicLevel === selectedLevel).map(s => s.name); const coursesForLevel = courses.filter(c => subjectsForLevel.includes(c.baseName)); const instructorsForLevel = [...new Set(coursesForLevel.map(c => c.instructor))]; if (instructorsForLevel.length > 0) { instructorsToShow = instructors.filter(i => instructorsForLevel.includes(i.name)); } }
            let html = '<option value="">اختر العضو...</option>';
            INSTRUCTOR_CATEGORIES.forEach(category => { const members = instructorsToShow.filter(i => i.category === category); if (members.length > 0) { html += `<optgroup label="${category}">`; html += members.map(i => `<option value="${i.name}">${i.name}</option>`).join(''); html += `</optgroup>`; } });
            dom.instructorSelect.innerHTML = html;
        }
        function handleLevelFilterChange() {
            renderCourses(); updateCourseSelector(); updateInstructorSelector(); renderSummaryTable();
            const selectedLevel = dom.levelFilterSelect.value;
            if (savedSchedules[selectedLevel]) { scheduleGrid = savedSchedules[selectedLevel]; displaySchedule(); dom.unscheduledOutput.innerHTML = ''; }
            else { scheduleGrid = {}; dom.scheduleOutput.innerHTML = '<p class="text-center text-gray-500">لم يتم إنشاء جدول لهذه الفرقة بعد. اضغط على "تحديث الجدول".</p>'; }
        }
        window.openEditModal = (type, id) => {
            const item = { level: levels, group: groups, subject: subjects, instructor: instructors, location: locations }[type].find(i => i.id === id); if (!item) return;
            dom.editModalTitle.textContent = `تعديل اسم ${item.name}`; dom.editModalInput.value = item.name;
            dom.editModal.style.display = "block";
            dom.editModalSaveBtn.onclick = () => handleUpdateItem(type, id, dom.editModalInput.value.trim());
        };
        window.handleSubjectColorChange = async (id, color) => { const subjectRef = doc(db, subjectsCol.path, id); await updateDoc(subjectRef, { color: color }); };
        async function handleUpdateItem(type, id, newName) {
            if (!newName) return;
            const collectionInfo = { level: {col: levelsCol }, group: {col: groupsCol }, subject: {col: subjectsCol }, instructor: {col: instructorsCol }, location: {col: locationsCol } }[type];
            const item = { level: levels, group: groups, subject: subjects, instructor: instructors, location: locations }[type].find(i => i.id === id);
            const oldName = item.name;
            if ({ level: levels, group: groups, subject: subjects, instructor: instructors, location: locations }[type].some(i => i.name === newName && i.id !== id)) return showToast("هذا الاسم موجود بالفعل.", "error");
            const batch = writeBatch(db);
            if (type === 'level') { subjects.forEach(s => { if(s.academicLevel === oldName) batch.update(doc(db, subjectsCol.path, s.id), { academicLevel: newName }); }); }
            if (type === 'group') { courses.forEach(c => { if(c.groupName === oldName) batch.update(doc(db, coursesCol.path, c.id), { groupName: newName }); }); }
            if (type === 'instructor') { courses.forEach(c => { if(c.instructor === oldName) batch.update(doc(db, coursesCol.path, c.id), { instructor: newName }); }); }
            if (type === 'subject') {
                courses.forEach(c => { if (c.baseName === oldName) { batch.update(doc(db, coursesCol.path, c.id), { baseName: newName, name: c.name.replace(oldName, newName) }); } });
                for (const levelName in savedSchedules) { let grid = savedSchedules[levelName]; let gridWasModified = false; for (const day in grid) { for (const time in grid[day]) { for (const loc in grid[day][time]) { const cellData = grid[day][time][loc]; if (cellData && cellData.baseName === oldName) { cellData.baseName = newName; cellData.name = cellData.name.replace(oldName, newName); gridWasModified = true; } } } } if (gridWasModified) { const scheduleRef = doc(db, schedulesCol.path, levelName); batch.update(scheduleRef, { grid: JSON.stringify(grid) }); } }
            }
            batch.update(doc(db, collectionInfo.col.path, id), { name: newName });
            await batch.commit();
            if (type === 'subject') { const oldColor = courseColors[oldName]; delete courseColors[oldName]; courseColors[newName] = oldColor; }
            dom.editModal.style.display = "none";
            showToast("تم التعديل بنجاح!");
        }
        window.openAvailabilityModal = (id) => {
            const instructor = instructors.find(i => i.id === id); if(!instructor) return;
            dom.availabilityModalTitle.textContent = `تحديد أوقات التفرغ لـ ${instructor.name}`; let gridHtml = '';
            DAYS.forEach(day => { gridHtml += `<div class="grid grid-cols-6 gap-2 items-center"><label class="font-bold col-span-1">${day}</label><div class="col-span-5 flex flex-wrap gap-1">`; TIME_SLOTS_HOURLY.forEach(time => { const isChecked = ((instructor.availableTimes || {})[day] || []).includes(time); gridHtml += `<label class="flex items-center space-x-1 p-1 border rounded-md"><input type="checkbox" data-day="${day}" data-time="${time}" ${isChecked ? 'checked' : ''} class="form-checkbox h-4 w-4"><span class="text-xs">${formatTimeSlot(time)}</span></label>`; }); gridHtml += `</div></div>`; });
            dom.availabilityGrid.innerHTML = gridHtml;
            dom.availabilityModal.style.display = "block";
            dom.availabilityModalSaveBtn.onclick = () => handleSaveAvailability(id);
        };
        async function handleSaveAvailability(id) {
            const instructorRef = doc(db, instructorsCol.path, id); const newAvailableTimes = {};
            const checkboxes = dom.availabilityGrid.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => { const day = cb.dataset.day; const time = parseInt(cb.dataset.time); if (!newAvailableTimes[day]) newAvailableTimes[day] = []; newAvailableTimes[day].push(time); });
            await updateDoc(instructorRef, { availableTimes: newAvailableTimes });
            dom.availabilityModal.style.display = "none";
            showToast("تم حفظ التفرغ بنجاح!");
        }
        function findAvailableLocations(course, day, time, level) {
            const targetDay = day; const targetTime = parseInt(time); const duration = course.duration; const requiredType = course.requiredLocationType; const grid = savedSchedules[level]; if (!grid) return [];
            return locations.filter(loc => { if (loc.type !== requiredType) return false; let isFree = true; for (let i = 0; i < duration; i++) { const slotData = grid[targetDay]?.[targetTime + i]?.[loc.name]; if (slotData && slotData.id !== course.id) { isFree = false; break; } } return isFree; });
        }
        window.openScheduleItemModal = (courseId, day, time, locationName, levelOverride = null) => {
            const course = courses.find(c => c.id === courseId); if (!course) return; const subject = subjects.find(s => s.name === course.baseName); if (!subject) return;
            const sectionNameInput = document.getElementById('course-edit-section-name-input'); const sectionNameContainer = document.getElementById('course-edit-section-name-container');
            dom.courseEditModalTitle.textContent = `تعديل: ${course.name}`; document.getElementById('course-edit-subject-name-input').value = subject.name;
            if (course.type === 'lab') { sectionNameInput.value = course.name; sectionNameContainer.classList.remove('hidden'); } else { sectionNameContainer.classList.add('hidden'); }
            dom.courseEditInstructorSelect.innerHTML = instructors.map(i => `<option value="${i.name}" ${i.name === course.instructor ? 'selected' : ''}>${i.name}</option>`).join('');
            const currentLevel = levelOverride || dom.levelFilterSelect.value; const locationSelect = document.getElementById('course-edit-location-select'); const availableLocations = findAvailableLocations(course, day, time, currentLevel);
            locationSelect.innerHTML = `<option value="${locationName}">${locationName} (الحالي)</option>`; availableLocations.forEach(loc => { if (loc.name !== locationName) { locationSelect.innerHTML += `<option value="${loc.name}">${loc.name}</option>`; } });
            document.getElementById('course-edit-color-input').value = subject.color || generateHslColor(subject.name, true);
            dom.courseEditModal.style.display = 'block';
            dom.courseEditModalSaveBtn.onclick = () => handleScheduleItemUpdate({ courseId: course.id, subjectId: subject.id, originalSubjectName: subject.name, originalLocation: locationName, day: day, time: time, level: currentLevel });
            dom.courseEditModalDeleteBtn.onclick = () => handleDeleteFromSchedule(courseId, day, time, locationName, currentLevel);
        };
        async function handleScheduleItemUpdate(context) {
            const { courseId, subjectId, originalSubjectName, originalLocation, day, time, level } = context; const newSubjectName = document.getElementById('course-edit-subject-name-input').value.trim();
            if (newSubjectName && newSubjectName !== originalSubjectName) { await handleUpdateItem('subject', subjectId, newSubjectName); dom.courseEditModal.style.display = 'none'; return; }
            const course = courses.find(c => c.id === courseId); const newSectionName = document.getElementById('course-edit-section-name-input').value.trim(); const newInstructor = dom.courseEditInstructorSelect.value; const newLocation = document.getElementById('course-edit-location-select').value; const newColor = document.getElementById('course-edit-color-input').value;
            const batch = writeBatch(db); const subjectRef = doc(db, subjectsCol.path, subjectId); batch.update(subjectRef, { color: newColor });
            const courseRef = doc(db, coursesCol.path, courseId); let courseUpdates = {}; if (newInstructor !== course.instructor) courseUpdates.instructor = newInstructor; if (course.type === 'lab' && newSectionName && newSectionName !== course.name) courseUpdates.name = newSectionName; if (Object.keys(courseUpdates).length > 0) { batch.update(courseRef, courseUpdates); }
            await batch.commit();
            if (newLocation !== originalLocation) {
                const currentLevel = level; let grid = JSON.parse(JSON.stringify(savedSchedules[currentLevel])); const courseToMove = { ...course, ...courseUpdates };
                for (let i = 0; i < course.duration; i++) { if (grid[day]?.[parseInt(time) + i]) { grid[day][parseInt(time) + i][originalLocation] = null; } }
                for (let i = 0; i < course.duration; i++) { if (!grid[day]) grid[day] = {}; if (!grid[day][parseInt(time) + i]) grid[day][parseInt(time) + i] = {}; grid[day][parseInt(time) + i][newLocation] = { ...courseToMove, isContinuation: i > 0 }; }
                const scheduleRef = doc(db, schedulesCol.path, currentLevel); await setDoc(scheduleRef, { grid: JSON.stringify(grid) });
            }
            dom.courseEditModal.style.display = 'none';
            showToast("تم حفظ التعديلات!");
        }
        async function handleDeleteFromSchedule(courseId, day, time, locationName, levelOverride = null) {
            const course = courses.find(c => c.id === courseId); if (!course) return; const selectedLevel = levelOverride || dom.levelFilterSelect.value; if (!selectedLevel || selectedLevel === 'all') return;
            const confirmed = await showConfirmModal("هل تريد بالتأكيد حذف هذا المقرر من الجدول؟", async () => {
                let grid = JSON.parse(JSON.stringify(savedSchedules[selectedLevel]));
                for (let i = 0; i < course.duration; i++) { if(grid[day]?.[parseInt(time) + i]) { grid[day][parseInt(time) + i][locationName] = null; } }
                await saveScheduleToFirebase(selectedLevel, grid);
                showToast("تم الحذف من الجدول.");
            });
            if(confirmed) dom.courseEditModal.style.display = 'none';
        }
        window.openCustomActivityModal = (instructorId, day, time, text = '', duration = 1) => {
            dom.customActivityModalTitle.textContent = text ? 'تعديل النشاط' : 'إضافة نشاط مخصص';
            dom.customActivityText.value = text; dom.customActivityDuration.value = duration;
            dom.customActivityDeleteBtn.classList.toggle('hidden', !text);
            dom.customActivityModal.style.display = 'block';
            dom.customActivitySaveBtn.onclick = () => handleSaveCustomActivity(instructorId, day, time);
            dom.customActivityDeleteBtn.onclick = () => handleDeleteCustomActivity(instructorId, day, time);
        };
        async function handleSaveCustomActivity(instructorId, day, time) {
            const text = dom.customActivityText.value.trim(); const duration = parseInt(dom.customActivityDuration.value);
            if (!text || !duration) return showToast('يرجى ملء جميع الحقول.', 'error');
            const instructorRef = doc(db, instructorsCol.path, instructorId); const key = `customActivities.${day}-${time}`;
            await updateDoc(instructorRef, { [key]: { text, duration } });
            dom.customActivityModal.style.display = 'none';
            showToast("تم حفظ النشاط.");
        }
        async function handleDeleteCustomActivity(instructorId, day, time) {
            const confirmed = await showConfirmModal("هل أنت متأكد من حذف هذا النشاط؟", async () => {
                const instructorRef = doc(db, instructorsCol.path, instructorId); const key = `customActivities.${day}-${time}`;
                await updateDoc(instructorRef, { [key]: deleteField() });
                dom.customActivityModal.style.display = 'none';
                showToast("تم حذف النشاط.");
            });
        }
        async function saveScheduleToFirebase(level, grid) { if (!level || level === 'all') return; try { const scheduleRef = doc(db, schedulesCol.path, level); await setDoc(scheduleRef, { grid: JSON.stringify(grid) }); } catch (error) { console.error("Error saving schedule:", error); showToast("خطأ في حفظ الجدول", "error"); } }
        function generateSchedule() {
            const selectedLevel = dom.levelFilterSelect.value;
            if (selectedLevel === 'all') { return showToast("يرجى اختيار فرقة دراسية محددة لتحديث جدولها.", "error"); }
            scheduleGrid = savedSchedules[selectedLevel] ? JSON.parse(JSON.stringify(savedSchedules[selectedLevel])) : {};
            if (Object.keys(scheduleGrid).length === 0) { DAYS.forEach(day => { scheduleGrid[day] = {}; TIME_SLOTS_HOURLY.forEach(time => { scheduleGrid[day][time] = {}; locations.forEach(loc => scheduleGrid[day][time][loc.name] = null); }); }); }
            const placedCourseIds = new Set();
            for (const day in scheduleGrid) for (const time in scheduleGrid[day]) for (const loc in scheduleGrid[day][time]) { if (scheduleGrid[day][time][loc]) { placedCourseIds.add(scheduleGrid[day][time][loc].id); } }
            const coursesForLevel = courses.filter(course => subjects.find(s => s.name === course.baseName)?.academicLevel === selectedLevel);
            const coursesToSchedule = coursesForLevel.filter(c => !placedCourseIds.has(c.id));
            if (coursesToSchedule.length === 0) { return showToast("لا توجد مواد جديدة لإضافتها للجدول.", "error"); }
            let instructorSchedule = {}; instructors.forEach(inst => { instructorSchedule[inst.name] = {}; DAYS.forEach(day => { instructorSchedule[inst.name][day] = {}; TIME_SLOTS_HOURLY.forEach(time => instructorSchedule[inst.name][day][time] = null); }); });
            let lectureBlockedTimes = {}; DAYS.forEach(day => { lectureBlockedTimes[day] = new Set(); });
            for (const day of DAYS) for (const time of TIME_SLOTS_HOURLY) for (const loc of locations) { const cellData = scheduleGrid[day]?.[time]?.[loc.name]; if (cellData) { instructorSchedule[cellData.instructor][day][time] = cellData.type; if (cellData.type === 'lecture') { lectureBlockedTimes[day].add(time); } } }
            let unscheduled = [];
            const schedulePhase = (courseList) => {
                courseList.forEach(course => {
                    let scheduled = false;
                    for (const time of TIME_SLOTS_HOURLY) {
                        if (time + course.duration > 18) continue;
                        for (const day of DAYS) {
                            const availableLocationsForSlot = locations.filter(l => l.type === course.requiredLocationType);
                            for (const loc of availableLocationsForSlot) {
                                if (canPlaceCourse(course, day, time, loc.name, instructorSchedule, lectureBlockedTimes)) { placeCourse(course, day, time, loc.name, instructorSchedule, lectureBlockedTimes); scheduled = true; break; }
                            }
                            if (scheduled) break;
                        }
                        if (scheduled) break;
                    }
                    if (!scheduled) unscheduled.push(course);
                });
            };
            schedulePhase(coursesToSchedule.filter(c => c.type === 'lecture').sort((a,b)=>b.duration-a.duration));
            schedulePhase(coursesToSchedule.filter(c => c.type === 'lab').sort((a,b)=>b.duration-a.duration));
            saveScheduleToFirebase(selectedLevel, scheduleGrid);
            displaySchedule();
            displayUnscheduled(unscheduled);
            showToast("تم تحديث الجدول بنجاح!");
        }
        function canPlaceCourse(course, day, time, locName, instructorSchedule, lectureBlockedTimes) {
            const instructor = instructors.find(i => i.name === course.instructor);
            if (instructor?.availableTimes?.[day]?.length > 0) { for (let i = 0; i < course.duration; i++) { if (!instructor.availableTimes[day].includes(time + i)) return false; } }
            for (let i = 0; i < course.duration; i++) { 
                const currentTime = time + i; 
                if (currentTime >= 18) return false; 
                if (course.type === 'lab' && lectureBlockedTimes[day]?.has(currentTime)) return false; 
                if (scheduleGrid[day]?.[currentTime]?.[locName]) return false;
                const instructorActivity = instructorSchedule[course.instructor]?.[day]?.[currentTime];
                if (instructorActivity) { if (instructorActivity === 'lecture') return false; if (course.type === 'lecture') return false; if (course.requiredLocationType === 'معمل') return false; }
                for (const anyLoc of Object.keys(scheduleGrid[day]?.[currentTime] || {})) { const existingCourse = scheduleGrid[day][currentTime][anyLoc]; if (existingCourse && existingCourse.baseName === course.baseName) { return false; } }
            }
            return true;
        }
        function placeCourse(course, day, time, locName, instructorSchedule, lectureBlockedTimes) {
            for (let i = 0; i < course.duration; i++) { const currentTime = time + i; scheduleGrid[day][currentTime][locName] = { ...course, isContinuation: i > 0 }; if (instructorSchedule[course.instructor]) { instructorSchedule[course.instructor][day][currentTime] = course.type; } if(course.type === 'lecture' && lectureBlockedTimes[day]) { lectureBlockedTimes[day].add(currentTime); } }
        }
        function displaySchedule(isCustomView = false) {
            const level = dom.levelFilterSelect.value; if (!level) return;
            const targetElement = isCustomView ? dom.customScheduleOutput : dom.scheduleOutput;
            let title = level === 'all' ? 'الجدول الدراسي العام' : `الجدول الدراسي - ${level}`;
            let tableHtml = `<h2 class="text-2xl font-bold text-center mb-4 text-gray-700">${title}</h2>`;
            tableHtml += '<table class="w-full border-collapse">';
            tableHtml += `<thead><tr class="bg-gray-200"><th class="p-2 border border-gray-300">اليوم</th>${TIME_SLOTS_HOURLY.map(time => `<th class="p-2 border border-gray-300 font-mono text-sm">${formatTimeSlot(time)}</th>`).join('')}</tr></thead><tbody>`;
            DAYS.forEach(day => {
                tableHtml += `<tr class="text-center"><td class="p-2 border border-gray-300 font-semibold align-middle bg-gray-50">${day}</td>`;
                let time_cursor = 0;
                while (time_cursor < TIME_SLOTS_HOURLY.length) {
                    const time = TIME_SLOTS_HOURLY[time_cursor];
                    const itemsInCell = locations.map(loc => ({ locName: loc.name, data: scheduleGrid[day]?.[time]?.[loc.name] })).filter(item => item.data && !item.data.isContinuation);
                    if (itemsInCell.length > 0) {
                        const duration = itemsInCell[0].data.duration || 1; const containerClass = itemsInCell.length > 1 ? 'multi-item-container' : '';
                        tableHtml += `<td class="p-1 border border-gray-300 align-top" colspan="${duration}">`;
                        tableHtml += `<div class="drop-target ${containerClass}" data-day="${day}" data-time="${time}">`;
                        itemsInCell.forEach(item => { const { locName, data: cellData } = item; const bgColor = courseColors[cellData.baseName] || '#e5e7eb'; const borderColor = cellData.type === 'lecture' ? '#f59e0b' : (courseColors[cellData.baseName] ? courseColors[cellData.baseName].replace('85%', '60%') : '#cccccc'); tableHtml += `<div class="schedule-item text-[11px]" draggable="true" data-course-id="${cellData.id}" data-day="${day}" data-time="${time}" data-location="${locName}" onclick="window.openScheduleItemModal('${cellData.id}', '${day}', ${time}, '${locName}')" style="background-color: ${bgColor}; border-right: 4px solid ${borderColor};"><p class="font-bold">${cellData.name}</p><p>${cellData.instructor}</p>${cellData.groupName ? `<p class="font-bold text-teal-700">${cellData.groupName}</p>` : ''}<p class="font-semibold text-gray-600">${locName}</p></div>`; });
                        tableHtml += `</div></td>`;
                        time_cursor += duration;
                    } else { const isContinuationSlot = locations.some(loc => scheduleGrid[day]?.[time]?.[loc.name]?.isContinuation); if (!isContinuationSlot) { tableHtml += `<td class="p-1 border border-gray-300 align-top"><div class="drop-target" data-day="${day}" data-time="${time}"></div></td>`; } time_cursor++; }
                }
                tableHtml += `</tr>`;
            });
            tableHtml += '</tbody></table>';
            targetElement.innerHTML = tableHtml;
            addDragAndDropListeners(isCustomView ? '#custom-schedule-output' : '#schedule-output');
        }
        function displayUnscheduled(unscheduled) { dom.unscheduledOutput.innerHTML = unscheduled.length ? `<div class="bg-red-100 border-r-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md" role="alert"><p class="font-bold text-lg">مواد لم يتم تسكينها:</p><ul class="list-disc list-inside">${unscheduled.map(c => `<li>${c.name} (${c.instructor})</li>`).join('')}</ul></div>` : ''; }
        function displayLocationSchedules() {
            activeCustomView = 'locations'; dom.customViewsContainer.style.display = 'block'; dom.hideCustomViewBtn.classList.remove('hidden'); let allHtml = '<h2 class="text-3xl font-bold text-center mb-6 text-gray-700 border-b-2 pb-2">جداول الأماكن</h2>';
            for (const type in LOCATION_TYPES) { allHtml += generateAggregatedLocationTableHtml(type, `جداول ${LOCATION_TYPES[type]}`); }
            dom.customScheduleOutput.innerHTML = allHtml;
        }
        function displayMemberSchedules(searchQuery = '', filterCategory = 'all') {
            activeCustomView = 'members'; dom.customViewsContainer.style.display = 'block'; dom.hideCustomViewBtn.classList.remove('hidden');
            const sidebarHtml = ` <div id="members-view-sidebar" class="w-full lg:w-1/5 lg:pr-6 mb-8 lg:mb-0"> <div class="bg-white p-4 rounded-xl shadow-md"> <h3 class="font-bold mb-4 text-lg">تصفية الأعضاء</h3> <input type="text" id="member-search-input" placeholder="ابحث بالاسم..." class="w-full p-2 border rounded-md mb-4" value="${searchQuery}"> <div id="member-filter-options" class="space-y-2"> <label class="flex items-center"><input type="radio" name="category" value="all" class="ml-2" ${filterCategory === 'all' ? 'checked' : ''}> الكل</label> ${INSTRUCTOR_CATEGORIES.map(cat => `<label class="flex items-center"><input type="radio" name="category" value="${cat}" class="ml-2" ${filterCategory === cat ? 'checked' : ''}> ${cat}</label>`).join('')} </div> </div> </div> `;
            const mainContentHtml = `<div id="members-view-content" class="w-full lg:w-4/5"></div>`;
            dom.customScheduleOutput.innerHTML = ` <h2 class="text-3xl font-bold text-center mb-6 text-gray-700 border-b-2 pb-2">جداول الأعضاء</h2> <div class="lg:flex"> ${sidebarHtml} ${mainContentHtml} </div>`;
            document.getElementById('members-view-content').innerHTML = generateInstructorSchedulesHtml(searchQuery, filterCategory);
            document.getElementById('member-search-input').addEventListener('input', (e) => { const currentCategory = document.querySelector('input[name="category"]:checked').value; displayMemberSchedules(e.target.value, currentCategory); });
            document.querySelectorAll('input[name="category"]').forEach(radio => { radio.addEventListener('change', (e) => { const currentSearch = document.getElementById('member-search-input').value; displayMemberSchedules(currentSearch, e.target.value); }); });
        }
        function generateAggregatedLocationTableHtml(filterType, mainTitle) {
            const filteredItems = locations.filter(l => l.type === filterType); if (!filteredItems.length) return '';
            let allHtml = `<div class="mb-10"><h3 class="text-2xl font-bold text-center mb-4 text-cyan-700">${mainTitle}</h3>`;
            filteredItems.forEach(item => {
                allHtml += `<div class="mb-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg"><h4 class="text-xl font-bold text-center mb-4 text-cyan-600">${item.name}</h4>`;
                allHtml += `<table class="w-full border-collapse"><thead><tr class="bg-gray-200"><th class="p-2 border">اليوم</th>${TIME_SLOTS_HOURLY.map(t => `<th class="p-2 border font-mono text-sm">${formatTimeSlot(t)}</th>`).join('')}</tr></thead><tbody>`;
                DAYS.forEach(day => {
                    allHtml += `<tr class="text-center"><td class="p-2 border font-semibold align-middle bg-gray-50">${day}</td>`;
                    let time_cursor = 0;
                    while (time_cursor < TIME_SLOTS_HOURLY.length) {
                        const time = TIME_SLOTS_HOURLY[time_cursor]; let cellData = null, foundLevel = null;
                        for (const levelName in savedSchedules) { const grid = savedSchedules[levelName]; const potentialCell = grid[day]?.[time]?.[item.name]; if (potentialCell && !potentialCell.isContinuation) { cellData = potentialCell; foundLevel = levelName; break; } }
                        if (cellData) { const duration = cellData.duration || 1; allHtml += `<td class="p-1 border align-top h-20" colspan="${duration}"><div class="schedule-item text-[11px]" style="background-color: ${courseColors[cellData.baseName] || '#e5e7eb'};"><p class="font-bold">${cellData.name} (${foundLevel})</p><p>${cellData.instructor}</p></div></td>`; time_cursor += duration; }
                        else { let isContinuationSlot = false; for (const levelName in savedSchedules) { if (savedSchedules[levelName][day]?.[time]?.[item.name]?.isContinuation) { isContinuationSlot = true; break; } } if (!isContinuationSlot) { allHtml += `<td class="p-1 border align-top h-20"></td>`; } time_cursor++; }
                    }
                    allHtml += `</tr>`;
                });
                allHtml += '</tbody></table></div>';
            });
            allHtml += '</div>'
            return allHtml;
        }

        function generateInstructorSchedulesHtml(searchQuery = '', filterCategory = 'all') {
            let filteredInstructors = instructors; if (searchQuery && typeof searchQuery === 'string') { filteredInstructors = filteredInstructors.filter(inst => inst.name.includes(searchQuery.trim())); } if (filterCategory !== 'all') { filteredInstructors = filteredInstructors.filter(inst => inst.category === filterCategory); }
            if (!filteredInstructors.length) return '<p class="text-center text-gray-500">لا يوجد أعضاء مطابقون لمعايير البحث.</p>';
            let allHtml = '';
            INSTRUCTOR_CATEGORIES.forEach(category => {
                const members = filteredInstructors.filter(inst => inst.category === category);
                if (members.length > 0) {
                    allHtml += `<h3 class="text-2xl font-bold text-center my-6 text-sky-700">${category}</h3>`;
                    members.forEach(instructor => {
                        let instructorGrid = {}; DAYS.forEach(d => { instructorGrid[d] = {}; TIME_SLOTS_HOURLY.forEach(t => instructorGrid[d][t] = null); });
                        for (const levelName in savedSchedules) { const grid = savedSchedules[levelName]; for (const day of DAYS) { for (const time of TIME_SLOTS_HOURLY) { for (const loc of locations) { const cell = grid[day]?.[time]?.[loc.name]; if (cell && cell.instructor === instructor.name) { for(let i=0; i < cell.duration; i++) { if (!instructorGrid[day][time+i]) { instructorGrid[day][time+i] = {...cell, type: 'course', location: loc.name, level: levelName, isContinuation: i > 0}; } } } } } } }
                        const customActivities = instructor.customActivities || {};
                        for (const key in customActivities) { const [day, timeStr] = key.split('-'); const time = parseInt(timeStr); const activity = customActivities[key]; for(let i=0; i<activity.duration; i++) { if(instructorGrid[day][time+i] === null) { instructorGrid[day][time+i] = {type: 'custom', text: activity.text, duration: activity.duration, isContinuation: i > 0}; } } }
                        
                        allHtml += `<div class="mb-10 bg-white p-4 sm:p-6 rounded-xl shadow-lg"> <h4 class="text-xl font-bold text-center mb-4 text-sky-600">${instructor.name}</h4> <h5 class="font-bold text-center text-md mb-2 text-gray-700">الجدول التفصيلي</h5> <table class="w-full text-sm text-center border-collapse"> <thead><tr class="bg-gray-100"> <th class="p-2 border">اليوم</th> ${TIME_SLOTS_HOURLY.map(t => `<th class="p-2 border font-mono">${formatTimeSlot(t)}</th>`).join('')} </tr></thead><tbody>`;
                        DAYS.forEach(day => {
                            allHtml += `<tr class="text-center"><td class="p-2 border font-semibold align-middle bg-gray-50">${day}</td>`; let time_cursor = 0;
                            while (time_cursor < TIME_SLOTS_HOURLY.length) {
                                const time = TIME_SLOTS_HOURLY[time_cursor]; const app = instructorGrid[day][time];
                                if (app && !app.isContinuation) {
                                    if (app.type === 'course') { allHtml += `<td class="p-1 border align-middle text-[10px]" colspan="${app.duration}" onclick="window.openScheduleItemModal('${app.id}', '${day}', ${time}, '${app.location}', '${app.level}')"> <div style="background-color: ${courseColors[app.baseName] || '#e5e7eb'};" class="p-1 rounded h-full cursor-pointer flex flex-col justify-center"> <p class="font-bold">${app.name}</p> <p>${app.level}</p> <p class="text-gray-700 font-semibold">${app.location}</p> </div> </td>`; }
                                    else { allHtml += `<td class="p-1 border align-middle text-[10px] empty-slot" colspan="${app.duration}" onclick="window.openCustomActivityModal('${instructor.id}', '${day}', ${time}, '${app.text}', ${app.duration})"> <div class="bg-gray-200 p-1 rounded h-full flex items-center justify-center"> <p class="font-bold">${app.text}</p> </div> </td>`; }
                                    time_cursor += app.duration;
                                } else if (!app) { allHtml += `<td class="p-2 border empty-slot" onclick="window.openCustomActivityModal('${instructor.id}', '${day}', ${time})"></td>`; time_cursor++; }
                                else { time_cursor++; }
                            }
                            allHtml += `</tr>`;
                        });
                        allHtml += `</tbody></table> ${generateMirrorTableHtml(instructor)} </div>`;
                    });
                }
            });
            return allHtml;
        }

        function generateMirrorTableHtml(instructor) {
            let theoreticalHours = 0;
            let practicalHours = 0;
            const summaryRows = [];

            const assignedCourses = courses.filter(c => c.instructor === instructor.name);
            assignedCourses.forEach(course => {
                const subject = subjects.find(s => s.name === course.baseName);
                const courseTheoretical = course.type === 'lecture' ? (course.duration || 0) : 0;
                const coursePractical = course.type !== 'lecture' ? (course.duration || 0) : 0;

                theoreticalHours += courseTheoretical;
                practicalHours += coursePractical;

                summaryRows.push(`
                    <tr class="border-b">
                        <td class="p-2 font-semibold">${course.name} (${subject?.academicLevel || 'غير محدد'})</td>
                        <td class="p-2 text-center">${courseTheoretical > 0 ? courseTheoretical : '-'}</td>
                        <td class="p-2 text-center">${coursePractical > 0 ? coursePractical : '-'}</td>
                    </tr>
                `);
            });

            const customActivities = instructor.customActivities || {};
            for (const key in customActivities) {
                const activity = customActivities[key];
                const activityPractical = activity.duration || 0;
                practicalHours += activityPractical;

                summaryRows.push(`
                    <tr class="border-b bg-gray-50">
                        <td class="p-2 font-semibold">${activity.text} (نشاط إضافي)</td>
                        <td class="p-2 text-center">-</td>
                        <td class="p-2 text-center">${activityPractical}</td>
                    </tr>
                `);
            }
            const totalHoursSummary = theoreticalHours + practicalHours;

            return `
            <div class="mt-6 p-4 bg-gray-50 border rounded-lg">
                <h5 class="font-bold text-center text-lg mb-4 text-gray-700">مرايا الجدول (ملخص النصاب)</h5>
                <table class="w-full text-sm text-right">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600">
                            <th class="p-2">المقرر / النشاط (الفرقة)</th>
                            <th class="p-2 text-center">ساعات نظري</th>
                            <th class="p-2 text-center">ساعات عملي</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${summaryRows.length > 0 ? summaryRows.join('') : `<tr><td colspan="3" class="text-center p-4 text-gray-500">لم يتم إسناد أي مهام لهذا العضو.</td></tr>`}
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-200 font-bold border-t-2 border-gray-300">
                            <td colspan="3" class="p-3 text-center text-md">
                                ${theoreticalHours} <span class="font-normal text-gray-600">نظري</span> + 
                                ${practicalHours} <span class="font-normal text-gray-600">عملي</span> = 
                                ${totalHoursSummary} <span class="font-normal text-gray-600">ساعة إجمالية</span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            `;
        }


        function addDragAndDropListeners(containerSelector) { document.querySelectorAll(`${containerSelector} .schedule-item[draggable="true"]`).forEach(item => item.addEventListener('dragstart', handleDragStart)); document.querySelectorAll(`${containerSelector} .drop-target`).forEach(target => { target.addEventListener('dragover', e => e.preventDefault()); target.addEventListener('dragenter', e => e.target.closest('.drop-target')?.classList.add('drag-over')); target.addEventListener('dragleave', e => e.target.closest('.drop-target')?.classList.remove('drag-over')); target.addEventListener('drop', handleDrop); }); }
        function handleDragStart(e) { draggedItem = e.target; setTimeout(() => { e.target.style.opacity = '0.5'; }, 0); }
        function handleDrop(e) {
            e.preventDefault(); if (!draggedItem) return;
            draggedItem.style.opacity = '1';
            const targetCell = e.target.closest('.drop-target'); if (!targetCell) return;
            targetCell.classList.remove('drag-over');
            const sourceInfo = { id: draggedItem.dataset.courseId, day: draggedItem.dataset.day, time: parseInt(draggedItem.dataset.time), location: draggedItem.dataset.location };
            const course = courses.find(c => c.id === sourceInfo.id); if (!course) return;
            const targetDay = targetCell.dataset.day; const targetTime = parseInt(targetCell.dataset.time);
            let tempGrid = JSON.parse(JSON.stringify(scheduleGrid));
            for (let i = 0; i < course.duration; i++) { if (tempGrid[sourceInfo.day]?.[sourceInfo.time + i]) { tempGrid[sourceInfo.day][sourceInfo.time + i][sourceInfo.location] = null; } }
            let tempInstructorSchedule = {};
            instructors.forEach(inst => { tempInstructorSchedule[inst.name] = {}; DAYS.forEach(day => { tempInstructorSchedule[inst.name][day] = {}; TIME_SLOTS_HOURLY.forEach(time => tempInstructorSchedule[inst.name][day][time] = false); }); });
            for (const day of DAYS) for (const time of TIME_SLOTS_HOURLY) for (const loc of locations) { const cellData = tempGrid[day]?.[time]?.[loc.name]; if (cellData) { tempInstructorSchedule[cellData.instructor][day][time] = true; } }
            const targetLocation = locations.find(loc => { if (loc.type !== course.requiredLocationType) return false; let isFree = true; for (let i = 0; i < course.duration; i++) { if ((tempGrid[targetDay]?.[targetTime + i]?.[loc.name])) { isFree = false; break; } } return isFree; });
            let instructorIsFree = true;
            for (let i = 0; i < course.duration; i++) { if (tempInstructorSchedule[course.instructor][targetDay][targetTime + i]) { instructorIsFree = false; break; } }
            if (targetLocation && instructorIsFree) {
                for (let i = 0; i < course.duration; i++) { if (scheduleGrid[sourceInfo.day]?.[sourceInfo.time + i]) { scheduleGrid[sourceInfo.day][sourceInfo.time + i][sourceInfo.location] = null; } }
                for (let i = 0; i < course.duration; i++) { scheduleGrid[targetDay][targetTime + i][targetLocation.name] = { ...course, isContinuation: i > 0 }; }
                saveScheduleToFirebase(dom.levelFilterSelect.value, scheduleGrid);
            } else { showToast("لا يمكن نقل المادة، قد يكون هناك تعارض.", "error"); }
        }
        function handleExportToFile() {
            const dataToSave = { levels, subjects, instructors, locations, courses, groups, savedSchedules };
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `schedule_backup.json`; a.click(); URL.revokeObjectURL(a.href);
        }
        async function handleLoadScheduleFromFile(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                await showConfirmModal("سيؤدي هذا إلى حذف جميع البيانات الحالية. هل أنت متأكد؟", async () => {
                    try {
                        await handleReset(false);
                        const data = JSON.parse(event.target.result);
                        const batch = writeBatch(db);
                        (data.levels || []).forEach(item => batch.set(doc(levelsCol), item));
                        (data.groups || []).forEach(item => batch.set(doc(groupsCol), item));
                        (data.subjects || []).forEach(item => batch.set(doc(subjectsCol), item));
                        (data.instructors || []).forEach(item => batch.set(doc(instructorsCol), item));
                        (data.locations || []).forEach(item => batch.set(doc(locationsCol), item));
                        (data.courses || []).forEach(item => batch.set(doc(coursesCol), item));
                        if (data.savedSchedules) { for (const level in data.savedSchedules) { batch.set(doc(schedulesCol, level), { grid: JSON.stringify(data.savedSchedules[level]) }); } }
                        await batch.commit();
                        showToast("تم استيراد البيانات بنجاح!");
                    } catch (error) { console.error("Error loading file:", error); showToast("ملف غير صالح.", "error"); }
                });
            };
            reader.readAsText(file); e.target.value = '';
        }
        async function handleReset(confirmed = true) {
            if(!confirmed) {
                const batch = writeBatch(db);
                const collections = [levelsCol, subjectsCol, instructorsCol, locationsCol, coursesCol, schedulesCol, groupsCol];
                for (const col of collections) { const snapshot = await getDocs(query(col)); snapshot.docs.forEach(doc => batch.delete(doc.ref)); }
                await batch.commit();
                return;
            }
            scheduleGrid = {}; savedSchedules = {};
            dom.scheduleOutput.innerHTML = ''; dom.unscheduledOutput.innerHTML = '';
            dom.customScheduleOutput.innerHTML = '';
            showToast("تم حذف جميع البيانات والبدء من جديد.");
        }
        function generateAdvancedLevelsHTML() {
            return ` <div class="bg-white p-6 rounded-xl shadow-lg"> <div class="flex justify-between items-center mb-6 border-b pb-4"> <h2 class="text-2xl font-bold text-gray-700">الإدارة المتقدمة للفرق الدراسية</h2> <button onclick="window.showMainView()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"> <i class="fas fa-arrow-left ml-2"></i>العودة للرئيسية </button> </div> <input type="text" id="adv-level-search" placeholder="ابحث عن فرقة..." class="w-full p-3 border rounded-md mb-6"> <div id="adv-levels-list" class="space-y-3"> ${levels.map(l => ` <div class="list-item flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm" data-id="${l.id}"> <p class="font-semibold text-md">${l.name}</p> <div class="flex items-center gap-2"> <button onclick="window.openEditModal('level', '${l.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pencil-alt fa-lg"></i></button> <button onclick="window.deleteItem('level', '${l.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash fa-lg"></i></button> </div> </div> `).join('')} </div> </div> `;
        }
        function renderAdvancedInstructorsView(searchQuery = '', filterCategory = 'all') {
            dom.advancedInstructorsView.innerHTML = generateAdvancedInstructorsHTML(searchQuery, filterCategory);
            document.getElementById('adv-instructor-search').addEventListener('input', (e) => { const currentCategory = document.querySelector('input[name="adv-category"]:checked').value; renderAdvancedInstructorsView(e.target.value, currentCategory); });
            document.querySelectorAll('input[name="adv-category"]').forEach(radio => { radio.addEventListener('change', (e) => { const currentSearch = document.getElementById('adv-instructor-search').value; renderAdvancedInstructorsView(currentSearch, e.target.value); }); });
            document.getElementById('adv-instructor-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('adv-instructor-name-input');
                const name = nameInput.value.trim();
                if (name && !instructors.some(i => i.name === name)) {
                    await handleAddWithLoading(e, instructorsCol, { name, category: document.getElementById('adv-instructor-category-select').value, availableTimes: {}, customActivities: {} }, "تمت إضافة العضو بنجاح!");
                } else { showToast("الاسم موجود بالفعل أو غير صالح.", "error"); }
            });
        }
        function getInstructorLoad(instructorName) {
            const assignedCourses = []; const countedCourses = new Set(); let totalHours = 0;
            for (const course of courses) {
                if (course.instructor === instructorName) {
                    const subject = subjects.find(s => s.name === course.baseName);
                    if (subject) {
                        const uniqueCourseId = course.id;
                        if (!countedCourses.has(uniqueCourseId)) {
                             assignedCourses.push({ name: course.name, level: subject.academicLevel, hours: course.duration });
                            totalHours += course.duration;
                            countedCourses.add(uniqueCourseId);
                        }
                    }
                }
            }
            return { courses: assignedCourses, totalHours };
        }
        function generateAdvancedInstructorsHTML(searchQuery = '', filterCategory = 'all') {
            let filteredInstructors = instructors; if (searchQuery && typeof searchQuery === 'string') { filteredInstructors = filteredInstructors.filter(inst => inst.name.includes(searchQuery.trim())); } if (filterCategory !== 'all') { filteredInstructors = filteredInstructors.filter(inst => inst.category === filterCategory); }
            return ` <div class="bg-white p-6 rounded-xl shadow-lg"> <div class="flex justify-between items-center mb-6 border-b pb-4"> <h2 class="text-2xl font-bold text-gray-700">الإدارة المتقدمة للأعضاء</h2> <button onclick="window.showMainView()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"> <i class="fas fa-arrow-left ml-2"></i>العودة للرئيسية </button> </div> <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"> <div class="md:col-span-2"> <form id="adv-instructor-form" class="p-4 border rounded-lg bg-gray-50 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end"> <div class="sm:col-span-2 grid grid-cols-2 gap-4"> <div> <label class="font-bold text-sm">اسم العضو الجديد</label> <input type="text" id="adv-instructor-name-input" placeholder="اسم العضو" class="w-full p-2 border rounded-md mt-1" required> </div> <div> <label class="font-bold text-sm">الفئة</label> <select id="adv-instructor-category-select" class="w-full p-2 border rounded-md mt-1"> ${INSTRUCTOR_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')} </select> </div> </div> <button type="submit" class="w-full bg-sky-500 text-white font-bold py-2 rounded-md hover:bg-sky-600 h-10 flex items-center justify-center">إضافة عضو</button> </form> </div> <div class="p-4 border rounded-lg bg-gray-50"> <label class="font-bold text-sm">ابحث بالاسم...</label> <input type="text" id="adv-instructor-search" placeholder="بحث..." class="w-full p-2 border rounded-md mt-1" value="${searchQuery}"> </div> </div> <div class="mb-6 flex flex-wrap gap-4 justify-center"> <label class="flex items-center"><input type="radio" name="adv-category" value="all" class="ml-2" ${filterCategory === 'all' ? 'checked' : ''}> الكل</label> ${INSTRUCTOR_CATEGORIES.map(cat => `<label class="flex items-center"><input type="radio" name="adv-category" value="${cat}" class="ml-2" ${filterCategory === cat ? 'checked' : ''}> ${cat}</label>`).join('')} </div> <div id="adv-instructors-list" class="space-y-4"> ${filteredInstructors.length ? filteredInstructors.map(instructor => { const load = getInstructorLoad(instructor.name); return ` <div class="border rounded-lg overflow-hidden shadow-sm"> <div class="p-4 bg-gray-50 flex justify-between items-center"> <div> <h4 class="font-bold text-lg">${instructor.name}</h4> <p class="text-sm text-gray-500">${instructor.category}</p> </div> <div class="flex items-center gap-2"> <button onclick="window.openEditModal('instructor', '${instructor.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pencil-alt fa-lg"></i></button> <button onclick="window.deleteItem('instructor', '${instructor.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash fa-lg"></i></button> </div> </div> <div class="p-4"> <h5 class="font-bold text-md mb-2 text-gray-700">المقررات المسندة:</h5> ${load.courses.length ? ` <table class="w-full text-sm text-right"> <thead class="bg-gray-100 text-gray-600"> <tr> <th class="p-2">اسم المقرر</th> <th class="p-2">الفرقة</th> </tr> </thead> <tbody> ${load.courses.map(c => ` <tr class="border-b"> <td class="p-2 font-semibold">${c.name}</td> <td class="p-2">${c.level}</td> </tr> `).join('')} </tbody> <tfoot> <tr class="font-bold bg-gray-50 border-t"> <td class="p-2">الإجمالي</td> <td class="p-2">${load.totalHours} ساعة</td> </tr> </tfoot> </table> ` : '<p class="text-center text-gray-500">لم يتم إسناد أي مقررات لهذا العضو بعد.</p>'} </div> </div> `; }).join('') : '<p class="text-center text-gray-500 mt-8">لا يوجد أعضاء مطابقون لمعايير البحث.</p>'} </div> </div> `;
        }
        function formatTimeSlot(startHour, duration = 1) { const endHour = startHour + duration; const format12 = (hour) => { const ampm = hour >= 12 && hour < 24 ? 'م' : 'ص'; const h = hour % 12 || 12; return `${h} ${ampm}`; }; if (duration === 1) { return `${format12(startHour)} - ${format12(endHour)}`; } return `${format12(startHour)} - ${format12(endHour)}`; }
        function generateHslColor(str, asHex = false) {
            let hash = 0; if (!str) return asHex ? '#e5e7eb' : 'hsl(0, 0%, 90%)';
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            const h = hash % 360; const s = 75; const l = 85;
            if (asHex) { let s_norm = s / 100; let l_norm = l / 100; let c = (1 - Math.abs(2 * l_norm - 1)) * s_norm, x = c * (1 - Math.abs((h / 60) % 2 - 1)), m = l_norm - c/2, r = 0, g = 0, b = 0; if (0 <= h && h < 60) { r = c; g = x; b = 0; } else if (60 <= h && h < 120) { r = x; g = c; b = 0; } else if (120 <= h && h < 180) { r = 0; g = c; b = x; } else if (180 <= h && h < 240) { r = 0; g = x; b = c; } else if (240 <= h && h < 300) { r = x; g = 0; b = c; } else if (300 <= h && h < 360) { r = c; g = 0; b = x; } r = Math.round((r + m) * 255).toString(16); g = Math.round((g + m) * 255).toString(16); b = Math.round((b + m) * 255).toString(16); if (r.length == 1) r = "0" + r; if (g.length == 1) g = "0" + g; if (b.length == 1) b = "0" + b; return `#${r}${g}${b}`; }
            return `hsl(${h}, ${s}%, ${l}%)`;
        }
    </script>
</body>
</html>

