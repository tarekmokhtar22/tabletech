<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الجداول الرائع جداً (نسخة مطورة)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* General Styles */
        body, html {
			height: 100%;
			font-family: 'Cairo', sans-serif;
            scroll-behavior: smooth;
		}

        .hidden {
            display: none;
        }

        /* Login Page Styles */
		.container-login {
			width: 100%;
			min-height: 100vh;
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			align-items: center;
			padding: 15px;
			background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #3a6186, #89253e);
			background-size: 400% 400%;
			animation: gradientAnimation 15s ease infinite;
		}
		@keyframes gradientAnimation {
			0% { background-position: 0% 50%; }
			50% { background-position: 100% 50%; }
			100% { background-position: 0% 50%; }
		}
		.wrap-login {
			width: 400px;
			background: rgba(255, 255, 255, 0.95);
			border-radius: 20px;
			overflow: hidden;
			padding: 60px 55px 40px 55px;
			box-shadow: 0 10px 30px 0px rgba(0, 0, 0, 0.2);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			transition: height 0.3s ease-in-out;
		}
		.login-form-title {
			display: block;
			font-size: 32px;
			color: #333333;
			line-height: 1.2;
			text-align: center;
			padding-bottom: 40px;
			font-weight: 700;
		}
		.wrap-input {
			position: relative;
			width: 100%;
			z-index: 1;
			margin-bottom: 15px;
			transition: opacity 0.5s, max-height 0.5s, margin 0.5s, padding 0.5s;
			overflow: hidden;
			max-height: 65px;
		}
        .wrap-input.hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            pointer-events: none;
        }
		.input {
			font-size: 16px;
			line-height: 1.5;
			color: #555;
			display: block;
			width: 100%;
			background: #e6e6e6;
			height: 50px;
			border-radius: 25px;
			padding: 0 30px 0 68px;
			outline: none;
			border: none;
		}
		.focus-input {
			display: block;
			position: absolute;
			border-radius: 25px;
			bottom: 0;
			left: 0;
			z-index: -1;
			width: 100%;
			height: 100%;
			box-shadow: 0px 0px 0px 0px;
			color: rgba(147, 112, 219, 0.8);
		}
		.input:focus + .focus-input {
			animation: anim-shadow 0.5s ease-in-out forwards;
		}
		@keyframes anim-shadow { to { box-shadow: 0px 0px 70px 25px; opacity: 0; } }
		.symbol-input {
			font-size: 16px;
			display: flex;
			align-items: center;
			position: absolute;
			border-radius: 25px;
			bottom: 0;
			left: 0;
			width: 100%;
			height: 100%;
			padding-left: 35px;
			pointer-events: none;
			color: #666666;
			transition: all 0.4s;
		}
		.input:focus ~ .symbol-input { color: #8a2be2; }
		.container-login-form-btn {
			width: 100%;
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			padding-top: 10px;
		}
		.login-form-btn {
			font-size: 16px;
			font-weight: 700;
			line-height: 1.5;
			color: #fff;
			text-transform: uppercase;
			width: 100%;
			height: 50px;
			border-radius: 25px;
			background: #8e44ad;
			background: -webkit-linear-gradient(right, #8e44ad, #4a00e0);
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 0 25px;
			transition: all 0.4s;
			border: none;
			cursor: pointer;
		}
		.login-form-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.2);
		}
		#error-message {
			color: #dc3545;
			text-align: center;
			font-size: 14px;
			height: 20px;
			transition: opacity 0.3s;
            margin-top: 10px;
		}
		.guest-toggle { text-align: center; padding: 15px 0 5px 0; }
		.guest-toggle-link {
			font-size: 14px;
			color: #666666;
			text-decoration: none;
			transition: color 0.3s;
			cursor: pointer;
		}
		.guest-toggle-link:hover { color: #8e44ad; text-decoration: underline; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Main App Styles */
        .schedule-item { padding: 4px; border-radius: 6px; margin-bottom: 4px; cursor: pointer; transition: all 0.2s; color: #1f2937; box-shadow: 0 2px 4px rgba(0,0,0,0.05); line-height: 1.3; position: relative; border: 2px solid transparent; }
        .schedule-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .schedule-item[draggable="true"]:active { cursor: grabbing; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: scale(1.05); }
        .drop-target { display: flex; flex-direction: column; gap: 2px; min-height: 50px; border-radius: 6px; transition: background-color 0.2s; }
        .drag-over { background-color: #dcfce7; border: 2px dashed #4ade80; }
        .session-lab { padding: 2px 4px; font-size: 10px; line-height: 1.2; border-left: 4px solid #14b8a6 !important; }
        .conflict-item-visual { border-color: #ef4444 !important; animation: pulse-red 2s infinite; }
        .conflict-badge { position: absolute; top: 2px; left: 2px; background-color: #ef4444; color: white; font-size: 10px; padding: 1px 5px; border-radius: 99px; font-weight: bold; z-index: 10; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { box-shadow: 0 0 0 5px rgba(239, 68, 68, 0); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 24px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
        .close-button { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
        .empty-slot { cursor: pointer; position: relative; }
        .empty-slot:hover { background-color: #f0f9ff; }
        .add-concurrent-btn { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; border-radius: 50%; background-color: rgba(4, 120, 87, 0.7); color: white; display: none; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; z-index: 10; }
        .occupied-slot:hover .add-concurrent-btn { display: flex; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: transparent; width: 100%; height: 40px; border: 1px solid #ccc; border-radius: 0.375rem; cursor: pointer; padding: 2px; }
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: none; }
        input[type="color"]::-moz-color-swatch { border-radius: 4px; border: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .list-item { transition: all 0.4s ease-in-out; }
        .list-item.fade-out { opacity: 0; transform: scale(0.9); }
        .list-item.fade-in { animation: fadeIn 0.5s; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 2000; }
        .toast { padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: white; font-weight: 600; margin-bottom: 10px; animation: slideIn 0.5s, fadeOut 0.5s 3.5s; opacity: 0; animation-fill-mode: forwards; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 16px; height: 16px; animation: spin 1s ease-in-out infinite; margin-right: 8px;}
        @keyframes spin { to { transform: rotate(360deg); } }
        .list-item .control-buttons { opacity: 0; transition: opacity 0.2s; }
        .list-item:hover .control-buttons { opacity: 1; }
        .table-container { position: relative; }
        .copy-btn { position: absolute; top: 10px; left: 10px; background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 9999px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; z-index: 10; }
        .copy-btn:hover { background-color: #e5e7eb; transform: scale(1.1); }
        table, .schedule-item { user-select: text; -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; }

        /* Read-only styles for guest mode */
        #app-section.read-only #top-controls,
        #app-section.read-only form,
        #app-section.read-only .control-buttons,
        #app-section.read-only .fa-cog,
        #app-section.read-only #generate-btn,
        #app-section.read-only #reset-btn,
        #app-section.read-only #load-btn,
        #app-section.read-only #show-conflicts-btn,
        #app-section.read-only #export-btn,
        #app-section.read-only #print-btn,
        #app-section.read-only #refresh-btn {
            display: none !important;
        }

        #app-section.read-only .schedule-item,
        #app-section.read-only .empty-slot {
            cursor: default !important;
        }
        
        #app-section.read-only .list-item:hover .control-buttons {
            opacity: 0 !important;
        }


        @media print {
            body * { visibility: hidden; }
            #schedule-output-container, #schedule-output-container *, #custom-views-container, #custom-views-container * { visibility: visible; }
            #schedule-output-container, #custom-views-container { position: absolute; left: 0; top: 0; width: 100%; }
            .schedule-item { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            h2, h3 { text-align: center; margin-bottom: 20px; }
            #members-view-sidebar { display: none; }
            .conflict-badge, .control-buttons, .print-hidden, footer, #top-controls, .copy-btn { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="login-section">
        <div class="container-login">
            <div class="wrap-login">
                <form class="login-form" id="loginForm">
                    <span class="login-form-title">
                        تسجيل الدخول
                    </span>
    
                    <!-- Username Input -->
                    <div class="wrap-input" id="username-wrapper">
                        <input class="input" type="text" name="username" id="usernameInput" placeholder="اسم المستخدم">
                        <span class="focus-input"></span>
                        <span class="symbol-input">
                            <i class="fa fa-user" aria-hidden="true"></i>
                        </span>
                    </div>
    
                    <!-- Password Input -->
                    <div class="wrap-input">
                        <input class="input" type="password" name="pass" id="passwordInput" placeholder="كلمة المرور">
                        <span class="focus-input"></span>
                        <span class="symbol-input">
                            <i class="fa fa-lock" aria-hidden="true"></i>
                        </span>
                    </div>
                    
                    <!-- Guest Toggle Link -->
                    <div class="guest-toggle">
                        <a id="guest-login-toggle" class="guest-toggle-link">دخول كضيف</a>
                    </div>
    
                    <div id="error-message"></div>
    
                    <!-- Login Button -->
                    <div class="container-login-form-btn">
                        <button type="submit" class="login-form-btn">
                            دخول
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="app-section" class="hidden">
        <div id="toast-container"></div>
        <div class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-8 relative">
                <button id="logout-btn" class="absolute top-0 left-0 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 shadow-lg transition-transform hover:scale-105"><i class="fas fa-sign-out-alt mr-2"></i>تسجيل الخروج</button>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-700">الجداول الرائع جداً</h1>
                <p class="text-gray-500 mt-2">مع الحفظ السحابي، الفرق الدراسية، التعديل اليداوي و الي مش يداوي، كشف التضارب و الخناقات, الخ...</p>
            </header>
    
            <div id="loading-indicator" class="text-center p-8"> <i class="fas fa-spinner fa-spin fa-3x text-sky-500"></i> <p class="mt-4 text-gray-600">جاري تحميل البيانات...</p> </div>
    
            <div id="main-content" class="hidden">
                <!-- New Top Controls Panel -->
                <div id="top-controls" class="bg-white p-4 rounded-xl shadow-md mb-8 print-hidden">
                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer">
                            <h2 class="text-xl font-bold text-gray-600">إدارة البيانات الأساسية والإعدادات</h2>
                            <span class="transition-transform duration-300 group-open:rotate-180">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                        </summary>
                        <div class="text-neutral-600 mt-4 pt-4 border-t">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                
                                <div class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-600 flex justify-between items-center">
                                            <span>1. الفرق الدراسية</span>
                                            <a href="#" onclick="window.showAdvancedLevelsView()" class="text-gray-400 hover:text-sky-500"><i class="fas fa-cog"></i></a>
                                        </h3>
                                        <form id="level-form" class="flex gap-2 mt-2">
                                            <input type="text" id="level-name" placeholder="اسم الفرقة" class="w-full p-2 border rounded-md" required>
                                            <button type="submit" class="bg-green-500 text-white font-bold p-2 px-4 rounded-md hover:bg-green-600 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                                        </form>
                                        <div id="levels-list" class="mt-2 space-y-2 max-h-24 overflow-y-auto"></div>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-600">2. المجموعات</h3>
                                        <form id="group-form" class="space-y-2 mt-2">
                                            <select id="group-level-select" class="w-full p-2 border rounded-md" required><option value="">اختر الفرقة أولاً...</option></select>
                                            <div class="flex gap-2">
                                                <input type="text" id="group-name" placeholder="اسم المجموعة" class="w-full p-2 border rounded-md" required>
                                                <button type="submit" class="bg-teal-500 text-white font-bold p-2 px-4 rounded-md hover:bg-teal-600 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                                            </div>
                                        </form>
                                        <div id="groups-list" class="mt-2 space-y-2 max-h-24 overflow-y-auto"></div>
                                    </div>
                                </div>
    
                                <div class="bg-gray-50 p-4 rounded-lg border">
                                    <h3 class="text-lg font-bold text-gray-600">3. المواد الدراسية</h3>
                                    <form id="subject-form" class="space-y-2 mt-2">
                                        <select id="subject-level-select" class="w-full p-2 border rounded-md" required><option value="">اختر الفرقة أولاً...</option></select>
                                        <div class="flex gap-2">
                                            <input type="text" id="subject-name" placeholder="اسم المادة" class="w-full p-2 border rounded-md" required>
                                            <button type="submit" class="bg-purple-500 text-white font-bold p-2 px-4 rounded-md hover:bg-purple-600 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                                        </div>
                                    </form>
                                    <div id="subjects-list" class="mt-2 space-y-2 max-h-48 overflow-y-auto"></div>
                                </div>
    
                                <div class="bg-gray-50 p-4 rounded-lg border">
                                     <h3 class="text-lg font-bold text-gray-600 flex justify-between items-center">
                                        <span>4. الأعضاء</span>
                                        <a href="#" onclick="window.showAdvancedInstructorsView()" class="text-gray-400 hover:text-sky-500"><i class="fas fa-cog"></i></a>
                                    </h3>
                                    <form id="instructor-form" class="space-y-2 mt-2">
                                        <input type="text" id="instructor-name-input" placeholder="اسم العضو" class="w-full p-2 border rounded-md" required>
                                        <select id="instructor-category-select" class="w-full p-2 border rounded-md">
                                            <option value="عضو هيئة تدريس">عضو هيئة تدريس</option> <option value="معاونون">معاونون</option> <option value="منتدبون">منتدبون</option> <option value="اعضاء من الخارج">اعضاء من الخارج</option>
                                        </select>
                                        <button type="submit" class="w-full bg-sky-500 text-white font-bold py-2 rounded-md hover:bg-sky-600 flex items-center justify-center">إضافة عضو</button>
                                    </form>
                                    <div id="instructors-list" class="mt-2 space-y-2 max-h-48 overflow-y-auto"></div>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg border">
                                    <h3 class="text-lg font-bold text-gray-600">5. الأماكن</h3>
                                    <form id="location-form" class="space-y-2 mt-2">
                                        <input type="text" id="location-name" placeholder="اسم المكان" class="w-full p-2 border rounded-md" required>
                                        <select id="location-type" class="w-full p-2 border rounded-md">
                                            <option value="قاعة">قاعة</option> <option value="معمل">معمل</option> <option value="مدرج">مدرج</option>
                                        </select>
                                        <button type="submit" class="w-full bg-cyan-500 text-white font-bold py-2 rounded-md hover:bg-cyan-600 flex items-center justify-center">إضافة المكان</button>
                                    </form>
                                    <div id="locations-list" class="mt-2 space-y-2 max-h-24 overflow-y-auto"></div>
                                </div>
    
                            </div>
                        </div>
                    </details>
                </div>
                
                <div class="text-center my-8 flex flex-wrap justify-center items-center gap-4 print-hidden">
                    <button id="generate-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-sync-alt mr-2"></i>تحديث الجدول</button>
                    <button id="locations-view-btn" class="bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-800 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-university mr-2"></i>جداول الأماكن</button>
                    <button id="filter-members-btn" class="bg-blue-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-users mr-2"></i>جداول الأعضاء</button>
                    <button id="show-conflicts-btn" class="bg-red-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-800 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-exclamation-triangle mr-2"></i>عرض التعارضات</button>
                    <button id="export-report-btn" class="bg-purple-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-file-invoice mr-2"></i>تصدير تقرير (HTML)</button>
                    <button id="save-backup-btn" class="bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-save mr-2"></i>حفظ نسخة احتياطية (JSON)</button>
                    <button id="load-btn" class="bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-file-import mr-2"></i>استيراد</button>
                    <button id="print-btn" class="bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-print mr-2"></i>طباعة</button>
                    <button id="refresh-btn" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-redo-alt mr-2"></i>تحديث الصفحة</button>
                    <button id="reset-btn" class="bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 text-lg shadow-lg transition-transform hover:scale-105"><i class="fas fa-trash-alt mr-2"></i>جديد</button>
                    <input type="file" id="file-loader" class="hidden" accept=".json">
                </div>
                
                <div class="bg-white p-4 rounded-xl shadow-md mb-8 flex items-center gap-4">
                    <label for="level-filter-select" class="font-bold text-gray-600">عرض جدول:</label>
                    <select id="level-filter-select" class="w-full p-2 border rounded-md text-xl font-bold"></select>
                </div>
                
                <div id="summary-table-container" class="my-6"></div>
                <div id="unscheduled-output" class="my-6"></div>
                <div id="conflict-output" class="my-6"></div>
    
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-600">إضافة محاضرة / سكشن</h2>
                            <form id="course-form" class="space-y-4">
                                <select id="course-name-select" class="w-full p-2 border rounded-md" required><option value="">اختر الفرقة الرئيسية أولاً...</option></select>
                                <select id="instructor-select" class="w-full p-2 border rounded-md" required><option value="">اختر العضو...</option></select>
                                <select id="location-type-select" class="w-full p-2 border rounded-md" required><option value="">نوع المكان...</option><option value="قاعة">قاعة</option><option value="معمل">معمل</option><option value="مدرج">مدرج</option></select>
                                <select id="session-type" class="w-full p-2 border rounded-md"> <option value="lecture">محاضرة</option> <option value="lab">سكشن</option> </select>
                                
                                <div id="group-select-container">
                                    <label class="font-bold text-sm text-gray-600">المجموعة (اختياري)</label>
                                    <select id="course-group-select" class="w-full p-2 border rounded-md"><option value="">اختر المجموعة...</option></select>
                                </div>
    
                                <input type="number" id="sections-count" placeholder="العدد" class="w-full p-2 border rounded-md" min="1" value="1" required>
                                <div>
                                    <label for="duration" class="font-bold text-sm text-gray-600">المدة بالساعات</label>
                                    <input type="number" id="duration" class="w-full p-2 border rounded-md" min="1" value="2" required>
                                </div>
                                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center justify-center">إضافة للجدول</button>
                            </form>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-600">قائمة المحاضرات والسكاشن</h2>
                             <div class="flex border-b mb-4">
                                <button id="filter-all-btn" class="flex-1 p-2 text-center font-semibold border-b-2 border-sky-500 text-sky-600">الكل</button>
                                <button id="filter-lectures-btn" class="flex-1 p-2 text-center font-semibold text-gray-500">محاضرات</button>
                                <button id="filter-labs-btn" class="flex-1 p-2 text-center font-semibold text-gray-500">سكاشن</button>
                            </div>
                            <div id="courses-list-container" class="space-y-2 max-h-[calc(100vh-450px)] overflow-y-auto">
                                <div id="courses-list-all"></div>
                                <div id="courses-list-lectures" class="hidden"></div>
                                <div id="courses-list-labs" class="hidden"></div>
                            </div>
                        </div>
                    </div>
    
                    <div class="lg:col-span-2">
                        <div id="schedule-output-container" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg min-w-full overflow-x-auto h-full">
                            <div id="schedule-output"></div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Advanced Views -->
            <div id="advanced-levels-view" class="hidden"></div>
            <div id="advanced-instructors-view" class="hidden"></div>
        </div>
        
        <div id="custom-views-container" class="container mx-auto p-4 md:p-8">
            <div class="flex justify-between items-center mb-6 print-hidden">
                <button id="hide-custom-view-btn" class="hidden bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">
                    <i class="fas fa-eye-slash mr-2"></i>إخفاء الجداول الإضافية
                </button>
                <button id="refresh-custom-view-btn" class="hidden bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600">
                    <i class="fas fa-sync-alt mr-2"></i>تحديث البيانات
                </button>
            </div>
            <div id="custom-schedule-output" class="mt-8 space-y-12"></div>
        </div>
    
        <!-- Modals -->
        <div id="confirm-modal" class="modal">
            <div class="modal-content">
                <h3 id="confirm-modal-title" class="text-lg font-bold mb-4">تأكيد الإجراء</h3>
                <p id="confirm-modal-text" class="mb-6"></p>
                <div id="confirm-modal-details" class="mb-4 text-sm text-gray-600 max-h-40 overflow-y-auto"></div>
                <div class="flex justify-end gap-4">
                    <button id="confirm-modal-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">إلغاء</button>
                    <button id="confirm-modal-confirm-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">تأكيد الحذف</button>
                </div>
            </div>
        </div>
        <div id="edit-modal" class="modal"> <div class="modal-content"> <span id="close-edit-modal-btn" class="close-button">&times;</span> <h3 id="edit-modal-title" class="text-lg font-bold mb-4"></h3> <div class="space-y-4"> <input type="text" id="edit-modal-input" class="w-full p-2 border rounded-md"> <button id="edit-modal-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ</button> </div> </div> </div>
        <div id="availability-modal" class="modal"> <div class="modal-content"> <span id="close-availability-modal-btn" class="close-button">&times;</span> <h3 id="availability-modal-title" class="text-lg font-bold mb-4"></h3> <p class="text-sm text-gray-500 mb-4">حدد الساعات المتاحة.</p> <div id="availability-grid" class="space-y-2"></div> <button id="availability-modal-save-btn" class="w-full mt-4 bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ</button> </div> </div>
        
        <div id="course-edit-modal" class="modal">
            <div class="modal-content">
                <span id="close-course-edit-modal-btn" class="close-button">&times;</span>
                <h3 id="course-edit-modal-title" class="text-lg font-bold mb-4">تعديل بيانات المقرر</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold text-sm text-gray-600">اسم المقرر (المادة الأساسية)</label>
                        <input type="text" id="course-edit-subject-name-input" class="w-full p-2 border rounded-md">
                    </div>
                    <div id="course-edit-section-name-container" class="hidden">
                         <label class="font-bold text-sm text-gray-600">اسم السكشن المحدد</label>
                         <input type="text" id="course-edit-section-name-input" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">العضو</label>
                        <select id="course-edit-instructor-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                     <div id="course-edit-group-select-container">
                        <label class="font-bold text-sm text-gray-600">المجموعة (اختياري)</label>
                        <select id="course-edit-group-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">نوع المكان</label>
                        <select id="course-edit-location-type-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">المكان</label>
                        <select id="course-edit-location-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                     <div>
                        <label class="font-bold text-sm text-gray-600">اللون</label>
                        <input type="color" id="course-edit-color-input" class="w-full p-1 h-10 border rounded-md">
                    </div>
                    <button id="course-edit-modal-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ التعديلات</button>
                    <button id="course-edit-modal-delete-btn" class="w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600 mt-2">حذف المقرر نهائياً</button>
                    <button id="course-edit-modal-split-btn" class="w-full bg-yellow-500 text-white font-bold py-2 rounded-md hover:bg-yellow-600 mt-2 hidden">فصل المقرر</button>
                    <button id="course-edit-modal-merge-btn" class="w-full bg-blue-500 text-white font-bold py-2 rounded-md hover:bg-blue-600 mt-2 hidden">دمج المقرر</button>
    
                </div>
            </div>
        </div>
    
        <div id="location-edit-modal" class="modal">
            <div class="modal-content">
                <span id="close-location-edit-modal-btn" class="close-button">&times;</span>
                <h3 class="text-lg font-bold mb-4">تعديل المكان</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold text-sm text-gray-600">اسم المكان</label>
                        <input type="text" id="location-edit-name-input" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">نوع المكان</label>
                        <select id="location-edit-type-select" class="w-full p-2 border rounded-md">
                            <option value="قاعة">قاعة</option>
                            <option value="معمل">معمل</option>
                            <option value="مدرج">مدرج</option>
                        </select>
                    </div>
                    <button id="location-edit-modal-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ التعديلات</button>
                </div>
            </div>
        </div>
    
        <div id="custom-activity-modal" class="modal">
            <div class="modal-content">
                <span id="close-custom-activity-modal-btn" class="close-button">&times;</span>
                <h3 id="custom-activity-modal-title" class="text-lg font-bold mb-4">إضافة نشاط مخصص</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold">النشاط:</label>
                        <input type="text" id="custom-activity-text" class="w-full p-2 border rounded-md" placeholder="مثال: إشراف ماجستير">
                    </div>
                    <div>
                        <label class="font-bold">المدة بالساعات:</label>
                        <input type="number" id="custom-activity-duration" class="w-full p-2 border rounded-md" min="1" value="1">
                    </div>
                     <div>
                        <label class="font-bold">المكان (إختياري):</label>
                        <select id="custom-activity-location" class="w-full p-2 border rounded-md">
                            <option value="">(بدون مكان)</option>
                        </select>
                    </div>
                    <button id="custom-activity-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ النشاط</button>
                    <button id="custom-activity-delete-btn" class="w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600 mt-2 hidden">حذف النشاط</button>
                </div>
            </div>
        </div>
        
        <!-- New Modal for Level-Specific Activities -->
        <div id="level-activity-modal" class="modal">
            <div class="modal-content">
                <span id="close-level-activity-modal-btn" class="close-button">&times;</span>
                <h3 id="level-activity-modal-title" class="text-lg font-bold mb-4">إضافة نشاط للجدول</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold text-sm text-gray-600">اسم النشاط</label>
                        <input type="text" id="level-activity-name-input" class="w-full p-2 border rounded-md" placeholder="مشروع تخرج، سيمنار...">
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">العضو المسؤول (اختياري)</label>
                        <select id="level-activity-instructor-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">المكان</label>
                        <select id="level-activity-location-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">المدة بالساعات</label>
                        <input type="number" id="level-activity-duration-input" class="w-full p-2 border rounded-md" min="1" value="1">
                    </div>
                     <div>
                        <label class="font-bold text-sm text-gray-600">اللون</label>
                        <input type="color" id="level-activity-color-input" class="w-full p-1 h-10 border rounded-md" value="#a7f3d0">
                    </div>
                    <button id="level-activity-modal-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ النشاط</button>
                </div>
            </div>
        </div>

        <div id="location-activity-modal" class="modal">
            <div class="modal-content">
                <span id="close-location-activity-modal-btn" class="close-button">&times;</span>
                <h3 id="location-activity-modal-title" class="text-lg font-bold mb-4">إضافة نشاط للمكان</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold text-sm text-gray-600">الفرقة الدراسية (اختياري)</label>
                        <select id="location-activity-level-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">اسم النشاط</label>
                        <input type="text" id="location-activity-name-input" class="w-full p-2 border rounded-md" placeholder="مشروع تخرج، سيمنار...">
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">العضو المسؤول (اختياري)</label>
                        <select id="location-activity-instructor-select" class="w-full p-2 border rounded-md"></select>
                    </div>
                    <div>
                        <label class="font-bold text-sm text-gray-600">المدة بالساعات</label>
                        <input type="number" id="location-activity-duration-input" class="w-full p-2 border rounded-md" min="1" value="1">
                    </div>
                     <div>
                        <label class="font-bold text-sm text-gray-600">اللون</label>
                        <input type="color" id="location-activity-color-input" class="w-full p-1 h-10 border rounded-md" value="#a7f3d0">
                    </div>
                    <button id="location-activity-modal-save-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">حفظ النشاط</button>
                </div>
            </div>
        </div>
    
    
        <footer class="text-center p-4 mt-8 text-sm text-gray-500 border-t">
            <p>جميع الحقوق محفوظة لدى قسم تكنولوجيا التعليم</p>
            <p>أ.م.د/ نهى علي سيد عبد المحسن & أ/ طارق محمد مختار</p>
            <p>2025-2026</p>
        </footer>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, writeBatch, query, getDocs, setDoc, getDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let userRole = localStorage.getItem('userRole'); // 'admin' or 'guest'

        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        
        if (userRole) {
            showApp();
        }

        // --- LOGIN LOGIC ---
        const loginForm = document.getElementById('loginForm');
		const usernameWrapper = document.getElementById('username-wrapper');
		const usernameInput = document.getElementById('usernameInput');
		const passwordInput = document.getElementById('passwordInput');
		const errorMessage = document.getElementById('error-message');
		const guestLoginToggle = document.getElementById('guest-login-toggle');
		const loginFormTitle = document.querySelector('.login-form-title');
        let isGuestMode = false;

        function showApp() {
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            if (userRole === 'guest') {
                appSection.classList.add('read-only');
            }
            initializeMainApp(); 
        }

		guestLoginToggle.addEventListener('click', function(e) {
			e.preventDefault();
			isGuestMode = !isGuestMode;
			usernameInput.value = '';
			passwordInput.value = '';
			errorMessage.textContent = '';

			if (isGuestMode) {
				usernameWrapper.classList.add('hidden');
				passwordInput.placeholder = 'كلمة سر الضيف';
				guestLoginToggle.textContent = 'تسجيل دخول المستخدم';
				loginFormTitle.textContent = 'دخول الضيف';
			} else {
				usernameWrapper.classList.remove('hidden');
				passwordInput.placeholder = 'كلمة المرور';
				guestLoginToggle.textContent = 'دخول كضيف';
				loginFormTitle.textContent = 'تسجيل الدخول';
			}
		});

        loginForm.addEventListener('submit', function(e) {
			e.preventDefault();
			const enteredPassword = passwordInput.value;
			let isLoginSuccessful = false;

			if (isGuestMode) {
				if (enteredPassword === '2392') {
                    userRole = 'guest';
					isLoginSuccessful = true;
				} else {
					errorMessage.textContent = 'كلمة سر الضيف غير صحيحة.';
				}
			} else {
				const enteredUsername = usernameInput.value;
				if (enteredUsername.toLowerCase() === 'noha' && enteredPassword === 'BossX@786') {
                    userRole = 'admin';
					isLoginSuccessful = true;
				} else {
					errorMessage.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
				}
			}

			if (isLoginSuccessful) {
				errorMessage.textContent = '';
                localStorage.setItem('userRole', userRole);
                showApp();
			} else {
				const wrapLogin = document.querySelector('.wrap-login');
				wrapLogin.style.animation = 'shake 0.5s';
				setTimeout(() => {
					wrapLogin.style.animation = '';
				}, 500);
			}
		});
        
        // --- MAIN APP LOGIC ---
        let subjects = [], instructors = [], locations = [], courses = [], levels = [], groups = [];
        let courseColors = {}, scheduleGrid = {};
        let savedSchedules = {};
        let activeCustomView = null;
        let showConflicts = true;
        let ignoredConflicts = new Set();
        let dropContext = null;
        
        const DAYS = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
        const TIME_SLOTS_HOURLY = Array.from({ length: 10 }, (_, i) => i + 8); 
        const INSTRUCTOR_CATEGORIES = ['عضو هيئة تدريس', 'معاونون', 'منتدبون', 'اعضاء من الخارج'];
        const LOCATION_TYPES = { 'معمل': 'المعامل', 'قاعة': 'القاعات', 'مدرج': 'المدرجات' };
        
        const dom = {
            mainContent: document.getElementById('main-content'),
            advancedLevelsView: document.getElementById('advanced-levels-view'),
            advancedInstructorsView: document.getElementById('advanced-instructors-view'),
            customViewsContainer: document.getElementById('custom-views-container'),
            levelForm: document.getElementById('level-form'), levelsList: document.getElementById('levels-list'),
            groupForm: document.getElementById('group-form'), groupsList: document.getElementById('groups-list'),
            groupLevelSelect: document.getElementById('group-level-select'),
            subjectLevelSelect: document.getElementById('subject-level-select'),
            levelFilterSelect: document.getElementById('level-filter-select'),
            subjectForm: document.getElementById('subject-form'), subjectsList: document.getElementById('subjects-list'),
            instructorForm: document.getElementById('instructor-form'), instructorsList: document.getElementById('instructors-list'),
            locationForm: document.getElementById('location-form'), locationsList: document.getElementById('locations-list'),
            courseForm: document.getElementById('course-form'), courseNameSelect: document.getElementById('course-name-select'),
            instructorSelect: document.getElementById('instructor-select'),
            sessionType: document.getElementById('session-type'),
            courseGroupSelect: document.getElementById('course-group-select'),
            generateBtn: document.getElementById('generate-btn'), locationsViewBtn: document.getElementById('locations-view-btn'),
            filterMembersBtn: document.getElementById('filter-members-btn'), 
            exportReportBtn: document.getElementById('export-report-btn'),
            saveBackupBtn: document.getElementById('save-backup-btn'),
            loadBtn: document.getElementById('load-btn'), fileLoader: document.getElementById('file-loader'),
            resetBtn: document.getElementById('reset-btn'), printBtn: document.getElementById('print-btn'),
            showConflictsBtn: document.getElementById('show-conflicts-btn'),
            scheduleOutput: document.getElementById('schedule-output'), customScheduleOutput: document.getElementById('custom-schedule-output'),
            hideCustomViewBtn: document.getElementById('hide-custom-view-btn'),
            refreshCustomViewBtn: document.getElementById('refresh-custom-view-btn'),
            unscheduledOutput: document.getElementById('unscheduled-output'), 
            conflictOutput: document.getElementById('conflict-output'),
            summaryTableContainer: document.getElementById('summary-table-container'),
            editModal: document.getElementById('edit-modal'), closeEditModalBtn: document.getElementById('close-edit-modal-btn'),
            editModalTitle: document.getElementById('edit-modal-title'), editModalInput: document.getElementById('edit-modal-input'),
            editModalSaveBtn: document.getElementById('edit-modal-save-btn'), 
            availabilityModal: document.getElementById('availability-modal'), closeAvailabilityModalBtn: document.getElementById('close-availability-modal-btn'),
            availabilityModalTitle: document.getElementById('availability-modal-title'), availabilityGrid: document.getElementById('availability-grid'),
            availabilityModalSaveBtn: document.getElementById('availability-modal-save-btn'),
            courseEditModal: document.getElementById('course-edit-modal'),
            closeCourseEditModalBtn: document.getElementById('close-course-edit-modal-btn'),
            courseEditModalTitle: document.getElementById('course-edit-modal-title'),
            courseEditInstructorSelect: document.getElementById('course-edit-instructor-select'),
            courseEditGroupSelect: document.getElementById('course-edit-group-select'),
            courseEditModalSaveBtn: document.getElementById('course-edit-modal-save-btn'),
            courseEditModalDeleteBtn: document.getElementById('course-edit-modal-delete-btn'),
            courseEditModalSplitBtn: document.getElementById('course-edit-modal-split-btn'),
            courseEditModalMergeBtn: document.getElementById('course-edit-modal-merge-btn'),
            locationEditModal: {
                modal: document.getElementById('location-edit-modal'),
                closeBtn: document.getElementById('close-location-edit-modal-btn'),
                nameInput: document.getElementById('location-edit-name-input'),
                typeSelect: document.getElementById('location-edit-type-select'),
                saveBtn: document.getElementById('location-edit-modal-save-btn'),
            },
            customActivityModal: document.getElementById('custom-activity-modal'),
            closeCustomActivityModalBtn: document.getElementById('close-custom-activity-modal-btn'),
            customActivityModalTitle: document.getElementById('custom-activity-modal-title'),
            customActivityText: document.getElementById('custom-activity-text'),
            customActivityDuration: document.getElementById('custom-activity-duration'),
            customActivityLocation: document.getElementById('custom-activity-location'),
            customActivitySaveBtn: document.getElementById('custom-activity-save-btn'),
            customActivityDeleteBtn: document.getElementById('custom-activity-delete-btn'),
            loadingIndicator: document.getElementById('loading-indicator'),
            confirmModal: {
                modal: document.getElementById('confirm-modal'),
                title: document.getElementById('confirm-modal-title'),
                text: document.getElementById('confirm-modal-text'),
                details: document.getElementById('confirm-modal-details'),
                confirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
            },
            levelActivityModal: {
                modal: document.getElementById('level-activity-modal'),
                closeBtn: document.getElementById('close-level-activity-modal-btn'),
                title: document.getElementById('level-activity-modal-title'),
                nameInput: document.getElementById('level-activity-name-input'),
                instructorSelect: document.getElementById('level-activity-instructor-select'),
                locationSelect: document.getElementById('level-activity-location-select'),
                durationInput: document.getElementById('level-activity-duration-input'),
                colorInput: document.getElementById('level-activity-color-input'),
                saveBtn: document.getElementById('level-activity-modal-save-btn'),
            },
            locationActivityModal: {
                modal: document.getElementById('location-activity-modal'),
                closeBtn: document.getElementById('close-location-activity-modal-btn'),
                title: document.getElementById('location-activity-modal-title'),
                levelSelect: document.getElementById('location-activity-level-select'),
                nameInput: document.getElementById('location-activity-name-input'),
                instructorSelect: document.getElementById('location-activity-instructor-select'),
                durationInput: document.getElementById('location-activity-duration-input'),
                colorInput: document.getElementById('location-activity-color-input'),
                saveBtn: document.getElementById('location-activity-modal-save-btn'),
            },
            courseLists: {
                all: document.getElementById('courses-list-all'),
                lectures: document.getElementById('courses-list-lectures'),
                labs: document.getElementById('courses-list-labs')
            },
            filterBtns: {
                all: document.getElementById('filter-all-btn'),
                lectures: document.getElementById('filter-lectures-btn'),
                labs: document.getElementById('filter-labs-btn')
            }
        };
        
        let db, auth, userId;
        let subjectsCol, instructorsCol, locationsCol, coursesCol, levelsCol, schedulesCol, groupsCol, settingsCol;
        let draggedItem = null;

        async function initializeMainApp() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyANHjKyZJgEOAddxMSQR1JPjzXLWGqaNdM",
                  authDomain: "tabletech-ecaeb.firebaseapp.com",
                  projectId: "tabletech-ecaeb",
                  storageBucket: "tabletech-ecaeb.appspot.com",
                  messagingSenderId: "1025016928304",
                  appId: "1:1025016928304:web:fbc55b5060eb043cf435f5",
                  measurementId: "G-BG0TQQF429"
                };

                const appId = 'tabletech-app';
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        const basePath = `artifacts/${appId}/public/data`;
                        levelsCol = collection(db, basePath, 'levels');
                        groupsCol = collection(db, basePath, 'groups');
                        subjectsCol = collection(db, basePath, 'subjects');
                        instructorsCol = collection(db, basePath, 'instructors');
                        locationsCol = collection(db, basePath, 'locations');
                        coursesCol = collection(db, basePath, 'courses');
                        schedulesCol = collection(db, basePath, 'schedules');
                        settingsCol = collection(db, basePath, 'settings');
                        setupRealtimeListeners();
                    } else {
                        signInAnonymously(auth).catch(error => {
                            console.error("Anonymous Sign-In Error:", error);
                            dom.loadingIndicator.innerHTML = '<p class="text-red-500">حدث خطأ أثناء الاتصال. يرجى تحديث الصفحة.</p>';
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                dom.loadingIndicator.innerHTML = '<p class="text-red-500">حدث خطأ فني أثناء تهيئة التطبيق.</p>';
            }
            setupEventListeners();
        }
        
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        function toggleButtonLoading(button, isLoading) {
            if(!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalContent = button.innerHTML;
                button.innerHTML = `<span class="spinner"></span> <span>جاري...</span>`;
            } else {
                button.disabled = false;
                if(button.dataset.originalContent) button.innerHTML = button.dataset.originalContent;
            }
        }

        function showConfirmModal(text, onConfirm, detailsHtml = '') {
            dom.confirmModal.text.textContent = text;
            dom.confirmModal.details.innerHTML = detailsHtml;
            dom.confirmModal.modal.style.display = 'block';

            return new Promise((resolve) => {
                const confirmHandler = () => {
                    cleanup();
                    onConfirm();
                    resolve(true);
                };
                const cancelHandler = () => {
                    cleanup();
                    resolve(false);
                };
                const cleanup = () => {
                    dom.confirmModal.modal.style.display = 'none';
                    dom.confirmModal.confirmBtn.removeEventListener('click', confirmHandler);
                    dom.confirmModal.cancelBtn.removeEventListener('click', cancelHandler);
                }
                dom.confirmModal.confirmBtn.addEventListener('click', confirmHandler, { once: true });
                dom.confirmModal.cancelBtn.addEventListener('click', cancelHandler, { once: true });
            });
        }
        
        async function handleAddWithLoading(e, collectionRef, data, successMessage) {
            e.preventDefault();
            const form = e.target.closest('form');
            const button = form.querySelector('button[type="submit"]');
            const input = form.querySelector('input');
            toggleButtonLoading(button, true);
            try {
                await addDoc(collectionRef, data);
                showToast(successMessage);
                if(input) input.value = '';
            } catch (error) {
                console.error("Error adding document:", error);
                showToast("حدث خطأ أثناء الحفظ", "error");
            } finally {
                toggleButtonLoading(button, false);
            }
        }

        async function handleAddLevel(e) { const name = e.target.closest('form').querySelector('input').value.trim(); if (name && !levels.some(l => l.name === name)) { handleAddWithLoading(e, levelsCol, { name }, "تمت إضافة الفرقة بنجاح!"); } }
        
        async function handleAddGroup(e) {
            const form = e.target.closest('form');
            const name = form.querySelector('#group-name').value.trim();
            const academicLevel = form.querySelector('#group-level-select').value;
            if (name && academicLevel && !groups.some(g => g.name === name && g.academicLevel === academicLevel)) {
                await handleAddWithLoading(e, groupsCol, { name, academicLevel }, "تمت إضافة المجموعة بنجاح!");
                form.querySelector('#group-name').value = '';
            } else {
                showToast("يرجى اختيار فرقة وإدخال اسم مجموعة غير مكرر لنفس الفرقة.", "error");
            }
        }
        
        function renderLevels() { dom.levelsList.innerHTML = levels.map(l => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md" data-id="${l.id}"><p class="font-semibold text-sm">${l.name}</p>${createControlButtons('level', l.id)}</div>`).join(''); }
        
        function renderGroups() {
            let html = '';
            levels.forEach(level => {
                const levelGroups = groups.filter(g => g.academicLevel === level.name);
                if (levelGroups.length > 0) {
                    html += `<h4 class="text-sm font-bold text-gray-500 mt-2">${level.name}</h4>`;
                    html += levelGroups.map(g => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md" data-id="${g.id}"><p class="font-semibold text-sm">${g.name}</p>${createControlButtons('group', g.id)}</div>`).join('');
                }
            });
            dom.groupsList.innerHTML = html || '<p class="text-gray-400 text-sm">أضف الفرق أولاً ثم المجموعات.</p>';
        }

        window.deleteItem = async (type, id) => {
            if (userRole === 'guest') return;
            const itemMap = { level: {data: levels, col: levelsCol}, group: {data: groups, col: groupsCol}, subject: {data: subjects, col: subjectsCol}, instructor: {data: instructors, col: instructorsCol}, location: {data: locations, col: locationsCol}, course: {data: courses, col: coursesCol} };
            const itemToDelete = itemMap[type].data.find(i => i.id === id);
            if(!itemToDelete) return;

            const batch = writeBatch(db);
            let confirmationText = `هل أنت متأكد من حذف "${itemToDelete.name}"؟`;
            let detailsHtml = '';

            // Cascade Deletion Logic
            if (type === 'level') {
                const dependentSubjects = subjects.filter(s => s.academicLevel === itemToDelete.name);
                const dependentCourses = courses.filter(c => dependentSubjects.some(ds => ds.name === c.baseName));
                const dependentGroups = groups.filter(g => g.academicLevel === itemToDelete.name);
                
                if(dependentSubjects.length > 0) {
                    detailsHtml += `<p class="font-bold">سيتم حذف المواد التالية والسكاشن المرتبطة بها:</p><ul>${dependentSubjects.map(s => `<li>- ${s.name}</li>`).join('')}</ul>`;
                    dependentSubjects.forEach(s => batch.delete(doc(subjectsCol, s.id)));
                    dependentCourses.forEach(c => batch.delete(doc(coursesCol, c.id)));
                }
                if(dependentGroups.length > 0) {
                    detailsHtml += `<p class="font-bold mt-2">سيتم حذف المجموعات التالية:</p><ul>${dependentGroups.map(g => `<li>- ${g.name}</li>`).join('')}</ul>`;
                    dependentGroups.forEach(g => batch.delete(doc(groupsCol, g.id)));
                }
                 if(savedSchedules[itemToDelete.name]) {
                    detailsHtml += `<p class="font-bold mt-2">سيتم حذف الجدول المحفوظ لهذه الفرقة.</p>`;
                    batch.delete(doc(schedulesCol, itemToDelete.name));
                }
            } else if (type === 'subject') {
                const dependentCourses = courses.filter(c => c.baseName === itemToDelete.name);
                if(dependentCourses.length > 0) {
                    detailsHtml += `<p class="font-bold">سيتم حذف المحاضرات والسكاشن التالية:</p><ul>${dependentCourses.map(c => `<li>- ${c.name}</li>`).join('')}</ul>`;
                    dependentCourses.forEach(c => batch.delete(doc(coursesCol, c.id)));
                }
            } else if (type === 'instructor') {
                const dependentCourses = courses.filter(c => c.instructor === itemToDelete.name);
                 if(dependentCourses.length > 0) {
                     detailsHtml += `<p class="font-bold">سيتم فك إسناد هذا العضو من المقررات التالية (لن يتم حذف المقررات نفسها):</p><ul>${dependentCourses.map(c => `<li>- ${c.name}</li>`).join('')}</ul>`;
                     dependentCourses.forEach(c => batch.update(doc(coursesCol, c.id), { instructor: 'غير محدد' }));
                 }
            } else if (type === 'course') {
                detailsHtml += `<p class="font-bold mt-2">سيتم حذف هذا المقرر من جميع الجداول الدراسية المسكن بها.</p>`;
                for (const levelName in savedSchedules) {
                    let grid = JSON.parse(JSON.stringify(savedSchedules[levelName]));
                    let gridWasModified = false;
                    for (const day in grid) {
                        for (const time in grid[day]) {
                            for (const loc in grid[day][time]) {
                                const cellData = grid[day][time][loc];
                                if (cellData && cellData.id === id) {
                                    const duration = cellData.duration || 1;
                                    for (let i = 0; i < duration; i++) {
                                        if (grid[day]?.[parseInt(time) + i]?.[loc]) {
                                            delete grid[day][parseInt(time) + i][loc];
                                        }
                                    }
                                    gridWasModified = true;
                                }
                            }
                        }
                    }
                    if (gridWasModified) {
                        const scheduleRef = doc(db, schedulesCol.path, levelName);
                        batch.update(scheduleRef, { grid: JSON.stringify(grid) });
                    }
                }
            }
             
            await showConfirmModal(confirmationText, async () => {
                const element = document.querySelector(`.list-item[data-id='${id}']`);
                if(element) {
                    element.classList.add('fade-out');
                    await new Promise(resolve => setTimeout(resolve, 400));
                }
                batch.delete(doc(itemMap[type].col, id));
                await batch.commit();
                showToast("تم الحذف بنجاح!");
            }, detailsHtml);
        };

        async function setupRealtimeListeners() {
            let loadedCollections = 0;
            const totalCollections = 8; 
            const onCollectionLoaded = () => {
                loadedCollections++;
                if (loadedCollections >= totalCollections) {
                    dom.loadingIndicator.style.display = 'none';
                    dom.mainContent.classList.remove('hidden');
                    detectAndDisplayConflicts();
                }
            };
            
            const settingsDocRef = doc(settingsCol, 'app_config');
            onSnapshot(settingsDocRef, (doc) => {
                if (doc.exists()) {
                    ignoredConflicts = new Set(doc.data().ignoredConflicts || []);
                }
                onCollectionLoaded();
            }, (error) => {
                console.error("Error fetching settings:", error);
                onCollectionLoaded(); 
            });

            onSnapshot(query(levelsCol), s => { levels = s.docs.map(d => ({ id: d.id, ...d.data() })); renderLevels(); updateLevelSelectors(); onCollectionLoaded(); }, console.error);
            onSnapshot(query(groupsCol), s => { groups = s.docs.map(d => ({ id: d.id, ...d.data() })); renderGroups(); updateGroupSelector(); onCollectionLoaded(); }, console.error);
            onSnapshot(query(subjectsCol), s => { subjects = s.docs.map(d => ({ id: d.id, ...d.data() })); subjects.forEach(sub => courseColors[sub.name] = sub.color || generateHslColor(sub.name)); renderSubjects(); updateCourseSelector(); renderSummaryTable(); onCollectionLoaded(); }, console.error);
            onSnapshot(query(instructorsCol), s => { 
                instructors = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                renderInstructors(); 
                updateInstructorSelector(); 
                if (activeCustomView === 'members') {
                    const search = document.getElementById('member-search-input')?.value || '';
                    const category = document.querySelector('input[name="category"]:checked')?.value || 'all';
                    const level = document.getElementById('member-level-filter')?.value || 'all';
                    displayMemberSchedules(search, category, level);
                }
                if (activeCustomView === 'locations') {
                    displayLocationSchedules();
                }
                onCollectionLoaded(); 
            }, console.error);
            onSnapshot(query(locationsCol), s => { locations = s.docs.map(d => ({ id: d.id, ...d.data() })); renderLocations(); onCollectionLoaded(); }, console.error);
            onSnapshot(query(coursesCol), s => { courses = s.docs.map(d => ({ id: d.id, ...d.data() })); renderCourses(); renderSummaryTable(); onCollectionLoaded(); }, console.error);
            onSnapshot(query(schedulesCol), s => {
                savedSchedules = {};
                s.docs.forEach(d => { try { savedSchedules[d.id] = JSON.parse(d.data().grid); } catch (e) { console.error("Error parsing saved schedule:", e); } });
                handleLevelFilterChange();
                detectAndDisplayConflicts();
                if (activeCustomView === 'members') {
                    const search = document.getElementById('member-search-input')?.value || '';
                    const category = document.querySelector('input[name="category"]:checked')?.value || 'all';
                    const level = document.getElementById('member-level-filter')?.value || 'all';
                    displayMemberSchedules(search, category, level);
                }
                if (activeCustomView === 'locations') {
                    displayLocationSchedules();
                }
                onCollectionLoaded();
            }, console.error);
        }
        
        const showMainView = () => {
            dom.mainContent.classList.remove('hidden');
            dom.advancedLevelsView.classList.add('hidden');
            dom.advancedInstructorsView.classList.add('hidden');
            dom.customViewsContainer.classList.add('hidden');
            activeCustomView = null;
        }
        window.showMainView = showMainView;

        window.showAdvancedLevelsView = () => {
            if (userRole === 'guest') return;
            dom.mainContent.classList.add('hidden');
            dom.advancedInstructorsView.classList.add('hidden');
            dom.advancedLevelsView.classList.remove('hidden');
            dom.advancedLevelsView.innerHTML = generateAdvancedLevelsHTML();

            document.getElementById('adv-level-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('#adv-levels-list > div').forEach(div => {
                    const name = div.querySelector('p').textContent.toLowerCase();
                    div.style.display = name.includes(query) ? 'flex' : 'none';
                });
            });
        }
        
        window.showAdvancedInstructorsView = () => {
            if (userRole === 'guest') return;
            dom.mainContent.classList.add('hidden');
            dom.advancedLevelsView.classList.add('hidden');
            dom.advancedInstructorsView.classList.remove('hidden');
            renderAdvancedInstructorsView();
        }

        function setupEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('userRole');
                location.reload();
            });

            // Call the function to activate lecture/lab filters
            setupCourseFilters();

            if (userRole === 'admin') {
                dom.levelForm.addEventListener('submit', handleAddLevel);
                dom.groupForm.addEventListener('submit', handleAddGroup);
                dom.subjectForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = dom.subjectForm.querySelector('#subject-name').value.trim();
                    const academicLevel = dom.subjectLevelSelect.value;
                    if (name && academicLevel && !subjects.some(s => s.name === name)) {
                        await handleAddWithLoading(e, subjectsCol, { name, academicLevel }, "تمت إضافة المادة بنجاح!");
                        dom.subjectForm.querySelector('#subject-name').value = '';
                    } else {
                        showToast('يرجى اختيار فرقة وإدخال اسم مادة غير مكرر.', 'error');
                    }
                });
                dom.instructorForm.addEventListener('submit', (e) => {
                    const nameInput = document.getElementById('instructor-name-input');
                    const name = nameInput.value.trim();
                    if (name && !instructors.some(i => i.name === name)) {
                        const data = { name, category: document.getElementById('instructor-category-select').value, availableTimes: {}, customActivities: {} };
                        handleAddWithLoading(e, instructorsCol, data, "تمت إضافة العضو بنجاح!");
                    }
                });
                dom.locationForm.addEventListener('submit', (e) => {
                    const nameInput = document.getElementById('location-name');
                    const data = { name: nameInput.value, type: document.getElementById('location-type').value };
                    handleAddWithLoading(e, locationsCol, data, "تمت إضافة المكان بنجاح!");
                });
                dom.courseForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const button = e.target.querySelector('button[type="submit"]');
                    toggleButtonLoading(button, true);
        
                    const subjectName = dom.courseNameSelect.value;
                    const instructorName = dom.instructorSelect.value;
                    const sessionType = dom.sessionType.value;
                    const groupName = dom.courseGroupSelect.value;
        
                    if (!subjectName || !instructorName) { 
                        showToast("الرجاء اختيار المادة والعضو.", "error");
                        toggleButtonLoading(button, false);
                        return; 
                    }
                    
                    try {
                        const subject = subjects.find(s => s.name === subjectName);
                        const sectionsCount = parseInt(document.getElementById('sections-count').value);
                        
                        if (sessionType === 'lab') {
                            const existingSections = courses
                                .filter(c => c.baseName === subject.name && c.type === 'lab')
                                .map(c => {
                                    const match = c.name.match(/سكشن (\d+)/);
                                    return match ? parseInt(match[1]) : 0;
                                })
                                .filter(num => num > 0)
                                .sort((a, b) => a - b);

                            let nextSectionNumber = 1;
                            const usedNumbers = new Set(existingSections);

                            for (let i = 0; i < sectionsCount; i++) {
                                while (usedNumbers.has(nextSectionNumber)) {
                                    nextSectionNumber++;
                                }
                                
                                const courseData = {
                                    baseName: subject.name,
                                    name: `${subject.name} - سكشن ${nextSectionNumber}`,
                                    instructor: instructorName,
                                    type: 'lab',
                                    requiredLocationType: document.getElementById('location-type-select').value,
                                    duration: parseInt(document.getElementById('duration').value),
                                    groupName: null
                                };
                                await addDoc(coursesCol, courseData);
                                usedNumbers.add(nextSectionNumber);
                            }
                        } else { // It's a lecture
                            for (let i = 0; i < sectionsCount; i++) {
                                const courseData = {
                                    baseName: subject.name,
                                    name: subject.name,
                                    instructor: instructorName,
                                    type: 'lecture',
                                    requiredLocationType: document.getElementById('location-type-select').value,
                                    duration: parseInt(document.getElementById('duration').value),
                                    groupName: groupName || null
                                };
                                await addDoc(coursesCol, courseData);
                            }
                        }
                        showToast("تمت إضافة المقرر بنجاح!");
                    } catch (error) {
                        console.error("Error adding course: ", error);
                        showToast("حدث خطأ أثناء إضافة المقرر.", "error");
                    } finally {
                        toggleButtonLoading(button, false);
                    }
                });
                dom.generateBtn.addEventListener('click', generateSchedule);
                dom.exportReportBtn.addEventListener('click', handleExportReport);
                dom.saveBackupBtn.addEventListener('click', handleSaveBackup);
                dom.loadBtn.addEventListener('click', () => dom.fileLoader.click());
                dom.fileLoader.addEventListener('change', handleLoadScheduleFromFile);
                dom.resetBtn.addEventListener('click', () => showConfirmModal("هل أنت متأكد من حذف كل البيانات؟ هذا الإجراء لا يمكن التراجع عنه.", () => handleReset(true)));
            }

            dom.locationsViewBtn.addEventListener('click', displayLocationSchedules);
            dom.filterMembersBtn.addEventListener('click', () => displayMemberSchedules());
            dom.hideCustomViewBtn.addEventListener('click', showMainView);
            dom.refreshCustomViewBtn.addEventListener('click', () => {
                if(activeCustomView === 'members') displayMemberSchedules();
                if(activeCustomView === 'locations') displayLocationSchedules();
                showToast("تم تحديث البيانات!");
            });
            document.getElementById('refresh-btn').addEventListener('click', () => location.reload());
            dom.printBtn.addEventListener('click', () => window.print());
            dom.levelFilterSelect.addEventListener('change', handleLevelFilterChange);
            dom.showConflictsBtn.addEventListener('click', () => {
                showConflicts = true;
                detectAndDisplayConflicts();
            });
            
            [dom.closeEditModalBtn, dom.closeAvailabilityModalBtn, dom.closeCourseEditModalBtn, dom.closeCustomActivityModalBtn, dom.confirmModal.cancelBtn, dom.levelActivityModal.closeBtn, dom.locationEditModal.closeBtn, dom.locationActivityModal.closeBtn].forEach(btn => {
                if(btn) btn.onclick = () => btn.closest('.modal').style.display = "none";
            });
            window.onclick = (event) => { 
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = "none";
                }
            };
            
            if (userRole === 'admin') {
                dom.sessionType.addEventListener('change', (e) => {
                    const groupSelectContainer = document.getElementById('group-select-container');
                    groupSelectContainer.style.display = e.target.value === 'lecture' ? 'block' : 'none';
                });
            }
        }
        
        function createControlButtons(type, id) { 
            if (userRole === 'guest') return '';
            return `<div class="control-buttons flex items-center gap-2"> <button onclick="window.openEditModal('${type}', '${id}')" class="text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-pencil-alt"></i></button> ${type === 'instructor' ? `<button onclick="window.openAvailabilityModal('${id}')" class="text-green-500 hover:text-green-700 p-1"><i class="fas fa-clock"></i></button>` : ''} <button onclick="window.deleteItem('${type}', '${id}')" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button> </div>`; 
        }
        function renderSubjects() {
            let deleteButtonHtml = '';
            if (userRole === 'admin') {
                deleteButtonHtml = `<button onclick="window.deleteItem('course', '\${c.id}')" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button>`;
            }
            dom.subjectsList.innerHTML = subjects.map(s => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md border-r-4" data-id="${s.id}" style="border-color: ${s.color || '#cccccc'}"><div class="flex items-center gap-3"><input type="color" value="${s.color || generateHslColor(s.name, true)}" onchange="window.handleSubjectColorChange('${s.id}', this.value)" style="width: 32px; height: 32px;"><div><p class="font-semibold text-sm">${s.name}</p><p class="text-xs text-gray-500">${s.academicLevel}</p></div></div>${createControlButtons('subject', s.id)}</div>`).join('');
        }
        function renderInstructors() { let html = ''; INSTRUCTOR_CATEGORIES.forEach(category => { const members = instructors.filter(i => i.category === category); if (members.length > 0) { html += `<h4 class="text-sm font-bold text-gray-500 mt-3">${category}</h4>`; html += members.map(i => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md" data-id="${i.id}"><p class="font-semibold text-sm">${i.name}</p>${createControlButtons('instructor', i.id)}</div>`).join(''); } }); dom.instructorsList.innerHTML = html; }
        function renderLocations() { dom.locationsList.innerHTML = locations.map(l => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md" data-id="${l.id}"><p class="font-semibold text-sm">${l.name} (${l.type})</p>${createControlButtons('location', l.id)}</div>`).join(''); }
        function renderCourses(filterType = 'all') {
            const selectedLevel = dom.levelFilterSelect.value;
            const coursesToDisplay = selectedLevel === 'all' ? courses : courses.filter(c => subjects.some(s => s.name === c.baseName && s.academicLevel === selectedLevel));

            const renderList = (courseArray, targetElement, type) => {
                 if(type === filterType || filterType === 'all') {
                    targetElement.innerHTML = courseArray.length ? courseArray.map(c => `<div class="list-item flex justify-between items-center p-2 bg-gray-50 rounded-md border-l-4" data-id="${c.id}" style="border-color: ${courseColors[c.baseName] || '#cccccc'}"><div><p class="font-semibold text-sm">${c.name} ${c.groupName ? `(${c.groupName})` : ''}</p><p class="text-xs text-gray-500">${c.instructor} | ${c.duration} س | ${c.requiredLocationType}</p></div>${userRole === 'admin' ? `<button onclick="window.deleteItem('course', '${c.id}')" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button>` : ''}</div>`).join('') : '<p class="text-gray-400 text-center p-4">لا توجد بيانات.</p>';
                 }
            }

            renderList(coursesToDisplay, dom.courseLists.all, 'all');
            renderList(coursesToDisplay.filter(c => c.type === 'lecture'), dom.courseLists.lectures, 'lecture');
            renderList(coursesToDisplay.filter(c => c.type === 'lab'), dom.courseLists.labs, 'lab');
        }

        function setupCourseFilters() {
            const buttons = dom.filterBtns;
            const lists = dom.courseLists;

            const updateActiveState = (activeBtn) => {
                for (const key in buttons) {
                    buttons[key].classList.remove('border-sky-500', 'text-sky-600');
                    buttons[key].classList.add('text-gray-500', 'border-transparent');
                    lists[key].classList.add('hidden');
                }
                activeBtn.classList.add('border-sky-500', 'text-sky-600');
                activeBtn.classList.remove('text-gray-500', 'border-transparent');
            };

            buttons.all.addEventListener('click', () => {
                updateActiveState(buttons.all);
                lists.all.classList.remove('hidden');
            });
            buttons.lectures.addEventListener('click', () => {
                updateActiveState(buttons.lectures);
                lists.lectures.classList.remove('hidden');
            });
            buttons.labs.addEventListener('click', () => {
                updateActiveState(buttons.labs);
                lists.labs.classList.remove('hidden');
            });
        }
        
        function renderSummaryTable() {
            const selectedLevel = dom.levelFilterSelect.value;
            const container = dom.summaryTableContainer;
            if (!selectedLevel || selectedLevel === 'all') { container.innerHTML = ''; return; }
            const subjectsForLevel = subjects.filter(s => s.academicLevel === selectedLevel);
            if (subjectsForLevel.length === 0) { container.innerHTML = ''; return; }
            let totalLectureHours = 0; let totalLabHours = 0;
            const tableRows = subjectsForLevel.map(subject => { const associatedCourses = courses.filter(c => c.baseName === subject.name); const lectureHours = associatedCourses.filter(c => c.type === 'lecture').reduce((sum, c) => sum + c.duration, 0); const labHours = associatedCourses.filter(c => c.type === 'lab').reduce((sum, c) => sum + c.duration, 0); totalLectureHours += lectureHours; totalLabHours += labHours; return ` <tr class="border-b"> <td class="p-2 font-semibold text-black"> <div class="flex items-center justify-start gap-2"> <div class="w-4 h-4 rounded-sm" style="background-color: ${subject.color || '#cccccc'};"></div> <span>${subject.name}</span> </div> </td> <td class="p-2 text-center">${lectureHours}</td> <td class="p-2 text-center">${labHours}</td> <td class="p-2 text-center font-bold">${lectureHours + labHours}</td> </tr> `; }).join('');
            container.innerHTML = ` <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg"> <h3 class="text-lg font-bold text-center mb-4 text-gray-600">مراية الجدول: ملخص الساعات (${selectedLevel})</h3> <table class="w-full text-sm"> <thead> <tr class="bg-gray-100 text-gray-600 uppercase text-xs"> <th class="p-2 text-right">المادة</th> <th class="p-2 text-center">ساعات نظري</th> <th class="p-2 text-center">ساعات عملي</th> <th class="p-2 text-center">الإجمالي</th> </tr> </thead> <tbody> ${tableRows} </tbody> <tfoot> <tr class="bg-gray-200 font-bold"> <td class="p-2 text-right">الإجمالي الكلي</td> <td class="p-2 text-center">${totalLectureHours}</td> <td class="p-2 text-center">${totalLabHours}</td> <td class="p-2 text-center">${totalLectureHours + totalLabHours}</td> </tr> </tfoot> </table> </div> `;
        }
        
        function updateLevelSelectors() { 
            const options = levels.map(l => `<option value="${l.name}">${l.name}</option>`).join(''); 
            dom.subjectLevelSelect.innerHTML = `<option value="">اختر الفرقة...</option>` + options;
            dom.groupLevelSelect.innerHTML = `<option value="">اختر الفرقة...</option>` + options;
            dom.levelFilterSelect.innerHTML = `<option value="all">عرض الكل</option>` + options; 
            handleLevelFilterChange(); 
        }

        function updateGroupSelector() {
            const selectedLevel = dom.levelFilterSelect.value;
            if (!selectedLevel || selectedLevel === 'all') {
                dom.courseGroupSelect.innerHTML = '<option value="">اختر الفرقة الرئيسية أولاً...</option>';
                return;
            }
            const filteredGroups = groups.filter(g => g.academicLevel === selectedLevel);
            dom.courseGroupSelect.innerHTML = '<option value="">(بدون مجموعة)</option>' + filteredGroups.map(g => `<option value="${g.name}">${g.name}</option>`).join('');
        }
        
        function updateCourseSelector() {
            const selectedLevel = dom.levelFilterSelect.value;
            if (!selectedLevel || selectedLevel === 'all') { dom.courseNameSelect.innerHTML = '<option value="">اختر الفرقة الرئيسية أولاً...</option>'; return; }
            const filteredSubjects = subjects.filter(s => s.academicLevel === selectedLevel);
            dom.courseNameSelect.innerHTML = '<option value="">اختر المادة...</option>' + filteredSubjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }
        function updateInstructorSelector() {
            let instructorsToShow = instructors;
            let html = '<option value="">اختر العضو...</option>';
            INSTRUCTOR_CATEGORIES.forEach(category => { 
                const members = instructorsToShow.filter(i => i.category === category); 
                if (members.length > 0) { 
                    html += `<optgroup label="${category}">`; 
                    html += members.map(i => `<option value="${i.name}">${i.name}</option>`).join(''); 
                    html += `</optgroup>`; 
                } 
            });
            dom.instructorSelect.innerHTML = html;
        }
        function handleLevelFilterChange() {
            renderCourses('all'); 
            updateCourseSelector(); 
            updateInstructorSelector(); 
            renderSummaryTable();
            updateGroupSelector();
            const selectedLevel = dom.levelFilterSelect.value;
            if (savedSchedules[selectedLevel]) { scheduleGrid = savedSchedules[selectedLevel]; displaySchedule(); dom.unscheduledOutput.innerHTML = ''; }
            else { scheduleGrid = {}; dom.scheduleOutput.innerHTML = '<p class="text-center text-gray-500">لم يتم إنشاء جدول لهذه الفرقة بعد. اضغط على "تحديث الجدول".</p>'; }
        }

        function openLocationEditModal(id) {
            if (userRole === 'guest') return;
            const location = locations.find(l => l.id === id);
            if (!location) return;
            const modal = dom.locationEditModal;
            modal.nameInput.value = location.name;
            modal.typeSelect.value = location.type;
            modal.modal.style.display = 'block';
            modal.saveBtn.onclick = () => {
                const newName = modal.nameInput.value.trim();
                const newType = modal.typeSelect.value;
                handleUpdateItem('location', id, newName, { newType });
            };
        }

        window.openEditModal = (type, id) => {
            if (userRole === 'guest') return;
            if (type === 'location') {
                return openLocationEditModal(id);
            }
            const item = { level: levels, group: groups, subject: subjects, instructor: instructors }[type].find(i => i.id === id); 
            if (!item) return;
            dom.editModalTitle.textContent = `تعديل اسم ${item.name}`; 
            dom.editModalInput.value = item.name;
            dom.editModal.style.display = "block";
            dom.editModalSaveBtn.onclick = () => handleUpdateItem(type, id, dom.editModalInput.value.trim());
        };
        window.handleSubjectColorChange = async (id, color) => { 
            if (userRole === 'guest') return;
            const subjectRef = doc(db, subjectsCol.path, id); await updateDoc(subjectRef, { color: color }); 
        };
        
        async function handleUpdateItem(type, id, newName, options = {}) {
            if (userRole === 'guest' || !newName) return;
            const collectionInfo = { level: {col: levelsCol }, group: {col: groupsCol}, subject: {col: subjectsCol }, instructor: {col: instructorsCol }, location: {col: locationsCol } }[type];
            const item = { level: levels, group: groups, subject: subjects, instructor: instructors, location: locations }[type].find(i => i.id === id);
            const oldName = item.name;

            const isDuplicate = ({ level: levels, subject: subjects, instructor: instructors, location: locations }[type]?.some(i => i.name === newName && i.id !== id));
            if (isDuplicate) {
                return showToast("هذا الاسم موجود بالفعل.", "error");
            }
            
            const batch = writeBatch(db);
            
            let updates = { name: newName };
             if (type === 'level') {
                 updates = { ...updates, ...options };
             }

            if (type === 'level') { 
                subjects.forEach(s => { if(s.academicLevel === oldName) batch.update(doc(db, subjectsCol.path, s.id), { academicLevel: newName }); }); 
                groups.forEach(g => { if(g.academicLevel === oldName) batch.update(doc(db, groupsCol.path, g.id), { academicLevel: newName }); });
            }
            if (type === 'group') { courses.forEach(c => { if(c.groupName === oldName) batch.update(doc(db, coursesCol.path, c.id), { groupName: newName }); }); }
            if (type === 'instructor') { courses.forEach(c => { if(c.instructor === oldName) batch.update(doc(db, coursesCol.path, c.id), { instructor: newName }); }); }
            if (type === 'subject') {
                courses.forEach(c => { if (c.baseName === oldName) { batch.update(doc(db, coursesCol.path, c.id), { baseName: newName, name: c.name.replace(oldName, newName) }); } });
                for (const levelName in savedSchedules) { let grid = JSON.parse(JSON.stringify(savedSchedules[levelName])); let gridWasModified = false; for (const day in grid) { for (const time in grid[day]) { for (const loc in grid[day][time]) { const cellData = grid[day][time][loc]; if (cellData && cellData.baseName === oldName) { cellData.baseName = newName; cellData.name = cellData.name.replace(oldName, newName); gridWasModified = true; } } } } if (gridWasModified) { const scheduleRef = doc(db, schedulesCol.path, levelName); batch.update(scheduleRef, { grid: JSON.stringify(grid) }); } }
            }
             if (type === 'location') {
                const { newType } = options;
                updates.type = newType;

                if (oldName !== newName) {
                    for (const levelName in savedSchedules) {
                        let grid = JSON.parse(JSON.stringify(savedSchedules[levelName]));
                        let gridWasModified = false;
                        for (const day in grid) {
                            for (const time in grid[day]) {
                                if (grid[day][time][oldName] !== undefined) {
                                    grid[day][time][newName] = grid[day][time][oldName];
                                    delete grid[day][time][oldName];
                                    gridWasModified = true;
                                }
                            }
                        }
                        if (gridWasModified) {
                            const scheduleRef = doc(db, schedulesCol.path, levelName);
                            batch.update(scheduleRef, { grid: JSON.stringify(grid) });
                        }
                    }
                }
            }

            batch.update(doc(db, collectionInfo.col.path, id), updates);
            await batch.commit();
            
            if (type === 'subject') { const oldColor = courseColors[oldName]; delete courseColors[oldName]; courseColors[newName] = oldColor; }
            
            dom.editModal.style.display = "none";
            dom.locationEditModal.modal.style.display = "none";
            showToast("تم التعديل بنجاح!");
        }
        window.openAvailabilityModal = (id) => {
            if (userRole === 'guest') return;
            const instructor = instructors.find(i => i.id === id); if(!instructor) return;
            dom.availabilityModalTitle.textContent = `تحديد أوقات التفرغ لـ ${instructor.name}`; let gridHtml = '';
            DAYS.forEach(day => { gridHtml += `<div class="grid grid-cols-6 gap-2 items-center"><label class="font-bold col-span-1">${day}</label><div class="col-span-5 flex flex-wrap gap-1">`; TIME_SLOTS_HOURLY.forEach(time => { const isChecked = ((instructor.availableTimes || {})[day] || []).includes(time); gridHtml += `<label class="flex items-center space-x-1 p-1 border rounded-md"><input type="checkbox" data-day="${day}" data-time="${time}" ${isChecked ? 'checked' : ''} class="form-checkbox h-4 w-4"><span class="text-xs">${formatTimeSlot(time)}</span></label>`; }); gridHtml += `</div></div>`; });
            dom.availabilityGrid.innerHTML = gridHtml;
            dom.availabilityModal.style.display = "block";
            dom.availabilityModalSaveBtn.onclick = () => handleSaveAvailability(id);
        };
        async function handleSaveAvailability(id) {
            if (userRole === 'guest') return;
            const instructorRef = doc(db, instructorsCol.path, id); const newAvailableTimes = {};
            const checkboxes = dom.availabilityGrid.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => { const day = cb.dataset.day; const time = parseInt(cb.dataset.time); if (!newAvailableTimes[day]) newAvailableTimes[day] = []; newAvailableTimes[day].push(time); });
            await updateDoc(instructorRef, { availableTimes: newAvailableTimes });
            dom.availabilityModal.style.display = "none";
            showToast("تم حفظ التفرغ بنجاح!");
        }
        
        window.openScheduleItemModal = (courseId, day, time, locationName, levelOverride = null) => {
            if (userRole === 'guest') return;
            const level = levelOverride || dom.levelFilterSelect.value;
            const courseDataFromGrid = savedSchedules[level]?.[day]?.[time]?.[locationName];
            if (!courseDataFromGrid) return;
        
            const course = courses.find(c => c.id === courseId);
            const subject = subjects.find(s => s.name === courseDataFromGrid.baseName);
            if (!subject) return;
        
            dom.courseEditModalTitle.textContent = `تعديل: ${courseDataFromGrid.name}`;
            document.getElementById('course-edit-subject-name-input').value = subject.name;
        
            const groupContainer = document.getElementById('course-edit-group-select-container');
            groupContainer.style.display = courseDataFromGrid.type === 'lecture' ? 'block' : 'none';
        
            const sectionNameContainer = document.getElementById('course-edit-section-name-container');
            if (courseDataFromGrid.type === 'lab') {
                document.getElementById('course-edit-section-name-input').value = courseDataFromGrid.name;
                sectionNameContainer.classList.remove('hidden');
            } else {
                sectionNameContainer.classList.add('hidden');
            }
        
            dom.courseEditInstructorSelect.innerHTML = instructors.map(i => `<option value="${i.name}" ${i.name === courseDataFromGrid.instructor ? 'selected' : ''}>${i.name}</option>`).join('');
        
            const currentLevel = levelOverride || dom.levelFilterSelect.value;
            const groupSelect = document.getElementById('course-edit-group-select');
            const filteredGroups = groups.filter(g => g.academicLevel === currentLevel);
            groupSelect.innerHTML = '<option value="">(بدون مجموعة)</option>' + filteredGroups.map(g => `<option value="${g.name}" ${g.name === courseDataFromGrid.groupName ? 'selected' : ''}>${g.name}</option>`).join('');
        
            document.getElementById('course-edit-color-input').value = subject.color || generateHslColor(subject.name, true);
        
            const locationTypeSelect = document.getElementById('course-edit-location-type-select');
            locationTypeSelect.innerHTML = ['قاعة', 'معمل', 'مدرج'].map(type => 
                `<option value="${type}" ${type === courseDataFromGrid.requiredLocationType ? 'selected' : ''}>${type}</option>`
            ).join('');
        
            const locationSelect = document.getElementById('course-edit-location-select');
            
            const updateLocationList = (selectedType) => {
                const grid = savedSchedules[level];
                const relevantLocations = locations.filter(l => l.type === selectedType);
                let locationOptionsHtml = '';
                
                relevantLocations.forEach(loc => {
                    let isAvailable = true;
                    let isCurrent = (loc.name === locationName && selectedType === courseDataFromGrid.requiredLocationType);
                    for (let i = 0; i < courseDataFromGrid.duration; i++) {
                        const cellData = grid[day]?.[parseInt(time) + i]?.[loc.name];
                        if (cellData && cellData.id !== courseId) {
                            isAvailable = false;
                            break;
                        }
                    }
                    
                    const selectedAttr = isCurrent ? 'selected' : '';
                    if (isCurrent) {
                        locationOptionsHtml += `<option value="${loc.name}" ${selectedAttr}>${loc.name} (الحالي)</option>`;
                    } else if (isAvailable) {
                        locationOptionsHtml += `<option value="${loc.name}" style="color: green;">${loc.name} (متاح)</option>`;
                    } else {
                        locationOptionsHtml += `<option value="${loc.name}" style="color: red;" disabled>${loc.name} (مشغول)</option>`;
                    }
                });
                locationSelect.innerHTML = locationOptionsHtml || '<option value="">لا توجد أماكن من هذا النوع</option>';
            };
        
            updateLocationList(courseDataFromGrid.requiredLocationType);
            locationTypeSelect.onchange = (e) => updateLocationList(e.target.value);
            
            dom.courseEditModalSplitBtn.classList.toggle('hidden', courseDataFromGrid.isSplit || courseDataFromGrid.duration <= 1);
            dom.courseEditModalMergeBtn.classList.toggle('hidden', !courseDataFromGrid.isSplit);
        
            dom.courseEditModal.style.display = 'block';
        
            dom.courseEditModalSaveBtn.onclick = () => handleScheduleItemUpdate({ courseId: courseDataFromGrid.id, subjectId: subject.id, originalSubjectName: subject.name, originalLocation: locationName, day: day, time: time, level: currentLevel });
            dom.courseEditModalDeleteBtn.onclick = () => handleDeleteFromSchedule(courseId, day, time, locationName, currentLevel);
            dom.courseEditModalSplitBtn.onclick = () => handleSplitCourse(courseId, day, time, locationName, currentLevel);
            dom.courseEditModalMergeBtn.onclick = () => handleMergeCourse(courseId, currentLevel);
        };

        async function handleScheduleItemUpdate(context) {
            const { courseId, subjectId, originalSubjectName, originalLocation, day, time, level } = context; 
            const newSubjectName = document.getElementById('course-edit-subject-name-input').value.trim();
            if (newSubjectName && newSubjectName !== originalSubjectName) { 
                await handleUpdateItem('subject', subjectId, newSubjectName); 
                dom.courseEditModal.style.display = 'none'; 
                return; 
            }
            
            const course = courses.find(c => c.id === courseId);
            const newSectionName = document.getElementById('course-edit-section-name-input').value.trim();
            const newInstructor = dom.courseEditInstructorSelect.value;
            const newGroupName = document.getElementById('course-edit-group-select').value;
            const newLocationType = document.getElementById('course-edit-location-type-select').value;
            const newLocation = document.getElementById('course-edit-location-select').value;
            const newColor = document.getElementById('course-edit-color-input').value;

            if (!newLocation) {
                showToast("يرجى اختيار مكان صالح.", "error");
                return;
            }

            const batch = writeBatch(db);
            const subjectRef = doc(db, subjectsCol.path, subjectId);
            batch.update(subjectRef, { color: newColor });

            if(course) {
                const courseRef = doc(db, coursesCol.path, courseId);
                let courseUpdates = {};
                if (newInstructor !== course.instructor) courseUpdates.instructor = newInstructor;
                if (newLocationType !== course.requiredLocationType) courseUpdates.requiredLocationType = newLocationType;
                if (course.type === 'lecture') {
                    courseUpdates.groupName = newGroupName || null;
                }
                if (course.type === 'lab' && newSectionName && newSectionName !== course.name) courseUpdates.name = newSectionName;
                if (Object.keys(courseUpdates).length > 0) {
                    batch.update(courseRef, courseUpdates);
                }
            }
            await batch.commit();

            let grid = JSON.parse(JSON.stringify(savedSchedules[level]));
            const courseDataInGrid = grid[day]?.[parseInt(time)]?.[originalLocation];
            
            if (courseDataInGrid) {
                let updatedCourseData = { 
                    ...courseDataInGrid, 
                    instructor: newInstructor,
                    requiredLocationType: newLocationType
                };
                if (courseDataInGrid.type === 'lecture') {
                    updatedCourseData.groupName = newGroupName || null;
                }
                if (courseDataInGrid.type === 'lab' && newSectionName) {
                    updatedCourseData.name = newSectionName;
                }


                if (newLocation !== originalLocation) {
                    for (let i = 0; i < courseDataInGrid.duration; i++) { if (grid[day]?.[parseInt(time) + i]) { delete grid[day][parseInt(time) + i][originalLocation]; } }
                    for (let i = 0; i < courseDataInGrid.duration; i++) { if (!grid[day]) grid[day] = {}; if (!grid[day][parseInt(time) + i]) grid[day][parseInt(time) + i] = {}; grid[day][parseInt(time) + i][newLocation] = { ...updatedCourseData, isContinuation: i > 0 }; }
                } else {
                    for (let i = 0; i < courseDataInGrid.duration; i++) { if (grid[day]?.[parseInt(time) + i]?.[originalLocation]) { grid[day][parseInt(time) + i][originalLocation] = { ...updatedCourseData, isContinuation: i > 0 }; } }
                }
                await saveScheduleToFirebase(level, grid);
            }
            
            dom.courseEditModal.style.display = 'none';
            showToast("تم حفظ التعديلات!");
        }

        async function handleDeleteFromSchedule(courseId) {
            // This function now permanently deletes the course.
            // The existing deleteItem function already handles everything.
            await window.deleteItem('course', courseId);
            dom.courseEditModal.style.display = 'none';
        }

        async function handleSplitCourse(courseId, day, time, locationName, level) {
            let grid = JSON.parse(JSON.stringify(savedSchedules[level]));
            const originalCourse = grid[day]?.[time]?.[locationName];
            if (!originalCourse || originalCourse.duration <= 1) return;

            for (let i = 0; i < originalCourse.duration; i++) {
                if (grid[day]?.[time + i]?.[locationName]) {
                    delete grid[day][time + i][locationName];
                }
            }

            for (let i = 0; i < originalCourse.duration; i++) {
                const newSplitPart = {
                    ...originalCourse,
                    duration: 1,
                    isSplit: true,
                    originalDuration: originalCourse.duration,
                    isContinuation: false 
                };
                if (!grid[day][time + i]) grid[day][time + i] = {};
                grid[day][time + i][locationName] = newSplitPart;
            }

            await saveScheduleToFirebase(level, grid);
            dom.courseEditModal.style.display = 'none';
            showToast("تم فصل المقرر بنجاح.");
        }

        async function handleMergeCourse(courseId, level) {
            let grid = JSON.parse(JSON.stringify(savedSchedules[level]));
            let gridWasModified = false;
            let originalDuration = 0;

            for (const day in grid) {
                for (const time in grid[day]) {
                    for (const loc in grid[day][time]) {
                        const cellData = grid[day][time][loc];
                        if (cellData && cellData.id === courseId && cellData.isSplit) {
                            originalDuration = cellData.originalDuration; // Capture original duration
                            delete grid[day][time][loc];
                            gridWasModified = true;
                        }
                    }
                }
            }
            
            if (gridWasModified) {
                await saveScheduleToFirebase(level, grid);
                dom.courseEditModal.style.display = 'none';
                showToast(`تم دمج المقرر (${originalDuration} ساعات). يمكنك الآن إضافته من جديد من القائمة.`);
            }
        }


        window.openCustomActivityModal = (instructorId, day, time, activityId = null) => {
            if (userRole === 'guest') return;
            const instructor = instructors.find(i => i.id === instructorId);
            if (!instructor) return;

            const modal = dom.customActivityModal;
            const locationSelect = dom.customActivityLocation;
            locationSelect.innerHTML = '<option value="">(بدون مكان)</option>' + locations.map(l => `<option value="${l.name}">${l.name}</option>`).join('');

            const isEditMode = activityId !== null;
            let activity = null;

            if (isEditMode) {
                activity = instructor.customActivities?.[activityId];
                if (!activity) {
                    showToast("خطأ: لم يتم العثور على النشاط.", "error");
                    return;
                }
                dom.customActivityModalTitle.textContent = 'تعديل النشاط';
                dom.customActivityText.value = activity.text;
                dom.customActivityDuration.value = activity.duration;
                locationSelect.value = activity.location || '';
                dom.customActivityDeleteBtn.classList.remove('hidden');
            } else {
                dom.customActivityModalTitle.textContent = 'إضافة نشاط مخصص';
                dom.customActivityText.value = '';
                dom.customActivityDuration.value = 1;
                locationSelect.value = '';
                dom.customActivityDeleteBtn.classList.add('hidden');
            }

            modal.style.display = 'block';

            dom.customActivitySaveBtn.onclick = () => handleSaveCustomActivity(instructorId, day, time, activityId);
            dom.customActivityDeleteBtn.onclick = () => handleDeleteCustomActivity(instructorId, activityId);
        };
        async function handleSaveCustomActivity(instructorId, day, time, activityId = null) {
            const text = dom.customActivityText.value.trim();
            const duration = parseInt(dom.customActivityDuration.value);
            const location = dom.customActivityLocation.value;

            if (!text || !duration) return showToast('يرجى ملء جميع الحقول.', 'error');
            
            const instructorRef = doc(db, instructorsCol.path, instructorId);
            const newActivityId = activityId || `act_${Date.now()}`;
            const key = `customActivities.${newActivityId}`;
            
            const activityData = {
                text,
                duration,
                location: location || null,
                day,
                time
            };

            await updateDoc(instructorRef, { [key]: activityData });
            dom.customActivityModal.style.display = 'none';
            showToast("تم حفظ النشاط.");
        }
        async function handleDeleteCustomActivity(instructorId, activityId) {
            if (!activityId) return;
            await showConfirmModal("هل أنت متأكد من حذف هذا النشاط؟", async () => {
                const instructorRef = doc(db, instructorsCol.path, instructorId);
                const key = `customActivities.${activityId}`;
                await updateDoc(instructorRef, { [key]: deleteField() });
                dom.customActivityModal.style.display = 'none';
                showToast("تم حذف النشاط.");
            });
        }
        async function saveScheduleToFirebase(level, grid) { if (!level || level === 'all') return; try { const scheduleRef = doc(db, schedulesCol.path, level); await setDoc(scheduleRef, { grid: JSON.stringify(grid) }); } catch (error) { console.error("Error saving schedule:", error); showToast("خطأ في حفظ الجدول", "error"); } }
        
        function generateSchedule() {
            const selectedLevel = dom.levelFilterSelect.value;
            if (selectedLevel === 'all') { return showToast("يرجى اختيار فرقة دراسية محددة لتحديث جدولها.", "error"); }
            scheduleGrid = savedSchedules[selectedLevel] ? JSON.parse(JSON.stringify(savedSchedules[selectedLevel])) : {};
            if (Object.keys(scheduleGrid).length === 0) { DAYS.forEach(day => { scheduleGrid[day] = {}; TIME_SLOTS_HOURLY.forEach(time => { scheduleGrid[day][time] = {}; locations.forEach(loc => scheduleGrid[day][time][loc.name] = null); }); }); }
            const placedCourseIds = new Set();
            for (const day in scheduleGrid) for (const time in scheduleGrid[day]) for (const loc in scheduleGrid[day][time]) { if (scheduleGrid[day][time][loc]) { placedCourseIds.add(scheduleGrid[day][time][loc].id); } }
            const coursesForLevel = courses.filter(course => subjects.find(s => s.name === course.baseName)?.academicLevel === selectedLevel);
            const coursesToSchedule = coursesForLevel.filter(c => !placedCourseIds.has(c.id));
            if (coursesToSchedule.length === 0) { return showToast("لا توجد مواد جديدة لإضافتها للجدول.", "error"); }
            let instructorSchedule = {}; instructors.forEach(inst => { instructorSchedule[inst.name] = {}; DAYS.forEach(day => { instructorSchedule[inst.name][day] = {}; TIME_SLOTS_HOURLY.forEach(time => instructorSchedule[inst.name][day][time] = null); }); });
            let lectureBlockedTimes = {}; DAYS.forEach(day => { lectureBlockedTimes[day] = new Set(); });
            
            for (const day of DAYS) {
                for (const time of TIME_SLOTS_HOURLY) {
                    for (const loc of locations) {
                        const cellData = scheduleGrid[day]?.[time]?.[loc.name];
                        if (cellData && cellData.instructor && instructorSchedule[cellData.instructor]) {
                            instructorSchedule[cellData.instructor][day][time] = cellData.type;
                            if (cellData.type === 'lecture') {
                                lectureBlockedTimes[day].add(time);
                            }
                        }
                    }
                }
            }

            let unscheduled = [];
            const schedulePhase = (courseList) => {
                courseList.forEach(course => {
                    let scheduled = false;
                    for (const time of TIME_SLOTS_HOURLY) {
                        if (time + course.duration > 18) continue;
                        for (const day of DAYS) {
                            const availableLocationsForSlot = locations.filter(l => l.type === course.requiredLocationType);
                            for (const loc of availableLocationsForSlot) {
                                if (canPlaceCourse(course, day, time, loc.name, instructorSchedule, lectureBlockedTimes)) { placeCourse(course, day, time, loc.name, instructorSchedule, lectureBlockedTimes); scheduled = true; break; }
                            }
                            if (scheduled) break;
                        }
                        if (scheduled) break;
                    }
                    if (!scheduled) unscheduled.push(course);
                });
            };
            schedulePhase(coursesToSchedule.filter(c => c.type === 'lecture').sort((a,b)=>b.duration-a.duration));
            schedulePhase(coursesToSchedule.filter(c => c.type === 'lab').sort((a,b)=>b.duration-a.duration));
            saveScheduleToFirebase(selectedLevel, scheduleGrid);
            displaySchedule();
            displayUnscheduled(unscheduled);
            showToast("تم تحديث الجدول بنجاح!");
        }
        function canPlaceCourse(course, day, time, locName, instructorSchedule, lectureBlockedTimes) {
            const instructor = instructors.find(i => i.name === course.instructor);
            const courseLevelName = subjects.find(s => s.name === course.baseName)?.academicLevel;
            const courseLevel = levels.find(l => l.name === courseLevelName);
            
            if (course.type === 'lab' && courseLevel && courseLevel.maxConcurrentSections) {
                let currentConcurrentSections = 0;
                for (const locationName in scheduleGrid[day]?.[time] || {}) {
                    const existingCourse = scheduleGrid[day][time][locationName];
                    if (existingCourse && existingCourse.type === 'lab') {
                        const existingCourseLevel = subjects.find(s => s.name === existingCourse.baseName)?.academicLevel;
                        if (existingCourseLevel === courseLevelName) {
                            currentConcurrentSections++;
                        }
                    }
                }
                if (currentConcurrentSections >= courseLevel.maxConcurrentSections) {
                    return false;
                }
            }


            if (instructor?.availableTimes?.[day]?.length > 0) { for (let i = 0; i < course.duration; i++) { if (!instructor.availableTimes[day].includes(time + i)) return false; } }
            for (let i = 0; i < course.duration; i++) { 
                const currentTime = time + i; 
                if (currentTime >= 18) return false; 
                if (course.type === 'lab' && lectureBlockedTimes[day]?.has(currentTime)) return false; 
                if (scheduleGrid[day]?.[currentTime]?.[locName]) return false;
                const instructorActivity = instructorSchedule[course.instructor]?.[day]?.[currentTime];
                if (instructorActivity) { if (instructorActivity === 'lecture') return false; if (course.type === 'lecture') return false; if (course.requiredLocationType === 'معمل') return false; }
                for (const anyLoc of Object.keys(scheduleGrid[day]?.[currentTime] || {})) { const existingCourse = scheduleGrid[day][currentTime][anyLoc]; if (existingCourse && existingCourse.baseName === course.baseName) { return false; } }
            }
            return true;
        }
        function placeCourse(course, day, time, locName, instructorSchedule, lectureBlockedTimes) {
            for (let i = 0; i < course.duration; i++) { const currentTime = time + i; scheduleGrid[day][currentTime][locName] = { ...course, isContinuation: i > 0 }; if (instructorSchedule[course.instructor]) { instructorSchedule[course.instructor][day][currentTime] = course.type; } if(course.type === 'lecture' && lectureBlockedTimes[day]) { lectureBlockedTimes[day].add(currentTime); } }
        }
        
        async function allowConflict(conflictId) {
            if (userRole === 'guest') return;
            ignoredConflicts.add(conflictId);
            const settingsDocRef = doc(settingsCol, 'app_config');
            try {
                await setDoc(settingsDocRef, { ignoredConflicts: Array.from(ignoredConflicts) }, { merge: true });
                showToast("تم السماح بالتعارض.");
                detectAndDisplayConflicts();
            } catch (error) {
                console.error("Error saving ignored conflict:", error);
                showToast("خطأ في حفظ الإعداد.", "error");
            }
        }
        window.allowConflict = allowConflict;

        function detectAndDisplayConflicts() {
            if (!showConflicts) {
                dom.conflictOutput.innerHTML = '';
                return;
            }
            const conflicts = [];
            const allScheduledItems = [];
            for (const levelName in savedSchedules) {
                const grid = savedSchedules[levelName];
                for (const day in grid) {
                    for (const time in grid[day]) {
                        for (const loc in grid[day][time]) {
                            const item = grid[day][time][loc];
                            if(item && !item.isContinuation) {
                                allScheduledItems.push({ ...item, day, time: parseInt(time), location: loc, level: levelName });
                            }
                        }
                    }
                }
            }

            for(let i = 0; i < allScheduledItems.length; i++) {
                for(let j = i + 1; j < allScheduledItems.length; j++) {
                    const itemA = allScheduledItems[i];
                    const itemB = allScheduledItems[j];

                    const conflictId = [itemA.id, itemB.id].sort().join('|');
                    if (ignoredConflicts.has(conflictId)) continue;
                    
                    const timeConflict = itemA.day === itemB.day && 
                                       (itemA.time < itemB.time + itemB.duration && itemB.time < itemA.time + itemA.duration);
                    if (!timeConflict) continue;

                    let conflictReason = null;
                    let suggestion = null;

                    if (itemA.location === itemB.location) {
                        const isCombinedLecture = 
                            itemA.instructor === itemB.instructor &&
                            itemA.level !== itemB.level;

                        if (!isCombinedLecture) {
                            conflictReason = `تعارض مكان: ${itemA.location} مشغول`;
                            suggestion = `نقل أحد المقررين إلى مكان آخر فارغ من نفس النوع.`;
                        }
                    } else if (itemA.instructor && itemA.instructor !== 'غير محدد' && itemA.instructor === itemB.instructor) {
                         if (itemA.baseName !== itemB.baseName) {
                            conflictReason = `تعارض عضو هيئة تدريس: ${itemA.instructor} لديه مقررين في نفس الوقت.`;
                            suggestion = `تغيير عضو هيئة التدريس لأحد المقررين، أو تغيير توقيت أحدهما.`;
                        }
                    } 

                    if(conflictReason) {
                        conflicts.push({ reason: conflictReason, suggestion, itemA, itemB, conflictId });
                    }
                }
            }
            renderConflictList(conflicts);
        }

        window.ignoreConflicts = () => {
            showConflicts = false;
            dom.conflictOutput.innerHTML = '';
            showToast("تم إخفاء التعارضات مؤقتًا.");
        };

        function renderConflictList(conflicts) {
            if (conflicts.length === 0) {
                dom.conflictOutput.innerHTML = '';
                return;
            }
            let html = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md" role="alert">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-lg"><i class="fas fa-exclamation-triangle mr-2"></i>تم اكتشاف ${conflicts.length} تعارضات</h3>
                    <button onclick="window.ignoreConflicts()" class="bg-red-200 text-red-800 font-bold py-1 px-3 rounded-lg hover:bg-red-300 text-sm">إخفاء الكل</button>
                </div>
                <ul class="list-none space-y-3 mt-2">`;
            
            conflicts.forEach(conflict => {
                const { reason, suggestion, itemA, itemB, conflictId } = conflict;
                const allowButton = userRole === 'admin' ? `<button onclick="window.allowConflict('${conflictId}')" class="bg-green-200 text-green-800 font-bold py-1 px-3 rounded-lg hover:bg-green-300 text-sm whitespace-nowrap">سماح</button>` : '';
                html += `<li class="border-t border-red-200 pt-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold">${reason}</p>
                            <ul class="list-['-_'] list-inside mr-4 text-sm text-red-900">
                                <li>"${itemA.name}" (${itemA.level}) في "${itemA.location}"</li>
                                <li>"${itemB.name}" (${itemB.level}) في "${itemB.location}"</li>
                            </ul>
                        </div>
                        ${allowButton}
                    </div>
                    ${suggestion ? `<p class="text-sm text-green-800 bg-green-100 p-2 rounded-md mt-2"><i class="fas fa-lightbulb mr-1"></i> <strong>حل مقترح:</strong> ${suggestion}</p>` : ''}
                </li>`;
            });
            
            html += `</ul></div>`;
            dom.conflictOutput.innerHTML = html;
        }

        function displaySchedule(isCustomView = false) {
            const level = dom.levelFilterSelect.value;
            if (!level) return;
            const targetElement = isCustomView ? dom.customScheduleOutput : dom.scheduleOutput;
            let tableHtml = `<div class="table-container">
                                <button onclick="window.copyTableToClipboard(this)" title="نسخ الجدول" class="copy-btn print-hidden"><i class="fas fa-copy"></i></button>
                                <h2 class="text-2xl font-bold text-center mb-4 text-gray-700">${level === 'all' ? 'الجدول الدراسي العام' : `الجدول الدراسي - ${level}`}</h2>`;
            tableHtml += '<table class="w-full border-collapse">';
            tableHtml += `<thead><tr class="bg-gray-200"><th class="p-2 border border-gray-300">اليوم</th>${TIME_SLOTS_HOURLY.map(time => `<th class="p-2 border border-gray-300 font-mono text-sm">${formatTimeSlot(time)}</th>`).join('')}</tr></thead><tbody>`;
            DAYS.forEach(day => {
                tableHtml += `<tr class="text-center"><td class="p-2 border border-gray-300 font-semibold align-middle bg-gray-50">${day}</td>`;
                let time_cursor = 0;
                while (time_cursor < TIME_SLOTS_HOURLY.length) {
                    const time = TIME_SLOTS_HOURLY[time_cursor];
                    let itemsInCell = locations.map(loc => ({ locName: loc.name, data: scheduleGrid[day]?.[time]?.[loc.name] })).filter(item => item.data && !item.data.isContinuation);
                    
                    itemsInCell.sort((a, b) => {
                        if (a.data.type === 'lecture' && b.data.type !== 'lecture') return -1;
                        if (a.data.type !== 'lecture' && b.data.type === 'lecture') return 1;
                        return 0;
                    });
                    
                    const canEdit = userRole === 'admin';
                    const editClickHandler = (cellData, locName) => canEdit ? `window.openScheduleItemModal('${cellData.id}', '${day}', ${time}, '${locName}', '${level}')` : '';
                    const addActivityClickHandler = canEdit ? `window.openLevelActivityModal('${day}', ${time})` : '';
                    const draggableAttr = canEdit ? 'draggable="true"' : '';

                    if (itemsInCell.length > 0) {
                        const duration = itemsInCell[0].data.duration || 1; 
                        const containerClass = itemsInCell.length > 1 ? 'multi-item-container' : '';
                        tableHtml += `<td class="p-1 border border-gray-300 align-top" colspan="${duration}">`;
                        tableHtml += `<div class="drop-target ${containerClass}" data-day="${day}" data-time="${time}">`;
                        itemsInCell.forEach(item => { 
                            const { locName, data: cellData } = item; 
                            const sessionClass = cellData.type === 'lab' ? 'session-lab' : '';
                            if (cellData.type === 'custom_activity') {
                                const bgColor = cellData.color || '#e5e7eb';
                                const clickHandler = canEdit ? `window.openLevelActivityModal('${day}', ${time}, '${locName}', '${cellData.id}')` : '';
                                tableHtml += `<div class="schedule-item text-[11px]" onclick="${clickHandler}" style="background-color: ${bgColor};"><p class="font-bold">${cellData.name}</p><p>${cellData.instructor}</p><p class="font-semibold text-gray-600">${locName}</p></div>`;
                            } else {
                                const bgColor = courseColors[cellData.baseName] || '#e5e7eb'; 
                                const borderColor = cellData.type === 'lecture' ? '#f59e0b' : (courseColors[cellData.baseName] ? courseColors[cellData.baseName].replace('85%', '60%') : '#cccccc'); 
                                tableHtml += `<div class="schedule-item text-[11px] ${sessionClass}" ${draggableAttr} data-course-id="${cellData.id}" data-day="${day}" data-time="${time}" data-location="${locName}" onclick="${editClickHandler(cellData, locName)}" style="background-color: ${bgColor}; border-left: 4px solid ${borderColor};"><p class="font-bold">${cellData.name} ${cellData.groupName ? `(${cellData.groupName})` : ''}</p><p>${cellData.instructor}</p><p class="font-semibold text-gray-600">${locName}</p></div>`; 
                            }
                        });
                        tableHtml += `</div></td>`;
                        time_cursor += duration;
                    } else { 
                        const isContinuationSlot = locations.some(loc => scheduleGrid[day]?.[time]?.[loc.name]?.isContinuation); 
                        if (!isContinuationSlot) { 
                            tableHtml += `<td class="p-0 border border-gray-300 align-top empty-slot hover:bg-green-50" onclick="${addActivityClickHandler}"><div class="drop-target h-full" data-day="${day}" data-time="${time}"></div></td>`; 
                        } 
                        time_cursor++; 
                    }
                }
                tableHtml += `</tr>`;
            });
            tableHtml += '</tbody></table></div>';
            targetElement.innerHTML = tableHtml;
            if (userRole === 'admin') {
                addDragAndDropListeners(isCustomView ? '#custom-schedule-output' : '#schedule-output');
            }
        }
        function displayUnscheduled(unscheduled) { dom.unscheduledOutput.innerHTML = unscheduled.length ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-md" role="alert"><p class="font-bold text-lg">مواد لم يتم تسكينها:</p><ul class="list-disc list-inside">${unscheduled.map(c => `<li>${c.name} (${c.instructor})</li>`).join('')}</ul></div>` : ''; }
        function displayLocationSchedules() {
            activeCustomView = 'locations'; dom.customViewsContainer.style.display = 'block'; dom.hideCustomViewBtn.classList.remove('hidden'); dom.refreshCustomViewBtn.classList.remove('hidden'); let allHtml = '<h2 class="text-3xl font-bold text-center mb-6 text-gray-700 border-b-2 pb-2">جداول الأماكن</h2>';
            for (const type in LOCATION_TYPES) { allHtml += generateAggregatedLocationTableHtml(type, `جداول ${LOCATION_TYPES[type]}`); }
            dom.customScheduleOutput.innerHTML = allHtml;
        }
        function displayMemberSchedules(searchQuery = '', filterCategory = 'all', filterLevel = 'all') {
            activeCustomView = 'members'; dom.customViewsContainer.style.display = 'block'; dom.hideCustomViewBtn.classList.remove('hidden'); dom.refreshCustomViewBtn.classList.remove('hidden');
            const sidebarHtml = ` <div id="members-view-sidebar" class="w-full lg:w-1/5 lg:pr-6 mb-8 lg:mb-0"> <div class="bg-white p-4 rounded-xl shadow-md space-y-4"> <div><h3 class="font-bold text-lg">تصفية الأعضاء</h3> <input type="text" id="member-search-input" placeholder="ابحث بالاسم..." class="w-full p-2 border rounded-md mt-2" value="${searchQuery}"></div> <div> <h4 class="font-bold text-sm mb-2">الفئة</h4> <div id="member-filter-options" class="space-y-2"> <label class="flex items-center"><input type="radio" name="category" value="all" class="ml-2" ${filterCategory === 'all' ? 'checked' : ''}> الكل</label> ${INSTRUCTOR_CATEGORIES.map(cat => `<label class="flex items-center"><input type="radio" name="category" value="${cat}" class="ml-2" ${filterCategory === cat ? 'checked' : ''}> ${cat}</label>`).join('')} </div> </div> <div><h4 class="font-bold text-sm mb-2">الفرقة الدراسية</h4><select id="member-level-filter" class="w-full p-2 border rounded-md"><option value="all">كل الفرق</option>${levels.map(l => `<option value="${l.name}" ${filterLevel === l.name ? 'selected' : ''}>${l.name}</option>`).join('')}</select></div> </div> </div> `;
            const mainContentHtml = `<div id="members-view-content" class="w-full lg:w-4/5"></div>`;
            dom.customScheduleOutput.innerHTML = ` <h2 class="text-3xl font-bold text-center mb-6 text-gray-700 border-b-2 pb-2">جداول الأعضاء</h2> <div class="lg:flex"> ${sidebarHtml} ${mainContentHtml} </div>`;
            document.getElementById('members-view-content').innerHTML = generateInstructorSchedulesHtml(searchQuery, filterCategory, filterLevel);
            
            const updateMemberView = () => {
                const search = document.getElementById('member-search-input').value;
                const category = document.querySelector('input[name="category"]:checked').value;
                const level = document.getElementById('member-level-filter').value;
                displayMemberSchedules(search, category, level);
            };

            document.getElementById('member-search-input').addEventListener('input', updateMemberView);
            document.querySelectorAll('input[name="category"]').forEach(radio => radio.addEventListener('change', updateMemberView));
            document.getElementById('member-level-filter').addEventListener('change', updateMemberView);

            if (userRole === 'admin') {
                addMemberViewDragDropListeners(); 
            }
        }
        function generateAggregatedLocationTableHtml(filterType, mainTitle) {
            const filteredItems = locations.filter(l => l.type === filterType);
            if (!filteredItems.length) return '';
        
            let allHtml = `<div class="mb-10"><h3 class="text-2xl font-bold text-center mb-4 text-cyan-700">${mainTitle}</h3>`;
            
            // 1. Build a comprehensive locationGrid
            let locationGrid = {};
            locations.forEach(loc => {
                locationGrid[loc.name] = {};
                DAYS.forEach(d => {
                    locationGrid[loc.name][d] = {};
                    TIME_SLOTS_HOURLY.forEach(t => locationGrid[loc.name][d][t] = []);
                });
            });

            // 2. Populate with courses from schedules
            for (const levelName in savedSchedules) {
                const grid = savedSchedules[levelName];
                for (const day in grid) {
                    for (const time in grid[day]) {
                        for (const locName in grid[day][time]) {
                            const cell = grid[day][time][locName];
                            if (cell && locationGrid[locName]) { // Check if location exists
                                locationGrid[locName][day][parseInt(time)].push({ ...cell, level: levelName });
                            }
                        }
                    }
                }
            }

            // 3. Populate with custom activities
            instructors.forEach(instructor => {
                const customActivities = instructor.customActivities || {};
                for (const activityId in customActivities) {
                    const activity = customActivities[activityId];
                    if (activity.location && locationGrid[activity.location]) {
                        if (locationGrid[activity.location][activity.day] && locationGrid[activity.location][activity.day][activity.time]) {
                            locationGrid[activity.location][activity.day][activity.time].push({
                                id: activityId,
                                type: 'custom',
                                name: activity.text,
                                instructor: instructor.name,
                                level: '',
                                ...activity
                            });
                        }
                    }
                }
            });

            // 4. Render tables
            filteredItems.forEach(item => {
                allHtml += `<div class="mb-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg table-container"><button onclick="window.copyTableToClipboard(this)" title="نسخ الجدول" class="copy-btn print-hidden"><i class="fas fa-copy"></i></button><h4 class="text-xl font-bold text-center mb-4 text-cyan-600">${item.name}</h4>`;
                allHtml += `<table class="w-full border-collapse"><thead><tr class="bg-gray-200"><th class="p-2 border">اليوم</th>${TIME_SLOTS_HOURLY.map(t => `<th class="p-2 border font-mono text-sm">${formatTimeSlot(t)}</th>`).join('')}</tr></thead><tbody>`;
                
                const currentLocGrid = locationGrid[item.name];

                DAYS.forEach(day => {
                    allHtml += `<tr class="text-center"><td class="p-2 border font-semibold align-middle bg-gray-50">${day}</td>`;
                    let time_cursor = 0;
                    while (time_cursor < TIME_SLOTS_HOURLY.length) {
                        const time = TIME_SLOTS_HOURLY[time_cursor];
                        const apps = currentLocGrid[day][time].filter(app => !app.isContinuation);
                        
                        if (apps.length > 0) {
                            const maxDuration = Math.max(...apps.map(app => app.duration || 1));
                            allHtml += `<td class="p-1 border align-top h-20" colspan="${maxDuration}">`;
                            allHtml += '<div class="flex flex-col gap-1">';
                            
                            apps.forEach(cellData => {
                                const contentHtml = `<p class="font-bold">${cellData.name || cellData.text}</p><p>${cellData.instructor}</p><p class="text-xs text-gray-500">${cellData.level}</p>`;
                                const bgColor = cellData.color || courseColors[cellData.baseName] || '#e5e7eb';
                                allHtml += `<div class="schedule-item text-[11px]" style="background-color: ${bgColor};">${contentHtml}</div>`;
                            });
                            
                            allHtml += '</div></td>';

                            // Mark continuation slots
                            for(let d = 1; d < maxDuration; d++){
                                const nextTime = time + d;
                                apps.forEach(app => {
                                    if(d < app.duration){
                                        if(!currentLocGrid[day][nextTime]) currentLocGrid[day][nextTime] = [];
                                        currentLocGrid[day][nextTime].push({...app, isContinuation: true});
                                    }
                                });
                            }
                            time_cursor += maxDuration;
                        } else {
                            const addActivityClickHandler = userRole === 'admin' ? `onclick="window.openLocationActivityModal('${item.name}', '${day}', ${time})"` : '';
                            allHtml += `<td class="p-1 border align-top h-20 empty-slot" ${addActivityClickHandler}></td>`;
                            time_cursor++;
                        }
                    }
                    allHtml += `</tr>`;
                });
                allHtml += '</tbody></table></div>';
            });
            allHtml += '</div>';
            return allHtml;
        }

        function generateInstructorSchedulesHtml(searchQuery = '', filterCategory = 'all', filterLevel = 'all') {
            let filteredInstructors = [...instructors]; 
            if (searchQuery && typeof searchQuery === 'string') { filteredInstructors = filteredInstructors.filter(inst => inst.name.toLowerCase().includes(searchQuery.trim().toLowerCase())); } 
            if (filterCategory !== 'all') { filteredInstructors = filteredInstructors.filter(inst => inst.category === filterCategory); }
            if (filterLevel !== 'all') {
                const instructorsForLevel = new Set();
                for (const levelName in savedSchedules) {
                    if (levelName === filterLevel) {
                        const grid = savedSchedules[levelName];
                        for(const day in grid) for(const time in grid[day]) for(const loc in grid[day][time]) {
                            const cell = grid[day][time][loc];
                            if(cell && cell.instructor) instructorsForLevel.add(cell.instructor);
                        }
                    }
                }
                filteredInstructors = filteredInstructors.filter(inst => instructorsForLevel.has(inst.name));
            }

            if (!filteredInstructors.length) return '<p class="text-center text-gray-500">لا يوجد أعضاء مطابقون لمعايير البحث.</p>';
            let allHtml = '';
            INSTRUCTOR_CATEGORIES.forEach(category => {
                const members = filteredInstructors.filter(inst => inst.category === category);
                if (members.length > 0) {
                    allHtml += `<h3 class="text-2xl font-bold text-center my-6 text-sky-700">${category}</h3>`;
                    members.forEach(instructor => {
                        let instructorGrid = {}; 
                        DAYS.forEach(d => { instructorGrid[d] = {}; TIME_SLOTS_HOURLY.forEach(t => instructorGrid[d][t] = []); });
                        
                        for (const levelName in savedSchedules) { const grid = savedSchedules[levelName]; for (const day of DAYS) { for (const time of TIME_SLOTS_HOURLY) { for (const loc of locations) { const cell = grid[day]?.[time]?.[loc.name]; if (cell && cell.instructor === instructor.name) { instructorGrid[day][parseInt(time)].push({...cell, type: cell.type === 'custom_activity' ? 'custom' : 'course', location: loc.name, level: levelName }); } } } } }
                        const customActivities = instructor.customActivities || {};
                        for (const activityId in customActivities) {
                            const activity = { id: activityId, ...customActivities[activityId] };
                            if (instructorGrid[activity.day] && instructorGrid[activity.day][activity.time]) {
                                instructorGrid[activity.day][activity.time].push({ type: 'custom', ...activity });
                            }
                        }
                        const canEdit = userRole === 'admin';
                        allHtml += `<div class="mb-10 bg-white p-4 sm:p-6 rounded-xl shadow-lg"> <h4 class="text-xl font-bold text-center mb-4 text-sky-600">${instructor.name}</h4> <div class="table-container"><button onclick="window.copyTableToClipboard(this)" title="نسخ الجدول" class="copy-btn print-hidden"><i class="fas fa-copy"></i></button><h5 class="font-bold text-center text-md mb-2 text-gray-700">الجدول التفصيلي</h5> <table class="w-full text-sm text-center border-collapse"> <thead><tr class="bg-gray-100"> <th class="p-2 border">اليوم</th> ${TIME_SLOTS_HOURLY.map(t => `<th class="p-2 border font-mono">${formatTimeSlot(t)}</th>`).join('')} </tr></thead><tbody>`;
                        DAYS.forEach(day => {
                            allHtml += `<tr class="text-center"><td class="p-2 border font-semibold align-middle bg-gray-50">${day}</td>`; 
                            let time_cursor = 0;
                            while (time_cursor < TIME_SLOTS_HOURLY.length) {
                                const time = TIME_SLOTS_HOURLY[time_cursor];
                                const apps = instructorGrid[day][time].filter(app => !app.isContinuation);
                                
                                const addActivityBtn = canEdit ? `<div class="add-concurrent-btn" onclick="window.openCustomActivityModal('${instructor.id}', '${day}', ${time})"><i class="fas fa-plus"></i></div>` : '';
                                const emptySlotClick = canEdit ? `onclick="window.openCustomActivityModal('${instructor.id}', '${day}', ${time})"` : '';
                                
                                if (apps.length > 0) {
                                    const maxDuration = Math.max(...apps.map(app => app.duration || 1));
                                    allHtml += `<td class="p-1 border align-top occupied-slot" colspan="${maxDuration}" style="position: relative;">`;
                                    allHtml += addActivityBtn;
                                    allHtml += '<div class="flex flex-col gap-1">';
                                    apps.forEach(app => {
                                        const bgColor = app.color || courseColors[app.baseName] || (app.type === 'custom' ? '#e5e7eb' : '#f3f4f6');
                                        let contentHtml = '';
                                        const scheduleItemClick = canEdit ? `onclick="window.openScheduleItemModal('${app.id}', '${day}', ${time}, '${app.location}', '${app.level}')"` : '';
                                        const customActivityClick = canEdit ? `onclick="window.openCustomActivityModal('${instructor.id}', '${day}', ${time}, '${app.id}')"` : '';
                                        const draggableAttr = canEdit ? 'draggable="true"' : '';

                                        if (app.type === 'course') { 
                                            contentHtml = `<div class="schedule-item text-[9px]" ${scheduleItemClick} style="background-color: ${bgColor};"><p class="font-bold">${app.name} ${app.groupName ? `(${app.groupName})` : ''}</p><p>${app.level}</p><p class="text-gray-700 font-semibold">${app.location}</p></div>`; 
                                        } else { // Custom activity
                                            contentHtml = `<div class="schedule-item text-[9px]" ${draggableAttr} data-type="activity" data-activity-id="${app.id}" data-instructor-id="${instructor.id}" ${customActivityClick} style="background-color: ${bgColor};"><p class="font-bold">${app.text || app.name}</p>${app.location ? `<p class="text-gray-700 font-semibold">${app.location}</p>` : ''}${app.level ? `<p>${app.level}</p>` : ''}</div>`; 
                                        }
                                        allHtml += contentHtml;
                                    });
                                    allHtml += `</div></td>`;
                                    
                                    for(let d=1; d < maxDuration; d++){
                                        const nextTime = time + d;
                                        apps.forEach(app => {
                                            if(d < app.duration){
                                                if(!instructorGrid[day][nextTime]) instructorGrid[day][nextTime] = [];
                                                instructorGrid[day][nextTime].push({...app, isContinuation: true});
                                            }
                                        });
                                    }
                                    time_cursor += maxDuration;
                                } else {
                                    allHtml += `<td class="p-2 border empty-slot" ${emptySlotClick}></td>`;
                                    time_cursor++;
                                }
                            }
                            allHtml += `</tr>`;
                        });
                        allHtml += `</tbody></table></div> ${generateMirrorTableHtml(instructor)} </div>`;
                    });
                }
            });
            return allHtml;
        }

        function generateMirrorTableHtml(instructor) {
            let theoreticalHours = 0;
            let practicalHours = 0;
            const summaryRows = [];
            const timeSlotMap = new Map();

            // Populate timeSlotMap from courses in schedules
            for (const levelName in savedSchedules) {
                const grid = savedSchedules[levelName];
                for (const day in grid) {
                    for (const time in grid[day]) {
                        for (const loc in grid[day][time]) {
                            const cell = grid[day][time][loc];
                            if (cell && cell.instructor === instructor.name && !cell.isContinuation) {
                                const mapKey = `${day}-${time}`;
                                if (!timeSlotMap.has(mapKey)) { timeSlotMap.set(mapKey, []); }
                                timeSlotMap.get(mapKey).push(cell);
                            }
                        }
                    }
                }
            }

            // Populate timeSlotMap from personal custom activities
            const customActivities = instructor.customActivities || {};
            for (const id in customActivities) {
                const activity = { id, type: 'custom', ...customActivities[id] };
                const mapKey = `${activity.day}-${activity.time}`;
                if (!timeSlotMap.has(mapKey)) { timeSlotMap.set(mapKey, []); }
                timeSlotMap.get(mapKey).push(activity);
            }

            // Process sorted slots to build summary and calculate hours
            const processedItems = new Set();
            const sortedSlotKeys = Array.from(timeSlotMap.keys()).sort((a, b) => {
                const [dayA, timeA] = a.split('-');
                const [dayB, timeB] = b.split('-');
                if (dayA !== dayB) return DAYS.indexOf(dayA) - DAYS.indexOf(dayB);
                return parseInt(timeA) - parseInt(timeB);
            });
            
            for (const key of sortedSlotKeys) {
                const itemsInSlot = timeSlotMap.get(key);
                itemsInSlot.forEach(item => {
                    if (processedItems.has(item.id)) return;

                    if (item.type === 'custom_activity' || item.type === 'custom') {
                        practicalHours += item.duration || 0;
                        const activityTypeText = item.type === 'custom' ? '' : 'نشاط بالجدول';
                        summaryRows.push(`<tr class="border-b bg-gray-50"><td class="p-2 font-semibold">${item.name || item.text} ${item.location ? `(${item.location})` : ''} ${activityTypeText ? `(${activityTypeText})` : ''}</td><td class="p-2 text-center">-</td><td class="p-2 text-center">${item.duration || 0}</td></tr>`);
                    } else {
                        const subject = subjects.find(s => s.name === item.baseName);
                        const courseTheoretical = item.type === 'lecture' ? (item.duration || 0) : 0;
                        const coursePractical = item.type !== 'lecture' ? (item.duration || 0) : 0;
                        theoreticalHours += courseTheoretical;
                        practicalHours += coursePractical;
                        summaryRows.push(`<tr class="border-b"><td class="p-2 font-semibold">${item.name} (${subject?.academicLevel || 'غير محدد'})</td><td class="p-2 text-center">${courseTheoretical > 0 ? courseTheoretical : '-'}</td><td class="p-2 text-center">${coursePractical > 0 ? coursePractical : '-'}</td></tr>`);
                    }
                    processedItems.add(item.id);
                });
            }

            // Calculate total hours based on non-overlapping time slots
            let totalHoursSummary = 0;
            const processedTimeSlots = new Set();
            for (const key of sortedSlotKeys) {
                if (processedTimeSlots.has(key)) continue;
                const itemsInSlot = timeSlotMap.get(key);
                const maxDuration = Math.max(...itemsInSlot.map(item => item.duration || 1));
                totalHoursSummary += maxDuration;
                const [day, timeStr] = key.split('-');
                const time = parseInt(timeStr);
                for (let i = 0; i < maxDuration; i++) {
                    processedTimeSlots.add(`${day}-${time + i}`);
                }
            }

            return `
            <div class="mt-6 p-4 bg-gray-50 border rounded-lg table-container">
                <button onclick="window.copyTableToClipboard(this)" title="نسخ الجدول" class="copy-btn print-hidden"><i class="fas fa-copy"></i></button>
                <h5 class="font-bold text-center text-lg mb-4 text-gray-700">مرايا الجدول (ملخص النصاب الفعلي)</h5>
                <table class="w-full text-sm text-right">
                    <thead><tr class="bg-gray-200 text-gray-600"><th class="p-2">المقرر / النشاط (الفرقة)</th><th class="p-2 text-center">ساعات نظري</th><th class="p-2 text-center">ساعات عملي</th></tr></thead>
                    <tbody>${summaryRows.length > 0 ? summaryRows.join('') : `<tr><td colspan="3" class="text-center p-4 text-gray-500">لم يتم تسكين أي مهام لهذا العضو في الجداول.</td></tr>`}</tbody>
                    <tfoot><tr class="bg-gray-200 font-bold border-t-2 border-gray-300"><td colspan="3" class="p-3 text-center text-md">${theoreticalHours} <span class="font-normal text-gray-600">نظري</span> + ${practicalHours} <span class="font-normal text-gray-600">عملي</span> = ${totalHoursSummary} <span class="font-normal text-gray-600">ساعة إجمالية</span></td></tr></tfoot>
                </table>
            </div>`;
        }


        function addDragAndDropListeners(containerSelector) { document.querySelectorAll(`${containerSelector} .schedule-item[draggable="true"]`).forEach(item => item.addEventListener('dragstart', handleDragStart)); document.querySelectorAll(`${containerSelector} .drop-target`).forEach(target => { target.addEventListener('dragover', e => e.preventDefault()); target.addEventListener('dragenter', e => e.target.closest('.drop-target')?.classList.add('drag-over')); target.addEventListener('dragleave', e => e.target.closest('.drop-target')?.classList.remove('drag-over')); target.addEventListener('drop', handleDrop); }); }
        function handleDragStart(e) { draggedItem = e.target.closest('.schedule-item'); setTimeout(() => { if(draggedItem) draggedItem.style.opacity = '0.5'; }, 0); }
        
        function addMemberViewDragDropListeners() {
            document.querySelectorAll('#members-view-content .schedule-item[draggable="true"]').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
            });
            document.querySelectorAll('#members-view-content .empty-slot').forEach(target => {
                target.addEventListener('dragover', e => e.preventDefault());
                target.addEventListener('dragenter', e => e.target.classList.add('drag-over'));
                target.addEventListener('dragleave', e => e.target.classList.remove('drag-over'));
                target.addEventListener('drop', handleMemberViewDrop);
            });
        }
        
        async function handleMemberViewDrop(e) {
            e.preventDefault();
            if (!draggedItem) return;

            const targetCell = e.target.closest('.empty-slot');
            draggedItem.style.opacity = '1';
            targetCell.classList.remove('drag-over');

            const dataType = draggedItem.dataset.type;
            if (dataType !== 'activity') {
                showToast("يمكن نقل الأنشطة المخصصة فقط في هذا العرض.", "error");
                draggedItem = null;
                return;
            }
            
            const activityId = draggedItem.dataset.activityId;
            const instructorId = draggedItem.dataset.instructorId;

            const onclickAttr = targetCell.getAttribute('onclick');
            const match = onclickAttr.match(/'([^']*)',\s*(\d+)/);
            if (!match) {
                draggedItem = null;
                return;
            }
            const newDay = match[1];
            const newTime = parseInt(match[2]);

            const instructor = instructors.find(i => i.id === instructorId);
            const activity = instructor.customActivities[activityId];

            let isConflict = false;
            for (let i = 0; i < activity.duration; i++) {
                for (const levelName in savedSchedules) {
                    const grid = savedSchedules[levelName];
                    for (const loc in grid[newDay]?.[newTime + i] || {}) {
                        if (grid[newDay][newTime + i][loc]?.instructor === instructor.name) {
                            isConflict = true; break;
                        }
                    }
                    if(isConflict) break;
                }
                if(isConflict) break;
                for (const actId in instructor.customActivities) {
                    if (actId === activityId) continue;
                    const otherActivity = instructor.customActivities[actId];
                    if (otherActivity.day === newDay && (newTime + i >= otherActivity.time && newTime + i < otherActivity.time + otherActivity.duration)) {
                        isConflict = true; break;
                    }
                }
                if(isConflict) break;
            }

            if (isConflict) {
                showToast("لا يمكن النقل: يوجد تعارض في التوقيت.", "error");
            } else {
                const instructorRef = doc(db, instructorsCol.path, instructorId);
                const updates = {};
                updates[`customActivities.${activityId}.day`] = newDay;
                updates[`customActivities.${activityId}.time`] = newTime;
                await updateDoc(instructorRef, updates);
                showToast("تم نقل النشاط بنجاح.");
            }
            
            draggedItem = null;
        }

        async function handleDrop(e) {
            e.preventDefault();
            if (!draggedItem) return;
        
            const targetCell = e.target.closest('.drop-target');
            draggedItem.style.opacity = '1';
        
            if (!targetCell) {
                draggedItem = null;
                return;
            }
            targetCell.classList.remove('drag-over');
        
            const sourceInfo = {
                id: draggedItem.dataset.courseId,
                day: draggedItem.dataset.day,
                time: parseInt(draggedItem.dataset.time),
                location: draggedItem.dataset.location
            };
        
            const targetDay = targetCell.dataset.day;
            const targetTime = parseInt(targetCell.dataset.time);
            const targetItemElement = e.target.closest('.schedule-item');
        
            if (targetItemElement && targetItemElement !== draggedItem) {
                showToast("المكان مشغول بالفعل. لا يمكن النقل المباشر.", "error");
                draggedItem = null;
                return;
            }
        
            const selectedLevel = dom.levelFilterSelect.value;
            let grid = JSON.parse(JSON.stringify(savedSchedules[selectedLevel]));
            const sourceCourse = grid[sourceInfo.day]?.[sourceInfo.time]?.[sourceInfo.location];
        
            if (!sourceCourse) {
                showToast("خطأ: لم يتم العثور على المقرر المصدر.", "error");
                draggedItem = null;
                return;
            }
        
            let instructorConflict = false;
            const instructorName = sourceCourse.instructor;
            if (instructorName && instructorName !== 'غير محدد') {
                for (const levelName in savedSchedules) {
                    const currentGrid = savedSchedules[levelName];
                    for (let i = 0; i < sourceCourse.duration; i++) {
                        const checkTime = targetTime + i;
                        for (const locName in currentGrid[targetDay]?.[checkTime] || {}) {
                            const existingItem = currentGrid[targetDay][checkTime][locName];
                            if (existingItem.instructor === instructorName && existingItem.id !== sourceCourse.id) {
                                instructorConflict = true;
                                break;
                            }
                        }
                        if (instructorConflict) break;
                    }
                    if (instructorConflict) break;
                }
                const instructor = instructors.find(i => i.name === instructorName);
                if (!instructorConflict && instructor && instructor.customActivities) {
                    for (const activityId in instructor.customActivities) {
                        const activity = instructor.customActivities[activityId];
                        if (activity.day === targetDay && (targetTime < activity.time + activity.duration && activity.time < targetTime + sourceCourse.duration)) {
                            instructorConflict = true;
                            break;
                        }
                    }
                }
            }
        
            if (instructorConflict) {
                showToast(`فشل النقل: يوجد تعارض في جدول العضو "${instructorName}" في هذا التوقيت.`, "error");
                draggedItem = null;
                return;
            }
        
            const availableLocationsForDrop = locations.filter(loc => {
                if (loc.type !== sourceCourse.requiredLocationType) return false;
                let isFree = true;
                for (let i = 0; i < sourceCourse.duration; i++) {
                    const cellData = grid[targetDay]?.[targetTime + i]?.[loc.name];
                    if (cellData && cellData.id !== sourceCourse.id) {
                        isFree = false;
                        break;
                    }
                }
                return isFree;
            });
        
            const targetLocation = availableLocationsForDrop.length > 0 ? availableLocationsForDrop[0].name : null;
        
            if (targetLocation) {
                for (let i = 0; i < sourceCourse.duration; i++) {
                    if (grid[sourceInfo.day]?.[sourceInfo.time + i]?.[sourceInfo.location]) {
                        delete grid[sourceInfo.day][sourceInfo.time + i][sourceInfo.location];
                    }
                }
                for (let i = 0; i < sourceCourse.duration; i++) {
                    if (!grid[targetDay]) grid[targetDay] = {};
                    if (!grid[targetDay][targetTime + i]) grid[targetDay][targetTime + i] = {};
                    grid[targetDay][targetTime + i][targetLocation] = { ...sourceCourse, isContinuation: i > 0 };
                }
                await saveScheduleToFirebase(selectedLevel, grid);
                showToast("تم نقل المقرر بنجاح!");
            } else {
                showToast(`فشل النقل: لا يوجد مكان فارغ من نوع "${sourceCourse.requiredLocationType}" في هذا التوقيت.`, "error");
            }
        
            draggedItem = null;
        }

        function handleSaveBackup() {
            const dataToSave = { levels, subjects, instructors, locations, courses, groups, savedSchedules };
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `schedule_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
        }

        function handleExportReport() {
            let reportHtml = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقرير الجداول الدراسي</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; padding: 20px; }
        .schedule-item { padding: 4px; border-radius: 6px; margin-bottom: 4px; color: #1f2937; box-shadow: 0 2px 4px rgba(0,0,0,0.05); line-height: 1.3; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .session-lab { border-left: 4px solid #14b8a6 !important; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; page-break-inside: auto; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        thead { display: table-header-group; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; font-size: 12px; }
        th { background-color: #f2f2f2; }
        h1, h2, h3, h4 { text-align: center; margin-top: 40px; margin-bottom: 20px; color: #333; page-break-after: avoid; }
        .page-break { page-break-before: always; }
        @media print {
            #printBtn { display: none; }
        }
    </style>
</head>
<body>
    <button id="printBtn" onclick="window.print()" style="position: fixed; top: 10px; left: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 100;">طباعة</button>
    <h1>تقرير الجداول الدراسي الشامل</h1>
    <p style="text-align: center; color: #666; margin-bottom: 40px;">تم إنشاؤه بتاريخ: ${new Date().toLocaleString('ar-EG')}</p>
    `;

            // Section 1: Level Schedules
            reportHtml += '<div class="page-break"><h2>جداول الفرق الدراسية</h2></div>';
            levels.forEach(level => {
                if (savedSchedules[level.name]) {
                    reportHtml += generateScheduleHTMLForLevel(level.name);
                }
            });

            // Section 2: Location Schedules
            reportHtml += '<div class="page-break"><h2>جداول الأماكن</h2></div>';
            for (const type in LOCATION_TYPES) {
                reportHtml += generateAggregatedLocationTableHtml(type, `جداول ${LOCATION_TYPES[type]}`);
            }

            // Section 3: Member Schedules
            reportHtml += '<div class="page-break"><h2>جداول الأعضاء</h2></div>';
            reportHtml += generateInstructorSchedulesHtml('', 'all', 'all');

            reportHtml += '</body></html>';

            const blob = new Blob([reportHtml], { type: "text/html;charset=utf-8" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `report_schedules_${new Date().toISOString().slice(0,10)}.html`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function generateScheduleHTMLForLevel(level) {
            if (!level || !savedSchedules[level]) return '';

            let gridForLevel = savedSchedules[level];

            let tableHtml = `<div class="table-container my-8">
                                <h3 class="text-2xl font-bold text-center mb-4 text-gray-700">الجدول الدراسي - ${level}</h3>`;
            tableHtml += '<table class="w-full border-collapse">';
            tableHtml += `<thead><tr class="bg-gray-200"><th class="p-2 border border-gray-300">اليوم</th>${TIME_SLOTS_HOURLY.map(time => `<th class="p-2 border border-gray-300 font-mono text-sm">${formatTimeSlot(time)}</th>`).join('')}</tr></thead><tbody>`;
            
            DAYS.forEach(day => {
                tableHtml += `<tr class="text-center"><td class="p-2 border border-gray-300 font-semibold align-middle bg-gray-50">${day}</td>`;
                let time_cursor = 0;
                while (time_cursor < TIME_SLOTS_HOURLY.length) {
                    const time = TIME_SLOTS_HOURLY[time_cursor];
                    let itemsInCell = locations.map(loc => ({ locName: loc.name, data: gridForLevel[day]?.[time]?.[loc.name] })).filter(item => item.data && !item.data.isContinuation);
                    
                    itemsInCell.sort((a, b) => {
                        if (a.data.type === 'lecture' && b.data.type !== 'lecture') return -1;
                        if (a.data.type !== 'lecture' && b.data.type === 'lecture') return 1;
                        return 0;
                    });
                    
                    if (itemsInCell.length > 0) {
                        const maxDuration = Math.max(...itemsInCell.map(item => item.data.duration || 1));
                        const containerClass = itemsInCell.length > 1 ? 'multi-item-container' : '';
                        tableHtml += `<td class="p-1 border border-gray-300 align-top" colspan="${maxDuration}">`;
                        tableHtml += `<div class="${containerClass} flex flex-col gap-1">`;
                        itemsInCell.forEach(item => { 
                            const { locName, data: cellData } = item; 
                            const sessionClass = cellData.type === 'lab' ? 'session-lab' : '';
                             if (cellData.type === 'custom_activity') {
                                const bgColor = cellData.color || '#e5e7eb';
                                tableHtml += `<div class="schedule-item text-[11px]" style="background-color: ${bgColor};"><p class="font-bold">${cellData.name}</p><p>${cellData.instructor}</p><p class="font-semibold text-gray-600">${locName}</p></div>`;
                            } else {
                                const bgColor = courseColors[cellData.baseName] || '#e5e7eb'; 
                                const borderColor = cellData.type === 'lecture' ? '#f59e0b' : (courseColors[cellData.baseName] ? courseColors[cellData.baseName].replace('85%', '60%') : '#cccccc'); 
                                tableHtml += `<div class="schedule-item text-[11px] ${sessionClass}" style="background-color: ${bgColor}; border-left: 4px solid ${borderColor};"><p class="font-bold">${cellData.name} ${cellData.groupName ? `(${cellData.groupName})` : ''}</p><p>${cellData.instructor}</p><p class="font-semibold text-gray-600">${locName}</p></div>`; 
                            }
                        });
                        tableHtml += `</div></td>`;
                        time_cursor += maxDuration;
                    } else { 
                        const isContinuationSlot = locations.some(loc => gridForLevel[day]?.[time]?.[loc.name]?.isContinuation); 
                        if (!isContinuationSlot) { 
                            tableHtml += `<td class="p-0 border border-gray-300 align-top h-20"></td>`; 
                        } 
                        time_cursor++; 
                    }
                }
                tableHtml += `</tr>`;
            });
            tableHtml += '</tbody></table></div>';
            return tableHtml;
        }

        async function handleLoadScheduleFromFile(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                await showConfirmModal("سيؤدي هذا إلى حذف جميع البيانات الحالية. هل أنت متأكد؟", async () => {
                    try {
                        await handleReset(false);
                        const data = JSON.parse(event.target.result);
                        const batch = writeBatch(db);
                        (data.levels || []).forEach(item => batch.set(doc(levelsCol), item));
                        (data.groups || []).forEach(item => batch.set(doc(groupsCol), item));
                        (data.subjects || []).forEach(item => batch.set(doc(subjectsCol), item));
                        (data.instructors || []).forEach(item => batch.set(doc(instructorsCol), item));
                        (data.locations || []).forEach(item => batch.set(doc(locationsCol), item));
                        (data.courses || []).forEach(item => batch.set(doc(coursesCol), item));
                        if (data.savedSchedules) { for (const level in data.savedSchedules) { batch.set(doc(schedulesCol, level), { grid: JSON.stringify(data.savedSchedules[level]) }); } }
                        await batch.commit();
                        showToast("تم استيراد البيانات بنجاح!");
                    } catch (error) { console.error("Error loading file:", error); showToast("ملف غير صالح.", "error"); }
                });
            };
            reader.readAsText(file); e.target.value = '';
        }
        async function handleReset(confirmed = false) {
            if(!confirmed) {
                const batch = writeBatch(db);
                const collections = [levelsCol, subjectsCol, instructorsCol, locationsCol, coursesCol, schedulesCol, groupsCol];
                for (const col of collections) { const snapshot = await getDocs(query(col)); snapshot.docs.forEach(doc => batch.delete(doc.ref)); }
                await batch.commit();
                return;
            }
            const batch = writeBatch(db);
            const collections = [levelsCol, subjectsCol, instructorsCol, locationsCol, coursesCol, schedulesCol, groupsCol];
            for (const col of collections) { const snapshot = await getDocs(query(col)); snapshot.docs.forEach(doc => batch.delete(doc.ref)); }
            await batch.commit();
            scheduleGrid = {}; savedSchedules = {};
            dom.scheduleOutput.innerHTML = ''; dom.unscheduledOutput.innerHTML = '';
            dom.customScheduleOutput.innerHTML = '';
            showToast("تم حذف جميع البيانات والبدء من جديد.");
        }

        window.handleUpdateMaxConcurrentSections = async (levelId) => {
             const inputElement = document.getElementById(`max-concurrent-${levelId}`);
             if (!inputElement) return;
             const value = inputElement.value;
             const max = value === '' ? null : parseInt(value);
             
             const button = inputElement.nextElementSibling;
             toggleButtonLoading(button, true);

             try {
                const levelRef = doc(db, levelsCol.path, levelId);
                await updateDoc(levelRef, { maxConcurrentSections: max });
                showToast("تم حفظ الحد الأقصى للسكاشن.");
             } catch(error) {
                console.error("Error updating max concurrent sections:", error);
                showToast("حدث خطأ أثناء الحفظ.", "error");
             } finally {
                toggleButtonLoading(button, false);
             }
        };

        function generateAdvancedLevelsHTML() {
            const canEdit = userRole === 'admin';
            const buttonsHtml = (l) => canEdit ? `<div class="w-full sm:w-auto flex flex-col sm:flex-row items-stretch sm:items-center gap-2"> <div class="flex-grow"> <label for="max-concurrent-${l.id}" class="text-xs font-bold text-gray-500">أقصى عدد سكاشن متزامنة</label> <div class="flex items-center gap-2 mt-1"> <input type="number" id="max-concurrent-${l.id}" min="1" placeholder="غير محدد" value="${l.maxConcurrentSections || ''}" class="w-24 p-2 border rounded-md"> <button onclick="window.handleUpdateMaxConcurrentSections('${l.id}')" class="bg-green-500 text-white font-bold p-2 px-3 rounded-md hover:bg-green-600 flex items-center justify-center"><i class="fas fa-save"></i></button> </div> </div> <div class="flex items-center gap-2 border-t sm:border-t-0 sm:border-r pt-2 sm:pt-0 sm:pr-4 mt-2 sm:mt-0"> <button onclick="window.openEditModal('level', '${l.id}')" title="تعديل اسم الفرقة" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pencil-alt fa-lg"></i></button> <button onclick="window.deleteItem('level', '${l.id}')" title="حذف الفرقة" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash fa-lg"></i></button> </div> </div>` : '';

            return ` <div class="bg-white p-6 rounded-xl shadow-lg"> <div class="flex justify-between items-center mb-6 border-b pb-4"> <h2 class="text-2xl font-bold text-gray-700">الإدارة المتقدمة للفرق الدراسية</h2> <button onclick="window.showMainView()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"> <i class="fas fa-arrow-left ml-2"></i>العودة للرئيسية </button> </div> <input type="text" id="adv-level-search" placeholder="ابحث عن فرقة..." class="w-full p-3 border rounded-md mb-6"> <div id="adv-levels-list" class="space-y-4"> ${levels.map(l => ` <div class="list-item flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 rounded-lg shadow-sm gap-4" data-id="${l.id}"> <p class="font-semibold text-md">${l.name}</p> ${buttonsHtml(l)} </div> `).join('')} </div> </div> `;
        }
        function renderAdvancedInstructorsView(searchQuery = '', filterCategory = 'all') {
            dom.advancedInstructorsView.innerHTML = generateAdvancedInstructorsHTML(searchQuery, filterCategory);
            if(userRole === 'admin') {
                document.getElementById('adv-instructor-search').addEventListener('input', (e) => { const currentCategory = document.querySelector('input[name="adv-category"]:checked').value; renderAdvancedInstructorsView(e.target.value, currentCategory); });
                document.querySelectorAll('input[name="adv-category"]').forEach(radio => { radio.addEventListener('change', (e) => { const currentSearch = document.getElementById('adv-instructor-search').value; renderAdvancedInstructorsView(currentSearch, e.target.value); }); });
                document.getElementById('adv-instructor-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const nameInput = document.getElementById('adv-instructor-name-input');
                    const name = nameInput.value.trim();
                    if (name && !instructors.some(i => i.name === name)) {
                        await handleAddWithLoading(e, instructorsCol, { name, category: document.getElementById('adv-instructor-category-select').value, availableTimes: {}, customActivities: {} }, "تمت إضافة العضو بنجاح!");
                    } else { showToast("الاسم موجود بالفعل أو غير صالح.", "error"); }
                });
            }
        }
        window.handleUpdateInstructorCategory = async (instructorId) => {
            if (userRole === 'guest') return;
            const selectElement = document.getElementById(`category-select-${instructorId}`);
            if (!selectElement) return;
            const newCategory = selectElement.value;
            const button = selectElement.nextElementSibling;
            toggleButtonLoading(button, true);
            try {
                const instructorRef = doc(db, instructorsCol.path, instructorId);
                await updateDoc(instructorRef, { category: newCategory });
                showToast("تم تحديث فئة العضو بنجاح!");
            } catch (error) {
                console.error("Error updating category:", error);
                showToast("حدث خطأ أثناء التحديث.", "error");
            } finally {
                toggleButtonLoading(button, false);
            }
        };
        function getInstructorLoad(instructorName) {
            const assignedCourses = []; const countedCourses = new Set(); let totalHours = 0;
            for (const course of courses) {
                if (course.instructor === instructorName) {
                    const subject = subjects.find(s => s.name === course.baseName);
                    if (subject) {
                        const uniqueCourseId = course.id;
                        if (!countedCourses.has(uniqueCourseId)) {
                             assignedCourses.push({ name: course.name, level: subject.academicLevel, hours: course.duration });
                            totalHours += course.duration;
                            countedCourses.add(uniqueCourseId);
                        }
                    }
                }
            }
            return { courses: assignedCourses, totalHours };
        }
        function generateAdvancedInstructorsHTML(searchQuery = '', filterCategory = 'all') {
            let filteredInstructors = instructors; if (searchQuery && typeof searchQuery === 'string') { filteredInstructors = filteredInstructors.filter(inst => inst.name.toLowerCase().includes(searchQuery.trim().toLowerCase())); } if (filterCategory !== 'all') { filteredInstructors = filteredInstructors.filter(inst => inst.category === filterCategory); }
            const canEdit = userRole === 'admin';
            const addInstructorForm = canEdit ? `<div class="md:col-span-2"> <form id="adv-instructor-form" class="p-4 border rounded-lg bg-gray-50 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end"> <div class="sm:col-span-2 grid grid-cols-2 gap-4"> <div> <label class="font-bold text-sm">اسم العضو الجديد</label> <input type="text" id="adv-instructor-name-input" placeholder="اسم العضو" class="w-full p-2 border rounded-md mt-1" required> </div> <div> <label class="font-bold text-sm">الفئة</label> <select id="adv-instructor-category-select" class="w-full p-2 border rounded-md mt-1"> ${INSTRUCTOR_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')} </select> </div> </div> <button type="submit" class="w-full bg-sky-500 text-white font-bold py-2 rounded-md hover:bg-sky-600 h-10 flex items-center justify-center">إضافة عضو</button> </form> </div>` : '<div class="md:col-span-2"></div>';

            return ` <div class="bg-white p-6 rounded-xl shadow-lg"> <div class="flex justify-between items-center mb-6 border-b pb-4"> <h2 class="text-2xl font-bold text-gray-700">الإدارة المتقدمة للأعضاء</h2> <button onclick="window.showMainView()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300"> <i class="fas fa-arrow-left ml-2"></i>العودة للرئيسية </button> </div> <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"> ${addInstructorForm} <div class="p-4 border rounded-lg bg-gray-50"> <label class="font-bold text-sm">ابحث بالاسم...</label> <input type="text" id="adv-instructor-search" placeholder="بحث..." class="w-full p-2 border rounded-md mt-1" value="${searchQuery}"> </div> </div> <div class="mb-6 flex flex-wrap gap-4 justify-center"> <label class="flex items-center"><input type="radio" name="adv-category" value="all" class="ml-2" ${filterCategory === 'all' ? 'checked' : ''}> الكل</label> ${INSTRUCTOR_CATEGORIES.map(cat => `<label class="flex items-center"><input type="radio" name="adv-category" value="${cat}" class="ml-2" ${filterCategory === cat ? 'checked' : ''}> ${cat}</label>`).join('')} </div> <div id="adv-instructors-list" class="space-y-4"> ${filteredInstructors.length ? filteredInstructors.map(instructor => { const load = getInstructorLoad(instructor.name); const buttonsHtml = canEdit ? `<div class="flex items-center gap-2 mt-2"> <select id="category-select-${instructor.id}" class="p-1 border rounded-md text-sm bg-white">${INSTRUCTOR_CATEGORIES.map(cat => `<option value="${cat}" ${instructor.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}</select> <button onclick="window.handleUpdateInstructorCategory('${instructor.id}')" class="bg-green-500 text-white font-bold py-1 px-3 rounded-md hover:bg-green-600 text-sm flex items-center justify-center">حفظ</button> </div>` : `<p class="text-sm text-gray-600 mt-2">${instructor.category}</p>`; const editDeleteButtons = canEdit ? `<div class="flex items-center gap-2"> <button onclick="window.openEditModal('instructor', '${instructor.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-pencil-alt fa-lg"></i></button> <button onclick="window.deleteItem('instructor', '${instructor.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash fa-lg"></i></button> </div>` : ''; return ` <div class="border rounded-lg overflow-hidden shadow-sm"> <div class="p-4 bg-gray-50 flex justify-between items-start"> <div> <h4 class="font-bold text-lg">${instructor.name}</h4> ${buttonsHtml} </div> ${editDeleteButtons} </div> <div class="p-4"> <h5 class="font-bold text-md mb-2 text-gray-700">المقررات المسندة:</h5> ${load.courses.length ? ` <table class="w-full text-sm text-right"> <thead class="bg-gray-100 text-gray-600"> <tr> <th class="p-2">اسم المقرر</th> <th class="p-2">الفرقة</th> </tr> </thead> <tbody> ${load.courses.map(c => ` <tr class="border-b"> <td class="p-2 font-semibold">${c.name}</td> <td class="p-2">${c.level}</td> </tr> `).join('')} </tbody> <tfoot> <tr class="font-bold bg-gray-50 border-t"> <td class="p-2">الإجمالي</td> <td class="p-2">${load.totalHours} ساعة</td> </tr> </tfoot> </table> ` : '<p class="text-center text-gray-500">لم يتم إسناد أي مقررات لهذا العضو بعد.</p>'} </div> </div> `; }).join('') : '<p class="text-center text-gray-500 mt-8">لا يوجد أعضاء مطابقون لمعايير البحث.</p>'} </div> </div> `;
        }
        function formatTimeSlot(startHour, duration = 1) { const endHour = startHour + duration; const format12 = (hour) => { const ampm = hour >= 12 && hour < 24 ? 'م' : 'ص'; const h = hour % 12 || 12; return `${h} ${ampm}`; }; if (duration === 1) { return `${format12(startHour)} - ${format12(endHour)}`; } return `${format12(startHour)} - ${format12(endHour)}`; }
        function generateHslColor(str, asHex = false) {
            let hash = 0; if (!str) return asHex ? '#e5e7eb' : 'hsl(0, 0%, 90%)';
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            const h = hash % 360; const s = 75; const l = 85;
            if (asHex) { let s_norm = s / 100; let l_norm = l / 100; let c = (1 - Math.abs(2 * l_norm - 1)) * s_norm, x = c * (1 - Math.abs((h / 60) % 2 - 1)), m = l_norm - c/2, r = 0, g = 0, b = 0; if (0 <= h && h < 60) { r = c; g = x; b = 0; } else if (60 <= h && h < 120) { r = x; g = c; b = 0; } else if (120 <= h && h < 180) { r = 0; g = c; b = x; } else if (180 <= h && h < 240) { r = 0; g = x; b = c; } else if (240 <= h && h < 300) { r = x; g = 0; b = c; } else if (300 <= h && h < 360) { r = c; g = 0; b = x; } r = Math.round((r + m) * 255).toString(16); g = Math.round((g + m) * 255).toString(16); b = Math.round((b + m) * 255).toString(16); if (r.length == 1) r = "0" + r; if (g.length == 1) g = "0" + g; if (b.length == 1) b = "0" + b; return `#${r}${g}${b}`; }
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        window.copyTableToClipboard = (button) => {
            const tableContainer = button.closest('.table-container');
            const table = tableContainer.querySelector('table');
            if (!table) return;

            let tableText = '';
            const rows = table.rows;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                let rowText = '';
                for (let j = 0; j < row.cells.length; j++) {
                    const cell = row.cells[j];
                    let cellContent = cell.innerText.replace(/\s\s+/g, ' ').trim();
                    rowText += cellContent + '\t'.repeat(cell.colSpan);
                }
                tableText += rowText.trim() + '\n';
            }

            const textArea = document.createElement('textarea');
            textArea.value = tableText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('تم نسخ الجدول بنجاح!');
            } catch (err) {
                showToast('فشل نسخ الجدول.', 'error');
            }
            document.body.removeChild(textArea);
        }

        window.openLevelActivityModal = (day, time, locationNameForEdit = null, activityId = null) => {
            if (userRole === 'guest') return;
            const level = dom.levelFilterSelect.value;
            if (!level || level === 'all') {
                showToast('يرجى تحديد فرقة أولاً.', 'error');
                return;
            }
            const modal = dom.levelActivityModal;
            const grid = savedSchedules[level] || {};
            const isEditMode = activityId !== null;

            let activityData = null;
            if (isEditMode) {
                activityData = grid[day]?.[time]?.[locationNameForEdit];
                if (!activityData || activityData.id !== activityId) {
                    console.error("Activity not found for editing");
                    showToast('خطأ: لم يتم العثور على النشاط.', 'error');
                    return;
                }
                modal.title.textContent = `تعديل نشاط: ${activityData.name}`;
            } else {
                modal.title.textContent = `إضافة نشاط لـ: ${day} الساعة ${formatTimeSlot(time)}`;
            }

            modal.instructorSelect.innerHTML = '<option value="">(بدون عضو)</option>' + instructors.map(i => `<option value="${i.name}" ${isEditMode && i.name === activityData.instructor ? 'selected' : ''}>${i.name}</option>`).join('');

            const duration = isEditMode ? activityData.duration : (parseInt(modal.durationInput.value) || 1);
            const availableLocations = locations.filter(loc => {
                if (isEditMode && loc.name === locationNameForEdit) return true;
                for (let i = 0; i < duration; i++) {
                    if (grid[day]?.[time + i]?.[loc.name]) return false;
                }
                return true;
            });

            if (availableLocations.length === 0 && !isEditMode) {
                showToast('لا توجد أماكن فارغة في هذا التوقيت.', 'error');
                return;
            }
            modal.locationSelect.innerHTML = '<option value="">(بدون مكان)</option>' + availableLocations.map(l => `<option value="${l.name}" ${isEditMode && l.name === locationNameForEdit ? 'selected' : ''}>${l.name} (${l.type})</option>`).join('');
            
            modal.nameInput.value = isEditMode ? activityData.name : '';
            modal.durationInput.value = isEditMode ? activityData.duration : '1';
            modal.durationInput.disabled = isEditMode;
            modal.colorInput.value = isEditMode ? (activityData.color || '#a7f3d0') : '#a7f3d0';

            modal.modal.style.display = 'block';

            const deleteBtnId = 'level-activity-modal-delete-btn';
            let deleteBtn = document.getElementById(deleteBtnId);
            if (!deleteBtn) {
                deleteBtn = document.createElement('button');
                deleteBtn.id = deleteBtnId;
                deleteBtn.className = 'w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600 mt-2';
                modal.saveBtn.insertAdjacentElement('afterend', deleteBtn);
            }
            
            if (isEditMode) {
                deleteBtn.textContent = 'حذف النشاط';
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = () => handleDeleteLevelActivity(day, time, locationNameForEdit, activityId, level);
            } else {
                deleteBtn.style.display = 'none';
            }

            modal.saveBtn.onclick = () => handleSaveLevelActivity(day, time, level, isEditMode ? { id: activityId, location: locationNameForEdit } : null);
        };

        async function handleSaveLevelActivity(day, time, level, editContext = null) {
            const modal = dom.levelActivityModal;
            const activityName = modal.nameInput.value.trim();
            const instructorName = modal.instructorSelect.value;
            const locationName = modal.locationSelect.value;
            const color = modal.colorInput.value;
            
            const isEditMode = editContext !== null;
            let grid = savedSchedules[level] ? JSON.parse(JSON.stringify(savedSchedules[level])) : {};
            
            let duration = 1;
            if (isEditMode) {
                const oldActivity = grid[day]?.[time]?.[editContext.location];
                if(oldActivity) duration = oldActivity.duration;
            } else {
                duration = parseInt(modal.durationInput.value);
            }

            if (!activityName || !locationName || !duration) {
                showToast('يرجى ملء اسم النشاط والمكان والمدة.', 'error'); return;
            }

            if (isEditMode) {
                for (let i = 0; i < duration; i++) {
                    if(grid[day]?.[time+i]?.[editContext.location]) {
                        delete grid[day][time + i][editContext.location];
                    }
                }
            }

            for (let i = 0; i < duration; i++) {
                if (grid[day]?.[time + i]?.[locationName]) {
                    showToast('حدث تضارب. المكان تم حجزه أثناء إدخالك للبيانات.', 'error'); return;
                }
            }

            const activityData = {
                id: isEditMode ? editContext.id : `activity_${Date.now()}`,
                type: 'custom_activity',
                name: activityName,
                instructor: instructorName || 'غير محدد',
                duration: duration,
                baseName: activityName, 
                color: color,
            };

            for (let i = 0; i < duration; i++) {
                if (!grid[day]) grid[day] = {};
                if (!grid[day][time + i]) grid[day][time + i] = {};
                grid[day][time + i][locationName] = { ...activityData, isContinuation: i > 0 };
            }
            
            await saveScheduleToFirebase(level, grid);
            modal.modal.style.display = 'none';
            showToast(isEditMode ? 'تم تعديل النشاط بنجاح!' : 'تم إضافة النشاط بنجاح!');
        }

        async function handleDeleteLevelActivity(day, time, locationName, activityId, level) {
            await showConfirmModal("هل أنت متأكد من حذف هذا النشاط من الجدول؟", async () => {
                let grid = JSON.parse(JSON.stringify(savedSchedules[level]));
                const activity = grid[day]?.[time]?.[locationName];
                if (activity && activity.id === activityId) {
                    const duration = activity.duration;
                    for (let i = 0; i < duration; i++) {
                        if (grid[day]?.[parseInt(time) + i]?.[locationName]) {
                            delete grid[day][parseInt(time) + i][locationName];
                        }
                    }
                    await saveScheduleToFirebase(level, grid);
                    showToast("تم حذف النشاط.");
                    dom.levelActivityModal.modal.style.display = 'none';
                } else {
                    showToast("خطأ: لم يتم العثور على النشاط للحذف.", "error");
                }
            });
        }

        window.openLocationActivityModal = (locationName, day, time) => {
            if (userRole === 'guest') return;

            const modal = dom.locationActivityModal;
            modal.title.textContent = `إضافة نشاط في: ${locationName} - ${day} الساعة ${formatTimeSlot(time)}`;
            
            modal.levelSelect.innerHTML = '<option value="">(نشاط عام - غير مرتبط بفرقة)</option>' + levels.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
            modal.instructorSelect.innerHTML = '<option value="">(بدون عضو)</option>' + instructors.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
            
            modal.nameInput.value = '';
            modal.durationInput.value = '1';
            modal.colorInput.value = '#a7f3d0';

            modal.modal.style.display = 'block';

            modal.saveBtn.onclick = () => handleSaveLocationActivity(locationName, day, time);
        };

        async function handleSaveLocationActivity(locationName, day, time) {
            const modal = dom.locationActivityModal;
            const level = modal.levelSelect.value;
            const activityName = modal.nameInput.value.trim();
            const instructorName = modal.instructorSelect.value;
            const duration = parseInt(modal.durationInput.value);
            const color = modal.colorInput.value;

            if (!activityName || !duration) {
                showToast('يرجى ملء اسم النشاط والمدة.', 'error');
                return;
            }

            // Comprehensive conflict check
            // 1. Check against all level schedules (including general_activities)
            for (const levelName in savedSchedules) {
                const grid = savedSchedules[levelName];
                for (let i = 0; i < duration; i++) {
                    if (grid[day]?.[time + i]?.[locationName]) {
                        showToast(`المكان مشغول بنشاط آخر في جدول ${levelName === 'general_activities' ? 'الأنشطة العامة' : `فرقة ${levelName}`}`, 'error');
                        return;
                    }
                }
            }
            // 2. Check against all instructor custom activities
            for (const instructor of instructors) {
                for (const activityId in instructor.customActivities || {}) {
                    const activity = instructor.customActivities[activityId];
                    if (activity.location === locationName && activity.day === day && (time < activity.time + activity.duration && activity.time < time + duration)) {
                        showToast(`المكان مشغول بنشاط للعضو: ${instructor.name}`, 'error');
                        return;
                    }
                }
            }

            const activityData = {
                id: `activity_${Date.now()}`,
                type: 'custom_activity',
                name: activityName,
                instructor: instructorName || 'غير محدد',
                duration: duration,
                baseName: activityName,
                color: color,
            };

            if (level) {
                let grid = savedSchedules[level] ? JSON.parse(JSON.stringify(savedSchedules[level])) : {};
                for (let i = 0; i < duration; i++) {
                    if (!grid[day]) grid[day] = {};
                    if (!grid[day][time + i]) grid[day][time + i] = {};
                    grid[day][time + i][locationName] = { ...activityData, isContinuation: i > 0 };
                }
                await saveScheduleToFirebase(level, grid);
                modal.modal.style.display = 'none';
                showToast('تم إضافة النشاط للفرقة بنجاح!');
            } else if (instructorName) {
                const instructor = instructors.find(i => i.name === instructorName);
                if (!instructor) {
                    showToast('لم يتم العثور على العضو المحدد.', 'error');
                    return;
                }
                const instructorRef = doc(db, instructorsCol.path, instructor.id);
                const newActivityId = `act_${Date.now()}`;
                const key = `customActivities.${newActivityId}`;
                const customActivityData = {
                    text: activityName,
                    duration,
                    location: locationName,
                    day,
                    time
                };
                await updateDoc(instructorRef, { [key]: customActivityData });
                modal.modal.style.display = 'none';
                showToast("تم حفظ النشاط كنشاط شخصي للعضو.");
            } else { // No level, no instructor -> Truly general activity
                let grid = savedSchedules['general_activities'] ? JSON.parse(JSON.stringify(savedSchedules['general_activities'])) : {};
                for (let i = 0; i < duration; i++) {
                    if (!grid[day]) grid[day] = {};
                    if (!grid[day][time + i]) grid[day][time + i] = {};
                    grid[day][time + i][locationName] = { ...activityData, isContinuation: i > 0 };
                }
                await saveScheduleToFirebase('general_activities', grid);
                modal.modal.style.display = 'none';
                showToast('تم إضافة النشاط العام بنجاح!');
            }
        }
    </script>
</body>
</html>
